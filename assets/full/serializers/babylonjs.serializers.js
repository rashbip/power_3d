!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("babylonjs")):"function"==typeof define&&define.amd?define("babylonjs-serializers",["babylonjs"],t):"object"==typeof exports?exports["babylonjs-serializers"]=t(require("babylonjs")):e.SERIALIZERS=t(e.BABYLON)}("undefined"!=typeof self?self:"undefined"!=typeof global?global:this,(e=>(()=>{"use strict";var t={597(t){t.exports=e}},n={};function r(e){var o=n[e];if(void 0!==o)return o.exports;var i=n[e]={exports:{}};return t[e](i,i.exports,r),i.exports}r.d=(e,t)=>{for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},r.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var o={};r.d(o,{default:()=>Ar});var i={};r.r(i),r.d(i,{OBJExport:()=>x});var a={};r.r(a),r.d(a,{__IGLTFExporterExtension:()=>_});var s={};r.r(s),r.d(s,{GLTFData:()=>v});var u={};r.r(u),r.d(u,{GLTF2Export:()=>pe});var c={};r.r(c),r.d(c,{EXT_lights_area:()=>Ce,EXT_mesh_gpu_instancing:()=>me,EXT_texture_avif:()=>At,EXT_texture_webp:()=>Mt,KHR_draco_mesh_compression:()=>xe,KHR_lights_punctual:()=>be,KHR_materials_anisotropy:()=>Se,KHR_materials_clearcoat:()=>Oe,KHR_materials_coat:()=>Le,KHR_materials_diffuse_roughness:()=>mt,KHR_materials_diffuse_transmission:()=>We,KHR_materials_dispersion:()=>Ge,KHR_materials_emissive_strength:()=>He,KHR_materials_fuzz:()=>rt,KHR_materials_ior:()=>Qe,KHR_materials_iridescence:()=>Ye,KHR_materials_openpbr:()=>xt,KHR_materials_sheen:()=>$e,KHR_materials_specular:()=>it,KHR_materials_transmission:()=>st,KHR_materials_unlit:()=>ct,KHR_materials_volume:()=>ht,KHR_materials_volume_scatter:()=>ft,KHR_texture_basisu:()=>yt,KHR_texture_transform:()=>vt});var l={};r.r(l),r.d(l,{EXT_lights_area:()=>Ce,EXT_mesh_gpu_instancing:()=>me,EXT_texture_avif:()=>At,EXT_texture_webp:()=>Mt,GLTF2Export:()=>pe,GLTFData:()=>v,KHR_draco_mesh_compression:()=>xe,KHR_lights_punctual:()=>be,KHR_materials_anisotropy:()=>Se,KHR_materials_clearcoat:()=>Oe,KHR_materials_coat:()=>Le,KHR_materials_diffuse_roughness:()=>mt,KHR_materials_diffuse_transmission:()=>We,KHR_materials_dispersion:()=>Ge,KHR_materials_emissive_strength:()=>He,KHR_materials_fuzz:()=>rt,KHR_materials_ior:()=>Qe,KHR_materials_iridescence:()=>Ye,KHR_materials_openpbr:()=>xt,KHR_materials_sheen:()=>$e,KHR_materials_specular:()=>it,KHR_materials_transmission:()=>st,KHR_materials_unlit:()=>ct,KHR_materials_volume:()=>ht,KHR_materials_volume_scatter:()=>ft,KHR_texture_basisu:()=>yt,KHR_texture_transform:()=>vt,_ConvertToGLTFPBRMetallicRoughness:()=>N,_SolveMetallic:()=>O});var h={};r.r(h),r.d(h,{STLExport:()=>Rt});var p={};r.r(p),r.d(p,{USDZExportAsync:()=>Lt});var f={};r.r(f),r.d(f,{BVHExporter:()=>zt});var d={};r.r(d),r.d(d,{AbstractThreeMfSerializer:()=>ir,BjsThreeMfSerializer:()=>cr,ContentTypeFileName:()=>En,DefaultXmlSerializerFormatOptions:()=>nn,DefaultXmlSerializerNumberOptions:()=>tn,GetXmlFieldMeta:()=>Zt,GetXmlName:()=>Yt,IsQualifiedName:()=>Kt,Known3mfRelationshipTypes:()=>In,KnownI3mfContentType:()=>yn,Matrix3d:()=>Nn,MatrixFormatter:()=>Pn,ModelFileName:()=>Rn,NumberFormatter:()=>an,Object3dDirName:()=>An,OpenXmlContentTypesNamespace:()=>bn,OpenXmlRelationshipsNamespace:()=>Mn,RelationshipDirName:()=>wn,RelationshipFileName:()=>Cn,ResolveFormatOptions:()=>on,ResolveNumberOptions:()=>rn,ST_ObjectType:()=>mn,ST_Unit:()=>dn,StringXmlWriter:()=>xn,ThreeDimModelNamespace:()=>vn,ThreeMf:()=>ar,ThreeMfBase:()=>Zn,ThreeMfBaseMaterials:()=>Qn,ThreeMfBuild:()=>Yn,ThreeMfComponent:()=>Xn,ThreeMfComponents:()=>Hn,ThreeMfComponentsBuilder:()=>er,ThreeMfContentType:()=>Vn,ThreeMfContentTypes:()=>Sn,ThreeMfDocument:()=>On,ThreeMfDocumentBuilder:()=>or,ThreeMfItem:()=>Jn,ThreeMfMaterialBuilder:()=>nr,ThreeMfMesh:()=>Kn,ThreeMfMeshBuilder:()=>tr,ThreeMfMeta:()=>kn,ThreeMfMetadataGroup:()=>Dn,ThreeMfModel:()=>Un,ThreeMfModelBuilder:()=>rr,ThreeMfObject:()=>zn,ThreeMfObjectBuilder:()=>$n,ThreeMfRelationship:()=>Bn,ThreeMfRelationships:()=>Fn,ThreeMfResources:()=>Ln,ThreeMfSerializerGlobalConfiguration:()=>sr,ThreeMfTriangle:()=>jn,ThreeMfTriangles:()=>Gn,ThreeMfVertex:()=>qn,ThreeMfVertices:()=>Wn,ToQualifiedString:()=>en,TokenType:()=>hn,TriangleSetsNamespace:()=>Tn,Utf8XmlWriterToBytes:()=>_n,XmlAttr:()=>Xt,XmlBuilder:()=>gn,XmlElem:()=>Qt,XmlIgnore:()=>Ht,XmlName:()=>jt,XmlNameToParts:()=>$t,XmlSerializer:()=>pn});var m={};r.r(m),r.d(m,{AbstractThreeMfSerializer:()=>ir,BVHExporter:()=>zt,BjsThreeMfSerializer:()=>cr,ContentTypeFileName:()=>En,DefaultXmlSerializerFormatOptions:()=>nn,DefaultXmlSerializerNumberOptions:()=>tn,EXT_lights_area:()=>Ce,EXT_mesh_gpu_instancing:()=>me,EXT_texture_avif:()=>At,EXT_texture_webp:()=>Mt,GLTF2Export:()=>pe,GLTFData:()=>v,GetXmlFieldMeta:()=>Zt,GetXmlName:()=>Yt,IsQualifiedName:()=>Kt,KHR_draco_mesh_compression:()=>xe,KHR_lights_punctual:()=>be,KHR_materials_anisotropy:()=>Se,KHR_materials_clearcoat:()=>Oe,KHR_materials_coat:()=>Le,KHR_materials_diffuse_roughness:()=>mt,KHR_materials_diffuse_transmission:()=>We,KHR_materials_dispersion:()=>Ge,KHR_materials_emissive_strength:()=>He,KHR_materials_fuzz:()=>rt,KHR_materials_ior:()=>Qe,KHR_materials_iridescence:()=>Ye,KHR_materials_openpbr:()=>xt,KHR_materials_sheen:()=>$e,KHR_materials_specular:()=>it,KHR_materials_transmission:()=>st,KHR_materials_unlit:()=>ct,KHR_materials_volume:()=>ht,KHR_materials_volume_scatter:()=>ft,KHR_texture_basisu:()=>yt,KHR_texture_transform:()=>vt,Known3mfRelationshipTypes:()=>In,KnownI3mfContentType:()=>yn,Matrix3d:()=>Nn,MatrixFormatter:()=>Pn,ModelFileName:()=>Rn,NumberFormatter:()=>an,OBJExport:()=>x,Object3dDirName:()=>An,OpenXmlContentTypesNamespace:()=>bn,OpenXmlRelationshipsNamespace:()=>Mn,RelationshipDirName:()=>wn,RelationshipFileName:()=>Cn,ResolveFormatOptions:()=>on,ResolveNumberOptions:()=>rn,STLExport:()=>Rt,ST_ObjectType:()=>mn,ST_Unit:()=>dn,StringXmlWriter:()=>xn,ThreeDimModelNamespace:()=>vn,ThreeMf:()=>ar,ThreeMfBase:()=>Zn,ThreeMfBaseMaterials:()=>Qn,ThreeMfBuild:()=>Yn,ThreeMfComponent:()=>Xn,ThreeMfComponents:()=>Hn,ThreeMfComponentsBuilder:()=>er,ThreeMfContentType:()=>Vn,ThreeMfContentTypes:()=>Sn,ThreeMfDocument:()=>On,ThreeMfDocumentBuilder:()=>or,ThreeMfItem:()=>Jn,ThreeMfMaterialBuilder:()=>nr,ThreeMfMesh:()=>Kn,ThreeMfMeshBuilder:()=>tr,ThreeMfMeta:()=>kn,ThreeMfMetadataGroup:()=>Dn,ThreeMfModel:()=>Un,ThreeMfModelBuilder:()=>rr,ThreeMfObject:()=>zn,ThreeMfObjectBuilder:()=>$n,ThreeMfRelationship:()=>Bn,ThreeMfRelationships:()=>Fn,ThreeMfResources:()=>Ln,ThreeMfSerializerGlobalConfiguration:()=>sr,ThreeMfTriangle:()=>jn,ThreeMfTriangles:()=>Gn,ThreeMfVertex:()=>qn,ThreeMfVertices:()=>Wn,ToQualifiedString:()=>en,TokenType:()=>hn,TriangleSetsNamespace:()=>Tn,USDZExportAsync:()=>Lt,Utf8XmlWriterToBytes:()=>_n,XmlAttr:()=>Xt,XmlBuilder:()=>gn,XmlElem:()=>Qt,XmlIgnore:()=>Ht,XmlName:()=>jt,XmlNameToParts:()=>$t,XmlSerializer:()=>pn,_ConvertToGLTFPBRMetallicRoughness:()=>N,_SolveMetallic:()=>O,__IGLTFExporterExtension:()=>_});var g=r(597),x=function(){function e(){}return e.OBJ=function(e,t,n,r){var o=[],i=1,a=1;t&&(n||(n="mat"),o.push("mtllib "+n+".mtl"));for(var s=0;s<e.length;s++){var u=e[s],c=u.name||"mesh".concat(s,"}");o.push("o ".concat(c));var l=null;if(r){var h=u.computeWorldMatrix(!0);l=new g.Matrix,h.invertToRef(l),u.bakeTransformIntoVertices(h)}if(t){var p=u.material;p&&o.push("usemtl "+p.id)}var f=u.geometry;if(f){var d=f.getVerticesData("position"),m=f.getVerticesData("normal"),x=f.getVerticesData("uv"),_=f.getIndices(),v=0,T=0;if(d&&_){for(var y=e[0].getScene().useRightHandedSystem?1:-1,b=0;b<d.length;b+=3)o.push("v "+d[b]*y+" "+d[b+1]+" "+d[b+2]),v++;if(null!=m)for(b=0;b<m.length;b+=3)o.push("vn "+m[b]*y+" "+m[b+1]+" "+m[b+2]);if(null!=x)for(b=0;b<x.length;b+=2)o.push("vt "+x[b]+" "+x[b+1]),T++;var M=["","",""],w=(u.material||u.getScene().defaultMaterial)._getEffectiveOrientation(u)===g.Material.ClockWiseSideOrientation?[2,1]:[1,2],A=w[0],R=w[1];for(b=0;b<_.length;b+=3){var C=[String(_[b]+i),String(_[b+A]+i),String(_[b+R]+i)],E=[String(_[b]+a),String(_[b+A]+a),String(_[b+R]+a)],I=C,S=null!=x?E:M,V=null!=m?C:M;o.push("f "+I[0]+"/"+S[0]+"/"+V[0]+" "+I[1]+"/"+S[1]+"/"+V[1]+" "+I[2]+"/"+S[2]+"/"+V[2])}r&&l&&u.bakeTransformIntoVertices(l),i+=v,a+=T}else g.Tools.Warn("There are no position vertices or indices on the mesh!")}else g.Tools.Warn("No geometry is present on the mesh")}return o.join("\n")},e.MTL=function(e){var t=[],n=e.material;return t.push("newmtl mat1"),t.push("  Ns "+n.specularPower.toFixed(4)),t.push("  Ni 1.5000"),t.push("  d "+n.alpha.toFixed(4)),t.push("  Tr 0.0000"),t.push("  Tf 1.0000 1.0000 1.0000"),t.push("  illum 2"),t.push("  Ka "+n.ambientColor.r.toFixed(4)+" "+n.ambientColor.g.toFixed(4)+" "+n.ambientColor.b.toFixed(4)),t.push("  Kd "+n.diffuseColor.r.toFixed(4)+" "+n.diffuseColor.g.toFixed(4)+" "+n.diffuseColor.b.toFixed(4)),t.push("  Ks "+n.specularColor.r.toFixed(4)+" "+n.specularColor.g.toFixed(4)+" "+n.specularColor.b.toFixed(4)),t.push("  Ke "+n.emissiveColor.r.toFixed(4)+" "+n.emissiveColor.g.toFixed(4)+" "+n.emissiveColor.b.toFixed(4)),n.ambientTexture&&t.push("  map_Ka "+n.ambientTexture.name),n.diffuseTexture&&t.push("  map_Kd "+n.diffuseTexture.name),n.specularTexture&&t.push("  map_Ks "+n.specularTexture.name),n.bumpTexture&&t.push("  map_bump -imfchan z "+n.bumpTexture.name),n.opacityTexture&&t.push("  map_d "+n.opacityTexture.name),t.join("\n")},e}(),_=0,v=function(){function e(){this.files={}}return Object.defineProperty(e.prototype,"glTFFiles",{get:function(){return this.files},enumerable:!1,configurable:!0}),e.prototype.downloadFiles=function(){for(var e in this.files){var t=this.files[e],n=new Blob([t],{type:(0,g.GetMimeType)(e)});g.Tools.Download(n,e)}},e}(),T=function(e,t){return T=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},T(e,t)};function y(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}T(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}var b=function(){return b=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},b.apply(this,arguments)};function M(e,t,n,r){var o,i=arguments.length,a=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,r);else for(var s=e.length-1;s>=0;s--)(o=e[s])&&(a=(i<3?o(a):i>3?o(t,n,a):o(t,n))||a);return i>3&&a&&Object.defineProperty(t,n,a),a}function w(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{u(r.next(e))}catch(e){i(e)}}function s(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((r=r.apply(e,t||[])).next())}))}function A(e,t){var n,r,o,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]},a=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return a.next=s(0),a.throw=s(1),a.return=s(2),"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(s){return function(u){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;a&&(a=0,s[0]&&(i=0)),i;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return i.label++,{value:s[1],done:!1};case 5:i.label++,r=s[1],s=[0];continue;case 7:s=i.ops.pop(),i.trys.pop();continue;default:if(!((o=(o=i.trys).length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){i=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){i.label=s[1];break}if(6===s[0]&&i.label<o[1]){i.label=o[1],o=s;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(s);break}o[2]&&i.ops.pop(),i.trys.pop();continue}s=t.call(e,i)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,u])}}}function R(e,t,n){if(n||2===arguments.length)for(var r,o=0,i=t.length;o<i;o++)!r&&o in t||(r||(r=Array.prototype.slice.call(t,0,o)),r[o]=t[o]);return e.concat(r||Array.prototype.slice.call(t))}Object.create,Object.create,"function"==typeof SuppressedError&&SuppressedError;var C=1e-6,E=new g.Color3(.04,.04,.04),I=1024,S=g.Color3.White(),V=g.Color3.BlackReadOnly;function F(e){switch(e){case"image/jpeg":case"image/png":case"image/webp":case"image/avif":case"image/ktx2":return!0;default:return!1}}function B(e){return w(this,void 0,void 0,(function(){var t,n,r,o;return A(this,(function(i){switch(i.label){case 0:if(!(t=e.getInternalTexture())||1!==t.source)return[2,null];if(t.invertY)return[2,null];n=t._buffer,o=e.mimeType,i.label=1;case 1:return i.trys.push([1,12,,13]),n?[3,3]:[4,g.Tools.LoadFileAsync(t.url)];case 2:return r=i.sent(),o=(0,g.GetMimeType)(t.url)||o,[3,11];case 3:return ArrayBuffer.isView(n)?(r=n.buffer.slice(n.byteOffset,n.byteOffset+n.byteLength),[3,11]):[3,4];case 4:return n instanceof ArrayBuffer?(r=n,[3,11]):[3,5];case 5:return n instanceof Blob?[4,n.arrayBuffer()]:[3,7];case 6:return r=i.sent(),o=n.type||o,[3,11];case 7:return"string"!=typeof n?[3,9]:[4,g.Tools.LoadFileAsync(n)];case 8:return r=i.sent(),o=(0,g.GetMimeType)(n)||o,[3,11];case 9:return"undefined"!=typeof HTMLImageElement&&n instanceof HTMLImageElement?[4,g.Tools.LoadFileAsync(n.src)]:[3,11];case 10:r=i.sent(),o=(0,g.GetMimeType)(n.src)||o,i.label=11;case 11:return[3,13];case 12:return i.sent(),[2,null];case 13:return r&&F(o)?[2,new Blob([r],{type:o})]:[2,null]}}))}))}function O(e,t,n){if(t<E.r)return 0;var r=E.r,o=e*n/(1-E.r)+t-2*E.r,i=o*o-4*r*(E.r-t);return g.Scalar.Clamp((-o+Math.sqrt(i))/(2*r),0,1)}function N(e){var t=e.diffuseColor.toLinearSpace(e.getScene().getEngine().useExactSrgbConversions).scale(.5),n=e.alpha,r=g.Scalar.Clamp(e.specularPower,0,I),o=(0,g.SpecularPowerToRoughness)(r);return{baseColorFactor:[t.r,t.g,t.b,n],metallicFactor:0,roughnessFactor:o}}function P(e,t){t.needAlphaBlending()?e.alphaMode="BLEND":t.needAlphaTesting()&&(e.alphaMode="MASK",e.alphaCutoff=t.alphaCutOff)}function U(e,t,n){for(var r=new Uint8Array(e*t*4),o=0;o<r.length;o+=4)r[o]=r[o+1]=r[o+2]=r[o+3]=255;return g.RawTexture.CreateRGBATexture(r,e,t,n)}function k(e){if(e instanceof Uint8Array){for(var t=e.length,n=new Float32Array(e.length),r=0;r<t;++r)n[r]=e[r]/255;return n}if(e instanceof Float32Array)return e;throw new Error("Unsupported pixel format!")}var D=function(){function e(e){this._exporter=e,this._textureMap=new Map,this._internalTextureToImage={}}return e.prototype.getTextureInfo=function(e){var t;return e&&null!==(t=this._textureMap.get(e.uniqueId))&&void 0!==t?t:null},e.prototype.exportStandardMaterialAsync=function(e,t){return w(this,void 0,void 0,(function(){var n,r,o,i,a,s,u,c;return A(this,(function(l){switch(l.label){case 0:return n=N(e),r={name:e.name},null==e.backFaceCulling||e.backFaceCulling||(e.twoSidedLighting||g.Tools.Warn(e.name+": Back-face culling disabled and two-sided lighting disabled is not supported in glTF."),r.doubleSided=!0),t?(o=[],(i=e.diffuseTexture)&&o.push(this.exportTextureAsync(i).then((function(e){e&&(n.baseColorTexture=e)}))),(a=e.bumpTexture)&&o.push(this.exportTextureAsync(a).then((function(e){e&&(r.normalTexture=e,1!==a.level&&(r.normalTexture.scale=a.level))}))),(s=e.emissiveTexture)&&(r.emissiveFactor=[1,1,1],o.push(this.exportTextureAsync(s).then((function(e){e&&(r.emissiveTexture=e)})))),(u=e.ambientTexture)&&o.push(this.exportTextureAsync(u).then((function(e){if(e){var t={index:e.index};r.occlusionTexture=t}}))),o.length>0?(this._exporter._materialNeedsUVsSet.add(e),[4,Promise.all(o)]):[3,2]):[3,2];case 1:l.sent(),l.label=2;case 2:return(e.alpha<1||e.opacityTexture)&&(e.alphaMode===g.Constants.ALPHA_COMBINE?r.alphaMode="BLEND":g.Tools.Warn(e.name+": glTF 2.0 does not support alpha mode: "+e.alphaMode.toString())),e.emissiveColor&&!e.emissiveColor.equalsWithEpsilon(V,C)&&(r.emissiveFactor=e.emissiveColor.asArray()),r.pbrMetallicRoughness=n,P(r,e),[4,this._finishMaterialAsync(r,e)];case 3:return l.sent(),(c=this._exporter._materials).push(r),[2,c.length-1]}}))}))},e.prototype._finishMaterialAsync=function(e,t){return w(this,void 0,void 0,(function(){var n,r,o,i,a;return A(this,(function(s){switch(s.label){case 0:return[4,this._exporter._extensionsPostExportMaterialAdditionalTexturesAsync("exportMaterial",e,t)];case 1:for(n=s.sent(),r=[],o=0,i=n;o<i.length;o++)a=i[o],r.push(this.exportTextureAsync(a));return[4,Promise.all(r)];case 2:return s.sent(),[4,this._exporter._extensionsPostExportMaterialAsync("exportMaterial",e,t)];case 3:return s.sent(),[2]}}))}))},e.prototype._resizeTexturesToSameDimensions=function(e,t,n){var r,o,i=e?e.getSize():{width:0,height:0},a=t?t.getSize():{width:0,height:0};return i.width<a.width?(r=e&&e instanceof g.Texture?g.TextureTools.CreateResizedCopy(e,a.width,a.height,!0):U(a.width,a.height,n),o=t):i.width>a.width?(o=t&&t instanceof g.Texture?g.TextureTools.CreateResizedCopy(t,i.width,i.height,!0):U(i.width,i.height,n),r=e):(r=e,o=t),{texture1:r,texture2:o}},e.prototype._convertSpecularGlossinessTexturesToMetallicRoughnessAsync=function(e,t,n){return w(this,void 0,void 0,(function(){var r,o,i,a,s,u,c,l,h,p,f,d,m,x,_,v,T,y,b,M,w,R,E,I,V,F,B,O,N,P,U;return A(this,(function(A){switch(A.label){case 0:return r=new Array,e||t?[3,2]:[4,Promise.reject("diffuse and specular glossiness textures are not defined!")];case 1:case 6:case 9:case 11:case 13:return[2,A.sent()];case 2:return(o=e?e.getScene():t?t.getScene():null)?(i=this._resizeTexturesToSameDimensions(e,t,o),a=null===(U=i.texture1)||void 0===U?void 0:U.getSize(),s=void 0,u=void 0,c=a.width,l=a.height,[4,i.texture1.readPixels()]):[3,12];case 3:return h=A.sent(),[4,i.texture2.readPixels()];case 4:return p=A.sent(),h?(s=k(h),[3,7]):[3,5];case 5:return[4,Promise.reject("Failed to retrieve pixels from diffuse texture!")];case 7:return p?(u=k(p),[3,10]):[3,8];case 8:return[4,Promise.reject("Failed to retrieve pixels from specular glossiness texture!")];case 10:for(f=u.byteLength,d=new Uint8Array(f),m=new Uint8Array(f),x=new g.Color3(0,0,0),_=0,v=0,F=0;F<l;++F)for(B=0;B<c;++B)T=4*(c*F+B),y=new g.Color3(s[T],s[T+1],s[T+2]).toLinearSpace(o.getEngine().useExactSrgbConversions).multiply(n.diffuseColor),b=new g.Color3(u[T],u[T+1],u[T+2]).toLinearSpace(o.getEngine().useExactSrgbConversions).multiply(n.specularColor),M=u[T+3]*n.glossiness,w={diffuseColor:y,specularColor:b,glossiness:M},R=this._convertSpecularGlossinessToMetallicRoughness(w),x.r=Math.max(x.r,R.baseColor.r),x.g=Math.max(x.g,R.baseColor.g),x.b=Math.max(x.b,R.baseColor.b),_=Math.max(_,R.metallic),v=Math.max(v,R.roughness),m[T]=255*R.baseColor.r,m[T+1]=255*R.baseColor.g,m[T+2]=255*R.baseColor.b,m[T+3]=i.texture1.hasAlpha?255*s[T+3]:255,d[T]=0,d[T+1]=255*R.roughness,d[T+2]=255*R.metallic,d[T+3]=255;for(E={baseColor:x,metallic:_,roughness:v},I=!1,V=!1,F=0;F<l;++F)for(B=0;B<c;++B)m[O=4*(c*F+B)]/=E.baseColor.r>C?E.baseColor.r:1,m[O+1]/=E.baseColor.g>C?E.baseColor.g:1,m[O+2]/=E.baseColor.b>C?E.baseColor.b:1,N=g.Color3.FromInts(m[O],m[O+1],m[O+2]),P=N.toGammaSpace(o.getEngine().useExactSrgbConversions),m[O]=255*P.r,m[O+1]=255*P.g,m[O+2]=255*P.b,P.equalsWithEpsilon(S,C)||(V=!0),d[O+1]/=E.roughness>C?E.roughness:1,d[O+2]/=E.metallic>C?E.metallic:1,g.Color3.FromInts(255,d[O+1],d[O+2]).equalsWithEpsilon(S,C)||(I=!0);return I&&r.push((0,g.EncodeImageAsync)(d,c,l).then((function(e){E.metallicRoughnessTextureData=e}))),V&&r.push((0,g.EncodeImageAsync)(m,c,l).then((function(e){E.baseColorTextureData=e}))),[4,Promise.all(r).then((function(){return E}))];case 12:return[4,Promise.reject("_ConvertSpecularGlossinessTexturesToMetallicRoughness: Scene from textures is missing!")]}}))}))},e.prototype._convertSpecularGlossinessToMetallicRoughness=function(e){var t=this._getPerceivedBrightness(e.diffuseColor),n=this._getPerceivedBrightness(e.specularColor),r=1-this._getMaxComponent(e.specularColor),o=O(t,n,r),i=e.diffuseColor.scale(r/(1-E.r)/Math.max(1-o,C)),a=e.specularColor.subtract(E.scale(1-o)).scale(1/Math.max(o,C)),s=g.Color3.Lerp(i,a,o*o);return{baseColor:s=s.clampToRef(0,1,s),metallic:o,roughness:1-e.glossiness}},e.prototype._getPerceivedBrightness=function(e){return Math.sqrt(.299*e.r*e.r+.587*e.g*e.g+.114*e.b*e.b)},e.prototype._getMaxComponent=function(e){return Math.max(e.r,Math.max(e.g,e.b))},e.prototype._convertMetalRoughFactorsToMetallicRoughnessAsync=function(e,t,n,r,o,i,a,s,u){return w(this,void 0,void 0,(function(){var c,l,h,p,f,d,m,x,_,v=this;return A(this,(function(T){switch(T.label){case 0:return c=[],l={baseColor:e,metallic:t,roughness:n},u&&(a instanceof g.OpenPBRMaterial?(a.geometryOpacityTexture?(h=r&&r.getInternalTexture()?r.getInternalTexture().uniqueId:0,p=a.geometryOpacityTexture&&a.geometryOpacityTexture.getInternalTexture()?a.geometryOpacityTexture.getInternalTexture().uniqueId:0,f=Number("".concat(h).concat(p)),(_=this._textureMap.get(f))?s.baseColorTexture=_:c.push((0,g.MergeTexturesAsync)("baseColorOpacityTexture",(0,g.CreateRGBAConfiguration)(r?(0,g.CreateTextureInput)(r,0):(0,g.CreateConstantInput)(1),r?(0,g.CreateTextureInput)(r,1):(0,g.CreateConstantInput)(1),r?(0,g.CreateTextureInput)(r,2):(0,g.CreateConstantInput)(1),(0,g.CreateTextureInput)(a.geometryOpacityTexture,0)),a.getScene()).then((function(e){return w(v,void 0,void 0,(function(){var t;return A(this,(function(n){switch(n.label){case 0:return[4,this.exportTextureAsync(e,f)];case 1:return(t=n.sent())&&(s.baseColorTexture=t),[2]}}))}))})))):r&&c.push(this.exportTextureAsync(r).then((function(e){e&&(s.baseColorTexture=e)}))),a._useMetallicFromMetallicTextureBlue&&o?c.push(this.exportTextureAsync(o).then((function(e){e&&(s.metallicRoughnessTexture=e)}))):(i||o)&&(d=o&&o.getInternalTexture()?o.getInternalTexture().uniqueId:0,m=i&&i.getInternalTexture()?i.getInternalTexture().uniqueId:0,x=Number("".concat(d).concat(m)),(_=this._textureMap.get(x))?s.metallicRoughnessTexture=_:c.push((0,g.MergeTexturesAsync)("MetalRoughTexture",(0,g.CreateRGBAConfiguration)(a.ambientOcclusionTexture?(0,g.CreateTextureInput)(a.ambientOcclusionTexture,0):(0,g.CreateConstantInput)(1),i?(0,g.CreateTextureInput)(i,0):(0,g.CreateConstantInput)(1),o?(0,g.CreateTextureInput)(o,0):(0,g.CreateConstantInput)(1)),a.getScene()).then((function(e){return w(v,void 0,void 0,(function(){var t;return A(this,(function(n){switch(n.label){case 0:return[4,this.exportTextureAsync(e,x)];case 1:return(t=n.sent())&&(s.metallicRoughnessTexture=t),[2]}}))}))}))))):(r&&c.push(this.exportTextureAsync(r).then((function(e){e&&(s.baseColorTexture=e)}))),o&&c.push(this.exportTextureAsync(o).then((function(e){e&&(s.metallicRoughnessTexture=e)}))))),c.length>0?(this._exporter._materialNeedsUVsSet.add(a),[4,Promise.all(c)]):[3,2];case 1:T.sent(),T.label=2;case 2:return[2,l]}}))}))},e.prototype._getTextureSampler=function(e){var t={};if(!(e&&e instanceof g.Texture))return t;var n=this._getGLTFTextureWrapMode(e.wrapU);10497!==n&&(t.wrapS=n);var r=this._getGLTFTextureWrapMode(e.wrapV);switch(10497!==r&&(t.wrapT=r),e.samplingMode){case g.Texture.LINEAR_LINEAR:t.magFilter=9729,t.minFilter=9729;break;case g.Texture.LINEAR_NEAREST:t.magFilter=9729,t.minFilter=9728;break;case g.Texture.NEAREST_LINEAR:t.magFilter=9728,t.minFilter=9729;break;case g.Texture.NEAREST_LINEAR_MIPLINEAR:t.magFilter=9728,t.minFilter=9987;break;case g.Texture.NEAREST_NEAREST:t.magFilter=9728,t.minFilter=9728;break;case g.Texture.NEAREST_LINEAR_MIPNEAREST:t.magFilter=9728,t.minFilter=9985;break;case g.Texture.LINEAR_NEAREST_MIPNEAREST:t.magFilter=9729,t.minFilter=9984;break;case g.Texture.LINEAR_NEAREST_MIPLINEAR:t.magFilter=9729,t.minFilter=9986;break;case g.Texture.NEAREST_NEAREST_MIPLINEAR:t.magFilter=9728,t.minFilter=9986;break;case g.Texture.LINEAR_LINEAR_MIPLINEAR:t.magFilter=9729,t.minFilter=9987;break;case g.Texture.LINEAR_LINEAR_MIPNEAREST:t.magFilter=9729,t.minFilter=9985;break;case g.Texture.NEAREST_NEAREST_MIPNEAREST:t.magFilter=9728,t.minFilter=9984}return t},e.prototype._getGLTFTextureWrapMode=function(e){switch(e){case g.Texture.WRAP_ADDRESSMODE:return 10497;case g.Texture.CLAMP_ADDRESSMODE:return 33071;case g.Texture.MIRROR_ADDRESSMODE:return 33648;default:return g.Tools.Error("Unsupported Texture Wrap Mode ".concat(e,"!")),10497}},e.prototype._convertSpecGlossFactorsToMetallicRoughnessAsync=function(e,t,n){return w(this,void 0,void 0,(function(){var r,o,i,a,s,u,c,l;return A(this,(function(h){switch(h.label){case 0:return r={diffuseColor:e._albedoColor,specularColor:e._reflectivityColor,glossiness:e._microSurface},o=e._albedoTexture,i=e._reflectivityTexture,a=e._useMicroSurfaceFromReflectivityMapAlpha,!i||a?[3,2]:[4,Promise.reject("_ConvertPBRMaterial: Glossiness values not included in the reflectivity texture are currently not supported")];case 1:return[2,h.sent()];case 2:return(o||i)&&n?(this._exporter._materialNeedsUVsSet.add(e),s=this._exportTextureSampler(o||i),[4,this._convertSpecularGlossinessTexturesToMetallicRoughnessAsync(o,i,r)]):[3,8];case 3:return u=h.sent(),c=this._exporter._textures,u.baseColorTextureData?[4,this._exportImageAsync("baseColor".concat(c.length),u.baseColorTextureData)]:[3,5];case 4:l=h.sent(),t.baseColorTexture=this._exportTextureInfo(l,s,null==o?void 0:o.coordinatesIndex),h.label=5;case 5:return u.metallicRoughnessTextureData?[4,this._exportImageAsync("metallicRoughness".concat(c.length),u.metallicRoughnessTextureData)]:[3,7];case 6:l=h.sent(),t.metallicRoughnessTexture=this._exportTextureInfo(l,s,null==i?void 0:i.coordinatesIndex),h.label=7;case 7:return[2,u];case 8:return[2,this._convertSpecularGlossinessToMetallicRoughness(r)]}}))}))},e.prototype.exportPBRMaterialAsync=function(e,t){return w(this,void 0,void 0,(function(){var n,r,o,i,a,s,u,c;return A(this,(function(l){switch(l.label){case 0:return n={},r={name:e.name},(o=e.isMetallicWorkflow())&&(i=e._albedoColor,a=e.alpha,i&&(n.baseColorFactor=[i.r,i.g,i.b,a])),o?[4,this._convertMetalRoughFactorsToMetallicRoughnessAsync(e._albedoColor,e._metallic,e._roughness,e._albedoTexture,e._metallicTexture,e._metallicTexture,e,n,t)]:[3,2];case 1:return u=l.sent(),[3,4];case 2:return[4,this._convertSpecGlossFactorsToMetallicRoughnessAsync(e,n,t)];case 3:u=l.sent(),l.label=4;case 4:return s=u,[4,this._setMetallicRoughnessPbrMaterialAsync(s,e,r,n,t)];case 5:return l.sent(),[4,this._finishMaterialAsync(r,e)];case 6:return l.sent(),(c=this._exporter._materials).push(r),[2,c.length-1]}}))}))},e.prototype._setMetallicRoughnessPbrMaterialAsync=function(e,t,n,r,o){return w(this,void 0,void 0,(function(){var i,a,s,u,c,l=this;return A(this,(function(h){switch(h.label){case 0:return P(n,t),e.baseColor.equalsWithEpsilon(S,C)&&g.Scalar.WithinEpsilon(t.alpha,1,C)||(r.baseColorFactor=[e.baseColor.r,e.baseColor.g,e.baseColor.b,t.alpha]),null!=e.metallic&&1!==e.metallic&&(r.metallicFactor=e.metallic),null!=e.roughness&&1!==e.roughness&&(r.roughnessFactor=e.roughness),null==t.backFaceCulling||t.backFaceCulling||(t._twoSidedLighting||g.Tools.Warn(t.name+": Back-face culling disabled and two-sided lighting disabled is not supported in glTF."),n.doubleSided=!0),o?(i=[],(a=t instanceof g.PBRBaseMaterial?t._bumpTexture:t.geometryNormalTexture)&&i.push(this.exportTextureAsync(a).then((function(e){e&&(n.normalTexture=e,1!==a.level&&(n.normalTexture.scale=a.level))}))),(s=t instanceof g.PBRBaseMaterial?t._ambientTexture:t.ambientOcclusionTexture)&&i.push(new Promise((function(e){return w(l,void 0,void 0,(function(){var n,o,i,a;return A(this,(function(u){switch(u.label){case 0:return t instanceof g.OpenPBRMaterial&&r.metallicRoughnessTexture?(n=this._exportTextureSampler(s),o=this._exporter._textures[r.metallicRoughnessTexture.index].source,i=this._exportTextureInfo(o,n,s.coordinatesIndex),this._textureMap.set(s.uniqueId,i),this._exporter._extensionsPostExportTextures("exporter",i,s),[2,e(i)]):[3,1];case 1:return a=e,[4,this.exportTextureAsync(s)];case 2:return[2,a.apply(void 0,[u.sent()])]}}))}))})).then((function(e){return w(l,void 0,void 0,(function(){var r;return A(this,(function(o){return e&&(r={index:e.index,texCoord:e.texCoord,extensions:e.extensions},n.occlusionTexture=r,t instanceof g.PBRBaseMaterial?r.strength=t._ambientTextureStrength:r.strength=t.ambientOcclusionTexture.level),[2]}))}))}))),(u=t instanceof g.PBRBaseMaterial?t._emissiveTexture:t.emissionColorTexture)&&i.push(this.exportTextureAsync(u).then((function(e){e&&(n.emissiveTexture=e)}))),i.length>0?(this._exporter._materialNeedsUVsSet.add(t),[4,Promise.all(i)]):[3,2]):[3,2];case 1:h.sent(),h.label=2;case 2:return(c=t instanceof g.PBRBaseMaterial?t._emissiveColor:t.emissionColor).equalsWithEpsilon(V,C)||(n.emissiveFactor=c.asArray()),n.pbrMetallicRoughness=r,[2]}}))}))},e.prototype.exportOpenPBRMaterialAsync=function(e,t){return w(this,void 0,void 0,(function(){var n,r,o,i,a,s;return A(this,(function(u){switch(u.label){case 0:return n={},r={name:e.name},o=e.baseColor,i=e.geometryOpacity,o&&(n.baseColorFactor=[o.r,o.g,o.b,i]),[4,this._convertMetalRoughFactorsToMetallicRoughnessAsync(e.baseColor,e.baseMetalness,e.specularRoughness,e.baseColorTexture,e.baseMetalnessTexture,e.specularRoughnessTexture,e,n,t)];case 1:return a=u.sent(),[4,this._setMetallicRoughnessPbrMaterialAsync(a,e,r,n,t)];case 2:return u.sent(),[4,this._finishMaterialAsync(r,e)];case 3:return u.sent(),(s=this._exporter._materials).push(r),[2,s.length-1]}}))}))},e.prototype.exportTextureAsync=function(e){return w(this,arguments,void 0,(function(e,t){var n,r,o;return void 0===t&&(t=null),A(this,(function(i){switch(i.label){case 0:return(n=this._textureMap.get(null!=t?t:e.uniqueId))?[2,n]:(r=this._exportTextureSampler(e),[4,this._exportTextureImageAsync(e)]);case 1:return o=i.sent(),n=this._exportTextureInfo(o,r,e.coordinatesIndex),this._textureMap.set(null!=t?t:e.uniqueId,n),this._exporter._extensionsPostExportTextures("exporter",n,e),[2,n]}}))}))},e.prototype._exportTextureImageAsync=function(e){return w(this,void 0,void 0,(function(){var t,n,r,o,i,a=this;return A(this,(function(s){switch(s.label){case 0:return t=null!==(i=e.mimeType)&&void 0!==i?i:"none",n=this._internalTextureToImage,r=e.getInternalTexture().uniqueId,n[r]=n[r]||{},void 0===(o=n[r][t])&&(o=w(a,void 0,void 0,(function(){var n,r,o,i,a;return A(this,(function(s){switch(s.label){case 0:return[4,B(e)];case 1:return!(n=s.sent())||"none"!==t&&n.type!==t?[3,3]:[4,this._exportImageAsync(e.name,n)];case 2:case 6:return[2,s.sent()];case 3:return r="image/png","none"!==t&&(F(t)?r=t:(r="image/png",g.Tools.Warn("Unsupported media type: ".concat(t,". Exporting texture as PNG.")))),o=e.getSize(),[4,(0,g.GetTextureDataAsync)(e)];case 4:return i=s.sent(),[4,(0,g.EncodeImageAsync)(i,o.width,o.height,r)];case 5:return a=s.sent(),[4,this._exportImageAsync(e.name,a)]}}))})),n[r][t]=o),[4,o];case 1:return[2,s.sent()]}}))}))},e.prototype._exportImageAsync=function(e,t){return w(this,void 0,void 0,(function(){var n,r,o,i,a,s,u;return A(this,(function(c){switch(c.label){case 0:return n=this._exporter._images,this._exporter._shouldUseGlb?(r={name:e,mimeType:t.type,bufferView:void 0},[4,t.arrayBuffer()]):[3,2];case 1:return o=c.sent(),i=this._exporter._bufferManager.createBufferView(new Uint8Array(o)),this._exporter._bufferManager.setBufferView(r,i),[3,3];case 2:a=e.replace(/\.\/|\/|\.\\|\\/g,"_"),s=function(e){switch(e){case"image/jpeg":return".jpg";case"image/png":return".png";case"image/webp":return".webp";case"image/avif":return".avif";case"image/ktx2":return".ktx2"}}(t.type),u=a+s,n.some((function(e){return e.uri===u}))&&(u="".concat(a,"_").concat(g.Tools.RandomId()).concat(s)),r={name:e,uri:u},this._exporter._imageData[u]=t,c.label=3;case 3:return n.push(r),[2,n.length-1]}}))}))},e.prototype._exportTextureInfo=function(e,t,n){var r=this._exporter._textures,o=r.findIndex((function(n){return n.sampler==t&&n.source===e}));-1===o&&(o=r.length,r.push({source:e,sampler:t}));var i={index:o};return n&&(i.texCoord=n),i},e.prototype._exportTextureSampler=function(e){var t=this._getTextureSampler(e),n=this._exporter._samplers,r=n.findIndex((function(e){return e.minFilter===t.minFilter&&e.magFilter===t.magFilter&&e.wrapS===t.wrapS&&e.wrapT===t.wrapT}));return-1!==r?r:(n.push(t),n.length-1)},e}(),L=g.Matrix.Compose(new g.Vector3(-1,1,1),g.Quaternion.Identity(),g.Vector3.Zero());function z(e,t){if(!(e instanceof g.TransformNode))return!1;if(t){if(!e.getWorldMatrix().equalsWithEpsilon(g.Matrix.IdentityReadOnly,g.Epsilon))return!1}else if(!e.getWorldMatrix().multiplyToRef(L,g.TmpVectors.Matrix[0]).equalsWithEpsilon(g.Matrix.IdentityReadOnly,g.Epsilon))return!1;return!(e instanceof g.AbstractMesh&&e.geometry)}var K=g.Vector3.ZeroReadOnly,W=g.Quaternion.Identity(),q=g.Vector3.OneReadOnly,G=new g.Vector3(-1,1,1);function j(e,t){var n=e.byteOffset,r=e.byteStride,o=e.type,i=e.normalized,a=e.getSize(),s=t.reduce((function(e,t){return t.getTotalVertices()>e?t.getTotalVertices():e}),-Number.MAX_VALUE);return{byteOffset:n,byteStride:r,componentCount:a,type:o,count:s*a,normalized:i,totalVertices:s,kind:e.getKind()}}function H(e){switch(e){case"MAT2":case"VEC4":return 4;case"MAT3":return 9;case"MAT4":return 16;case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3}}function X(e){switch(e){case g.VertexBuffer.PositionKind:case g.VertexBuffer.NormalKind:case g.VertexBuffer.TangentKind:case g.VertexBuffer.ColorKind:case g.VertexBuffer.MatricesIndicesKind:case g.VertexBuffer.MatricesIndicesExtraKind:case g.VertexBuffer.MatricesWeightsKind:case g.VertexBuffer.MatricesWeightsExtraKind:case g.VertexBuffer.UVKind:case g.VertexBuffer.UV2Kind:case g.VertexBuffer.UV3Kind:case g.VertexBuffer.UV4Kind:case g.VertexBuffer.UV5Kind:case g.VertexBuffer.UV6Kind:return!0}return!1}function Q(e){var t=Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z);t>0&&(e.x/=t,e.y/=t,e.z/=t)}function Z(e){return e.x*=-1,e}function Y(e){if(e.x*e.x+e.y*e.y>.5){var t=Math.abs(e.x),n=Math.abs(e.y);if(t>n){var r=Math.sign(e.x);e.x=t,e.y*=-r,e.z*=-r,e.w*=r}else r=Math.sign(e.y),e.x*=-r,e.y=n,e.z*=r,e.w*=-r}else{var o=Math.abs(e.z),i=Math.abs(e.w);o>i?(r=Math.sign(e.z),e.x*=-r,e.y*=r,e.z=o,e.w*=-r):(r=Math.sign(e.w),e.x*=r,e.y*=-r,e.z*=-r,e.w=i)}return e}function J(e){e.copyFromFloats(-e.z,e.w,e.x,-e.y)}function $(e,t){var n=g.Vector3.FromArrayToRef(t.translation||[0,0,0],0,g.TmpVectors.Vector3[0]),r=g.Quaternion.FromArrayToRef(t.rotation||[0,0,0,1],0,g.TmpVectors.Quaternion[0]),o=g.Matrix.ComposeToRef(q,r,n,g.TmpVectors.Matrix[0]),i=g.Vector3.FromArrayToRef(e.translation||[0,0,0],0,g.TmpVectors.Vector3[2]),a=g.Quaternion.FromArrayToRef(e.rotation||[0,0,0,1],0,g.TmpVectors.Quaternion[1]),s=g.Matrix.ComposeToRef(q,a,i,g.TmpVectors.Matrix[1]);o.multiplyToRef(s,s),s.decompose(void 0,r,n),n.equalsWithEpsilon(K,g.Epsilon)?delete t.translation:t.translation=n.asArray(),r.equalsWithEpsilon(W,g.Epsilon)?delete t.rotation:t.rotation=r.asArray(),t.scale&&delete t.scale}function ee(e,t){if(!(t instanceof g.TransformNode))return!1;if(1!==t.getChildren().length||0!==e.getChildren().length||e.parent!==t)return!1;var n=e.getScene(),r=e instanceof g.TargetCamera&&!n.useRightHandedSystem?G:q;return!!t.scaling.equalsWithEpsilon(r,g.Epsilon)||(g.Logger.Warn("Cannot collapse node ".concat(e.name," into parent node ").concat(t.name," with modified scaling.")),!1)}function te(e,t){for(var n=0,r=Object.entries(e);n<r.length;n++){var o=r[n],i=o[0],a=o[1],s=t[i];(Array.isArray(a)&&Array.isArray(s)&&ne(a,s)||a===s)&&delete e[i]}return e}function ne(e,t){return e.length===t.length&&e.every((function(e,n){return e===t[n]}))}var re=new Map([[Int8Array,function(e,t,n){return e.setInt8(t,n)}],[Uint8Array,function(e,t,n){return e.setUint8(t,n)}],[Uint8ClampedArray,function(e,t,n){return e.setUint8(t,n)}],[Int16Array,function(e,t,n){return e.setInt16(t,n,!0)}],[Uint16Array,function(e,t,n){return e.setUint16(t,n,!0)}],[Int32Array,function(e,t,n){return e.setInt32(t,n,!0)}],[Uint32Array,function(e,t,n){return e.setUint32(t,n,!0)}],[Float32Array,function(e,t,n){return e.setFloat32(t,n,!0)}],[Float64Array,function(e,t,n){return e.setFloat64(t,n,!0)}]]),oe=function(){function e(e){this._data=new Uint8Array(e),this._dataView=new DataView(this._data.buffer),this._byteOffset=0}return e.prototype.writeTypedArray=function(e){this._checkGrowBuffer(e.byteLength);for(var t=re.get(e.constructor),n=0;n<e.length;n++)t(this._dataView,this._byteOffset,e[n]),this._byteOffset+=e.BYTES_PER_ELEMENT},Object.defineProperty(e.prototype,"byteOffset",{get:function(){return this._byteOffset},enumerable:!1,configurable:!0}),e.prototype.getOutputData=function(){return new Uint8Array(this._data.buffer,0,this._byteOffset)},e.prototype.writeUInt8=function(e){this._checkGrowBuffer(1),this._dataView.setUint8(this._byteOffset,e),this._byteOffset++},e.prototype.writeInt8=function(e){this._checkGrowBuffer(1),this._dataView.setInt8(this._byteOffset,e),this._byteOffset++},e.prototype.writeInt16=function(e){this._checkGrowBuffer(2),this._dataView.setInt16(this._byteOffset,e,!0),this._byteOffset+=2},e.prototype.writeUInt16=function(e){this._checkGrowBuffer(2),this._dataView.setUint16(this._byteOffset,e,!0),this._byteOffset+=2},e.prototype.writeInt32=function(e){this._checkGrowBuffer(4),this._dataView.setInt32(this._byteOffset,e,!0),this._byteOffset+=4},e.prototype.writeUInt32=function(e){this._checkGrowBuffer(4),this._dataView.setUint32(this._byteOffset,e,!0),this._byteOffset+=4},e.prototype.writeFloat32=function(e){this._checkGrowBuffer(4),this._dataView.setFloat32(this._byteOffset,e,!0),this._byteOffset+=4},e.prototype.writeFloat64=function(e){this._checkGrowBuffer(8),this._dataView.setFloat64(this._byteOffset,e,!0),this._byteOffset+=8},e.prototype._checkGrowBuffer=function(e){var t=this.byteOffset+e;if(t>this._data.byteLength){var n=new Uint8Array(2*t);n.set(this._data),this._data=n,this._dataView=new DataView(this._data.buffer)}},e}();function ie(e){return e%4==0?4:e%2==0?2:1}var ae,se=function(){function e(){this._bufferViewToData=new Map,this._bufferViewToProperties=new Map,this._accessorToBufferView=new Map}return e.prototype.generateBinary=function(e){var t=0;this._bufferViewToData.forEach((function(e){t+=e.byteLength}));for(var n=new oe(t),r=0,o=Array.from(this._bufferViewToData.keys()).sort((function(e,t){return ie(t.byteLength)-ie(e.byteLength)}));r<o.length;r++){var i=o[r];i.byteOffset=n.byteOffset,e.push(i);for(var a=e.length-1,s=0,u=this.getPropertiesWithBufferView(i);s<u.length;s++)u[s].bufferView=a;n.writeTypedArray(this._bufferViewToData.get(i)),this._bufferViewToData.delete(i)}return n.getOutputData()},e.prototype.createBufferView=function(e,t){var n={buffer:0,byteOffset:void 0,byteLength:e.byteLength,byteStride:t};return this._bufferViewToData.set(n,e),n},e.prototype.createAccessor=function(e,t,n,r,o,i,a){this._verifyBufferView(e);var s={bufferView:void 0,componentType:n,count:r,type:t,min:null==i?void 0:i.min,max:null==i?void 0:i.max,normalized:a,byteOffset:o};return this.setBufferView(s,e),this._accessorToBufferView.set(s,e),s},e.prototype.setBufferView=function(e,t){this._verifyBufferView(t),this.getPropertiesWithBufferView(t).push(e)},e.prototype.removeBufferView=function(e){for(var t=this,n=0,r=this.getPropertiesWithBufferView(e);n<r.length;n++){var o=r[n];void 0!==o.bufferView&&delete o.bufferView}this._bufferViewToData.delete(e),this._bufferViewToProperties.delete(e),this._accessorToBufferView.forEach((function(n,r){n===e&&(void 0!==r.byteOffset&&delete r.byteOffset,t._accessorToBufferView.delete(r))}))},e.prototype.getBufferView=function(e){var t=this._accessorToBufferView.get(e);return this._verifyBufferView(t),t},e.prototype.getPropertiesWithBufferView=function(e){var t;return this._verifyBufferView(e),this._bufferViewToProperties.set(e,null!==(t=this._bufferViewToProperties.get(e))&&void 0!==t?t:[]),this._bufferViewToProperties.get(e)},e.prototype.getData=function(e){return this._verifyBufferView(e),this._bufferViewToData.get(e)},e.prototype._verifyBufferView=function(e){if(void 0===e||!this._bufferViewToData.has(e))throw new Error("BufferView ".concat(e," not found in BufferManager."))},e}();!function(e){e[e.INTANGENT=0]="INTANGENT",e[e.OUTTANGENT=1]="OUTTANGENT"}(ae||(ae={}));var ue=function(){function e(){}return e._IsTransformable=function(e){return e&&(e instanceof g.TransformNode||e instanceof g.Camera||e instanceof g.Light)},e._CreateNodeAnimation=function(t,n,r,o,i){if(this._IsTransformable(t)){var a=[],s=[],u=n.getKeys(),c=e._CalculateMinMaxKeyFrames(u),l=e._DeduceInterpolation(u,r,o),h=l.interpolationType,p=l.shouldBakeAnimation;if(p?e._CreateBakedAnimation(t,n,r,c.min,c.max,n.framePerSecond,i,a,s,c,o):"LINEAR"===h||"STEP"===h?e._CreateLinearOrStepAnimation(t,n,r,a,s,o):"CUBICSPLINE"===h?e._CreateCubicSplineAnimation(t,n,r,a,s,o):e._CreateBakedAnimation(t,n,r,c.min,c.max,n.framePerSecond,i,a,s,c,o),a.length&&s.length)return{inputs:a,outputs:s,samplerInterpolation:h,inputsMin:p?c.min:g.Tools.FloatRound(c.min/n.framePerSecond),inputsMax:p?c.max:g.Tools.FloatRound(c.max/n.framePerSecond)}}return null},e._DeduceAnimationInfo=function(e){var t=null,n="VEC3",r=!1,o=e.targetProperty.split(".");switch(o[0]){case"scaling":t="scale";break;case"position":t="translation";break;case"rotation":n="VEC4",t="rotation";break;case"rotationQuaternion":n="VEC4",r=!0,t="rotation";break;case"influence":n="SCALAR",t="weights";break;default:g.Tools.Error("Unsupported animatable property ".concat(o[0]))}return t?{animationChannelTargetPath:t,dataAccessorType:n,useQuaternion:r}:(g.Tools.Error("animation channel target path and data accessor type could be deduced"),null)},e._CreateNodeAnimationFromNodeAnimations=function(t,n,r,o,i,a,s,u,c,l,h){var p;if(e._IsTransformable(t)&&t.animations)for(var f=0,d=t.animations;f<d.length;f++){var m=d[f];if(!h||h(m)){var g=e._DeduceAnimationInfo(m);g&&(p={name:m.name,samplers:[],channels:[]},e._AddAnimation("".concat(m.name),m.hasRunningRuntimeAnimations?n:p,t,m,g.dataAccessorType,g.animationChannelTargetPath,o,a,s,u,g.useQuaternion,c,l),p.samplers.length&&p.channels.length&&r.push(p))}}},e._CreateMorphTargetAnimationFromMorphTargetAnimations=function(t,n,r,o,i,a,s,u,c,l,h){var p;if(t instanceof g.Mesh){var f=t.morphTargetManager;if(f)for(var d=0;d<f.numTargets;++d)for(var m=0,x=f.getTarget(d).animations;m<x.length;m++){var _=x[m];if(!h||h(_)){for(var v=new g.Animation("".concat(_.name),"influence",_.framePerSecond,_.dataType,_.loopMode,_.enableBlending),T=[],y=_.getKeys(),b=0;b<y.length;++b)for(var M=y[b],w=0;w<f.numTargets;++w)w==d?T.push(M):T.push({frame:M.frame,value:0});v.setKeys(T,!0);var A=e._DeduceAnimationInfo(v);A&&(p={name:v.name,samplers:[],channels:[]},e._AddAnimation(_.name,_.hasRunningRuntimeAnimations?n:p,t,v,A.dataAccessorType,A.animationChannelTargetPath,o,a,s,u,A.useQuaternion,c,l,f.numTargets),p.samplers.length&&p.channels.length&&r.push(p))}}}},e._CreateNodeAndMorphAnimationFromAnimationGroups=function(t,n,r,o,i,a,s,u,c){var l,h;if(t.animationGroups)for(var p=t.animationGroups,f=function(p){var f=new Map,m=new Map,x=new Set,_=p.to-p.from;h={name:p.name,channels:[],samplers:[]};for(var v=function(n){var _=p.targetedAnimations[n],v=_.target,T=_.animation;if(c&&!c(T))return"continue";var y=u.has(v);if(d._IsTransformable(v)||1===v.length&&d._IsTransformable(v[0])){if(M=e._DeduceAnimationInfo(_.animation)){var b=d._IsTransformable(v)?v:d._IsTransformable(v[0])?v[0]:null;b&&e._AddAnimation("".concat(T.name),h,b,T,M.dataAccessorType,M.animationChannelTargetPath,r,o,i,a,M.useQuaternion,s,y)}}else if(v instanceof g.MorphTarget||1===v.length&&v[0]instanceof g.MorphTarget){var M;if(M=e._DeduceAnimationInfo(_.animation)){var w=v instanceof g.MorphTarget?v:v[0];if(w){var A=t.morphTargetManagers.find((function(e){for(var t=0;t<e.numTargets;++t)if(e.getTarget(t)===w)return!0;return!1}));if(A){var R=t.meshes.find((function(e){return e.morphTargetManager===A}));R&&(f.has(R)||f.set(R,new Map),null===(l=f.get(R))||void 0===l||l.set(w,T),x.add(R),m.set(R,T))}}}}},T=0;T<p.targetedAnimations.length;++T)v(T);x.forEach((function(t){for(var n=t.morphTargetManager,u=null,c=[],l=m.get(t).getKeys(),d=l.length,x=0;x<d;++x)for(var v=0;v<n.numTargets;++v){var T=n.getTarget(v),y=f.get(t);if(y){var b=y.get(T);b?(u||(u=new g.Animation("".concat(p.name,"_").concat(t.name,"_MorphWeightAnimation"),"influence",b.framePerSecond,g.Animation.ANIMATIONTYPE_FLOAT,b.loopMode,b.enableBlending)),c.push(b.getKeys()[x])):c.push({frame:p.from+_/d*x,value:T.influence,inTangent:l[0].inTangent?0:void 0,outTangent:l[0].outTangent?0:void 0})}}u.setKeys(c,!0);var M=e._DeduceAnimationInfo(u);M&&e._AddAnimation("".concat(p.name,"_").concat(t.name,"_MorphWeightAnimation"),h,t,u,M.dataAccessorType,M.animationChannelTargetPath,r,o,i,a,M.useQuaternion,s,!1,null==n?void 0:n.numTargets)})),h.channels.length&&h.samplers.length&&n.push(h)},d=this,m=0,x=p;m<x.length;m++)f(x[m])},e._AddAnimation=function(t,n,r,o,i,a,s,u,c,l,h,p,f,d){var m,x,_,v,T,y,b=e._CreateNodeAnimation(r,o,a,h,p);if(b){if(d){for(var M=0,w=0,A=[];b.inputs.length>0;)w=b.inputs.shift(),M%d==0&&A.push(w),M++;b.inputs=A}var R=s.get(r),C=new Float32Array(b.inputs);m=u.createBufferView(C),x=u.createAccessor(m,"SCALAR",5126,b.inputs.length,void 0,{min:[b.inputsMin],max:[b.inputsMax]}),l.push(x),_=l.length-1;var E=new g.Quaternion,I=new g.Vector3,S=new g.Vector3,V=r instanceof g.Camera,F=H(i),B=new Float32Array(b.outputs.length*F);b.outputs.forEach((function(e,t){var n=e;switch(a){case"translation":f&&(g.Vector3.FromArrayToRef(e,0,S),Z(S),S.toArray(n));break;case"rotation":4===e.length?g.Quaternion.FromArrayToRef(e,0,E):(n=new Array(4),g.Vector3.FromArrayToRef(e,0,I),g.Quaternion.FromEulerVectorToRef(I,E)),f&&(Y(E),V&&J(E)),E.toArray(n)}B.set(n,t*F)})),m=u.createBufferView(B),x=u.createAccessor(m,i,5126,b.outputs.length),l.push(x),v=l.length-1,T={interpolation:b.samplerInterpolation,input:_,output:v},n.samplers.push(T),y={sampler:n.samplers.length-1,target:{node:R,path:a}},n.channels.push(y)}},e._CreateBakedAnimation=function(t,n,r,o,i,a,s,u,c,l,h){var p,f,d=g.Quaternion.Identity(),m=null,x=null,_=null,v=null,T=null,y=null;l.min=g.Tools.FloatRound(o/a);for(var b=n.getKeys(),M=0,w=b.length;M<w;++M){if(y=null,_=b[M],M+1<w)if(v=b[M+1],_.value.equals&&_.value.equals(v.value)||_.value===v.value){if(0!==M)continue;y=_.frame}else y=v.frame;else{if(T=b[M-1],_.value.equals&&_.value.equals(T.value)||_.value===T.value)continue;y=i}if(y)for(var A=_.frame;A<=y;A+=s)if((f=g.Tools.FloatRound(A/a))!==m){m=f,x=f;var R={key:0,repeatCount:0,loopMode:n.loopMode};p=n._interpolate(A,R),e._SetInterpolatedValue(t,p,f,n,r,d,u,c,h)}}x&&(l.max=x)},e._ConvertFactorToVector3OrQuaternion=function(t,n,r,o,i){var a=e._GetBasePositionRotationOrScale(n,o,i),s=r.targetProperty.split("."),u=s?s[1]:"",c=i?g.Quaternion.FromArray(a).normalize():g.Vector3.FromArray(a);switch(u){case"x":case"y":case"z":c[u]=t;break;case"w":c.w=t;break;default:g.Tools.Error('glTFAnimation: Unsupported component name "'.concat(u,'"!'))}return c},e._SetInterpolatedValue=function(e,t,n,r,o,i,a,s,u){var c;a.push(n),"weights"!==o?(r.dataType===g.Animation.ANIMATIONTYPE_FLOAT&&(t=this._ConvertFactorToVector3OrQuaternion(t,e,r,o,u)),"rotation"===o?(u?i=t:(c=t,g.Quaternion.RotationYawPitchRollToRef(c.y,c.x,c.z,i)),s.push(i.asArray())):(c=t,s.push(c.asArray()))):s.push([t])},e._CreateLinearOrStepAnimation=function(t,n,r,o,i,a){for(var s=0,u=n.getKeys();s<u.length;s++){var c=u[s];o.push(c.frame/n.framePerSecond),e._AddKeyframeValue(c,n,i,r,t,a)}},e._CreateCubicSplineAnimation=function(t,n,r,o,i,a){n.getKeys().forEach((function(s){o.push(s.frame/n.framePerSecond),e._AddSplineTangent(ae.INTANGENT,i,r,"CUBICSPLINE",s,a),e._AddKeyframeValue(s,n,i,r,t,a),e._AddSplineTangent(ae.OUTTANGENT,i,r,"CUBICSPLINE",s,a)}))},e._GetBasePositionRotationOrScale=function(e,t,n){var r;if("rotation"===t)if(n){var o=e.rotationQuaternion;r=(null!=o?o:g.Quaternion.Identity()).asArray()}else{var i=e.rotation;r=(null!=i?i:g.Vector3.Zero()).asArray()}else if("translation"===t){var a=e.position;r=(null!=a?a:g.Vector3.Zero()).asArray()}else{var s=e.scaling;r=(null!=s?s:g.Vector3.One()).asArray()}return r},e._AddKeyframeValue=function(e,t,n,r,o,i){var a,s=t.dataType;if(s===g.Animation.ANIMATIONTYPE_VECTOR3){var u=e.value.asArray();if("rotation"===r){var c=g.Vector3.FromArray(u);u=g.Quaternion.RotationYawPitchRoll(c.y,c.x,c.z).asArray()}n.push(u)}else if(s===g.Animation.ANIMATIONTYPE_FLOAT){if("weights"===r)n.push([e.value]);else if(a=this._ConvertFactorToVector3OrQuaternion(e.value,o,t,r,i)){if("rotation"===r){var l=i?a:g.Quaternion.RotationYawPitchRoll(a.y,a.x,a.z).normalize();n.push(l.asArray())}n.push(a.asArray())}}else s===g.Animation.ANIMATIONTYPE_QUATERNION?n.push(e.value.normalize().asArray()):g.Tools.Error("glTFAnimation: Unsupported key frame values for animation!")},e._DeduceInterpolation=function(e,t,n){var r,o,i=!1;if("rotation"===t&&!n)return{interpolationType:"LINEAR",shouldBakeAnimation:!0};for(var a=0,s=e.length;a<s;++a)if((o=e[a]).inTangent||o.outTangent)if(r){if("CUBICSPLINE"!==r){r="LINEAR",i=!0;break}}else r="CUBICSPLINE";else if(r){if("CUBICSPLINE"===r||o.interpolation&&1===o.interpolation&&"STEP"!==r){r="LINEAR",i=!0;break}}else r=o.interpolation&&1===o.interpolation?"STEP":"LINEAR";return r||(r="LINEAR"),{interpolationType:r,shouldBakeAnimation:i}},e._AddSplineTangent=function(e,t,n,r,o,i){var a,s=e===ae.INTANGENT?o.inTangent:o.outTangent;if("CUBICSPLINE"===r){if("rotation"===n)if(s)if(i)a=s.asArray();else{var u=s;a=g.Quaternion.RotationYawPitchRoll(u.y,u.x,u.z).asArray()}else a=[0,0,0,0];else a="weights"===n?s?[s]:[0]:s?s.asArray():[0,0,0];t.push(a)}},e._CalculateMinMaxKeyFrames=function(e){var t=1/0,n=-1/0;return e.forEach((function(e){t=Math.min(t,e.frame),n=Math.max(n,e.frame)})),{min:t,max:n}},e}();function ce(e,t,n,r,o,i){var a={attributes:{},influence:e.influence,name:e.name},s=t.geometry;if(!s)return g.Tools.Warn("Attempted to export morph target data from a mesh without geometry. This should not happen."),a;var u=i?-1:1,c=g.Vector3.Zero(),l=0;if(e.hasPositions){var h=e.getPositions(),p=s.getVerticesData(g.VertexBuffer.PositionKind);if(p){var f=new Float32Array(p.length),d=[1/0,1/0,1/0],m=[-1/0,-1/0,-1/0];l=p.length/3;for(var x=0;x<l;++x){var _=g.Vector3.FromArray(p,3*x);g.Vector3.FromArray(h,3*x).subtractToRef(_,c),c.x*=u,d[0]=Math.min(d[0],c.x),m[0]=Math.max(m[0],c.x),d[1]=Math.min(d[1],c.y),m[1]=Math.max(m[1],c.y),d[2]=Math.min(d[2],c.z),m[2]=Math.max(m[2],c.z),f[3*x]=c.x,f[3*x+1]=c.y,f[3*x+2]=c.z}var v=n.createBufferView(f,12),T=n.createAccessor(v,"VEC3",5126,h.length/3,0,{min:d,max:m});o.push(T),a.attributes.POSITION=o.length-1}else g.Tools.Warn("Morph target positions for mesh ".concat(t.name," were not exported. Mesh does not have position vertex data"))}if(e.hasNormals){var y=e.getNormals(),b=s.getVerticesData(g.VertexBuffer.NormalKind);if(b){var M=new Float32Array(b.length);for(l=b.length/3,x=0;x<l;++x){var w=g.Vector3.FromArray(b,3*x).normalize();g.Vector3.FromArray(y,3*x).normalize().subtractToRef(w,c),M[3*x]=c.x*u,M[3*x+1]=c.y,M[3*x+2]=c.z}v=n.createBufferView(M,12),T=n.createAccessor(v,"VEC3",5126,y.length/3,0),o.push(T),a.attributes.NORMAL=o.length-1}else g.Tools.Warn("Morph target normals for mesh ".concat(t.name," were not exported. Mesh does not have normals vertex data"))}if(e.hasTangents){var A=e.getTangents(),R=s.getVerticesData(g.VertexBuffer.TangentKind);if(R){l=R.length/4;var C=new Float32Array(3*l);for(x=0;x<l;++x){var E=g.Vector3.FromArray(R,4*x);Q(E);var I=g.Vector3.FromArray(A,3*x);Q(I),I.subtractToRef(E,c),C[3*x]=c.x*u,C[3*x+1]=c.y,C[3*x+2]=c.z}v=n.createBufferView(C,12),T=n.createAccessor(v,"VEC3",5126,l,0),o.push(T),a.attributes.TANGENT=o.length-1}else g.Tools.Warn("Morph target tangents for mesh ".concat(t.name," were not exported. Mesh does not have tangents vertex data"))}if(e.hasColors){var S=e.getColors(),V=s.getVerticesData(g.VertexBuffer.ColorKind),F=s.getVertexBuffer(g.VertexBuffer.ColorKind);if(V&&F){var B=F.getSize();l=V.length/B;var O=new Float32Array(l*B);for(x=0;x<l;++x)if(3===B){var N=g.Vector3.FromArray(V,x*B);g.Vector3.FromArray(S,x*B).subtractToRef(N,c),O[3*x]=c.x,O[3*x+1]=c.y,O[3*x+2]=c.z}else if(4===B){var P=new g.Vector4;N=g.Vector4.FromArray(V,x*B),g.Vector4.FromArray(S,x*B).subtractToRef(N,P),O[4*x]=P.x,O[4*x+1]=P.y,O[4*x+2]=P.z,O[4*x+3]=P.w}else g.Tools.Warn("Unsupported number of components for color attribute: ".concat(B));v=n.createBufferView(O,4*B),T=n.createAccessor(v,3===B?"VEC3":"VEC4",5126,l,0),o.push(T),a.attributes.COLOR_0=o.length-1}else g.Tools.Warn("Morph target colors for mesh ".concat(t.name," were not exported. Mesh does not have colors vertex data"))}return a}var le=function(){function e(e,t){this._indicesAccessorMap=new Map,this._vertexBufferViewMap=new Map,this._vertexAccessorMap=new Map,this._remappedBufferView=new Map,this._meshMorphTargetMap=new Map,this._vertexMapColorAlpha=new Map,this._exportedNodes=new Set,this._meshMap=new Map,this.convertedToRightHandedBuffers=new Map,this.convertToRightHanded=e,this.wasAddedByNoopNode=t}return e.prototype.getIndicesAccessor=function(e,t,n,r,o){var i,a,s,u;return null===(u=null===(s=null===(a=null===(i=this._indicesAccessorMap.get(e))||void 0===i?void 0:i.get(t))||void 0===a?void 0:a.get(n))||void 0===s?void 0:s.get(r))||void 0===u?void 0:u.get(o)},e.prototype.setIndicesAccessor=function(e,t,n,r,o,i){var a=this._indicesAccessorMap.get(e);a||(a=new Map,this._indicesAccessorMap.set(e,a));var s=a.get(t);s||(s=new Map,a.set(t,s));var u=s.get(n);u||(u=new Map,s.set(n,u));var c=u.get(r);c||(c=new Map,u.set(r,c)),c.set(o,i)},e.prototype.pushExportedNode=function(e){this._exportedNodes.has(e)||this._exportedNodes.add(e)},e.prototype.getNodesSet=function(){return this._exportedNodes},e.prototype.getVertexBufferView=function(e){return this._vertexBufferViewMap.get(e)},e.prototype.setVertexBufferView=function(e,t){this._vertexBufferViewMap.set(e,t)},e.prototype.setRemappedBufferView=function(e,t,n){this._remappedBufferView.set(e,new Map),this._remappedBufferView.get(e).set(t,n)},e.prototype.getRemappedBufferView=function(e,t){var n;return null===(n=this._remappedBufferView.get(e))||void 0===n?void 0:n.get(t)},e.prototype.getVertexAccessor=function(e,t,n){var r,o;return null===(o=null===(r=this._vertexAccessorMap.get(e))||void 0===r?void 0:r.get(t))||void 0===o?void 0:o.get(n)},e.prototype.setVertexAccessor=function(e,t,n,r){var o=this._vertexAccessorMap.get(e);o||(o=new Map,this._vertexAccessorMap.set(e,o));var i=o.get(t);i||(i=new Map,o.set(t,i)),i.set(n,r)},e.prototype.hasVertexColorAlpha=function(e){return this._vertexMapColorAlpha.get(e)||!1},e.prototype.setHasVertexColorAlpha=function(e,t){return this._vertexMapColorAlpha.set(e,t)},e.prototype.getMesh=function(e){return this._meshMap.get(e)},e.prototype.setMesh=function(e,t){this._meshMap.set(e,t)},e.prototype.bindMorphDataToMesh=function(e,t){var n=this._meshMorphTargetMap.get(e)||[];this._meshMorphTargetMap.set(e,n),-1===n.indexOf(t)&&n.push(t)},e.prototype.getMorphTargetsFromMesh=function(e){return this._meshMorphTargetMap.get(e)},e}(),he=function(){function e(e,t){if(void 0===e&&(e=g.EngineStore.LastCreatedScene),this._glTF={asset:{generator:"Babylon.js v".concat(g.Engine.Version),version:"2.0"}},this._animations=[],this._accessors=[],this._bufferViews=[],this._cameras=[],this._images=[],this._materials=[],this._meshes=[],this._nodes=[],this._samplers=[],this._scenes=[],this._skins=[],this._textures=[],this._imageData={},this._shouldUseGlb=!1,this._materialExporter=new D(this),this._extensions={},this._bufferManager=new se,this._shouldExportNodeMap=new Map,this._nodeMap=new Map,this._materialMap=new Map,this._camerasMap=new Map,this._nodesCameraMap=new Map,this._skinMap=new Map,this._nodesSkinMap=new Map,this._materialNeedsUVsSet=new Set,!e)throw new Error("No scene available to export");this._babylonScene=e,this._options=b({shouldExportNode:function(){return!0},shouldExportAnimation:function(){return!0},metadataSelector:function(e){var t;return null===(t=null==e?void 0:e.gltf)||void 0===t?void 0:t.extras},animationSampleRate:1/60,exportWithoutWaitingForScene:!1,exportUnusedUVs:!1,removeNoopRootNodes:!0,includeCoordinateSystemConversionNodes:!1,meshCompressionMethod:"None"},t),this._loadExtensions()}return e.prototype._ApplyExtension=function(e,t,n,r){var o=this;if(n>=t.length)return Promise.resolve(e);var i=r(t[n],e);return i?i.then((function(e){return w(o,void 0,void 0,(function(){var o;return A(this,(function(i){switch(i.label){case 0:return e?[4,this._ApplyExtension(e,t,n+1,r)]:[3,2];case 1:return o=i.sent(),[3,3];case 2:o=null,i.label=3;case 3:return[2,o]}}))}))})):this._ApplyExtension(e,t,n+1,r)},e.prototype._ApplyExtensions=function(t,n){for(var r=[],o=0,i=e._ExtensionNames;o<i.length;o++){var a=i[o];r.push(this._extensions[a])}return this._ApplyExtension(t,r,0,n)},e.prototype._extensionsPostExportNodeAsync=function(e,t,n,r,o){var i=this;return this._ApplyExtensions(t,(function(t,a){return t.postExportNodeAsync&&t.postExportNodeAsync(e,a,n,r,o,i._bufferManager)}))},e.prototype._extensionsPostExportMaterialAsync=function(e,t,n){return this._ApplyExtensions(t,(function(t,r){return t.postExportMaterialAsync&&t.postExportMaterialAsync(e,r,n)}))},e.prototype._extensionsPostExportMaterialAdditionalTexturesAsync=function(t,n,r){return w(this,void 0,void 0,(function(){var o,i=this;return A(this,(function(a){switch(a.label){case 0:return o=[],[4,Promise.all(e._ExtensionNames.map((function(e){return w(i,void 0,void 0,(function(){var i,a;return A(this,(function(s){switch(s.label){case 0:return(i=this._extensions[e]).postExportMaterialAdditionalTexturesAsync?[4,i.postExportMaterialAdditionalTexturesAsync(t,n,r)]:[3,2];case 1:a=s.sent(),o.push.apply(o,a),s.label=2;case 2:return[2]}}))}))})))];case 1:return a.sent(),[2,o]}}))}))},e.prototype._extensionsPostExportTextures=function(t,n,r){for(var o=0,i=e._ExtensionNames;o<i.length;o++){var a=i[o],s=this._extensions[a];s.postExportTexture&&s.postExportTexture(t,n,r)}},e.prototype._extensionsPostExportMeshPrimitive=function(t){for(var n=0,r=e._ExtensionNames;n<r.length;n++){var o=r[n],i=this._extensions[o];i.postExportMeshPrimitive&&i.postExportMeshPrimitive(t,this._bufferManager,this._accessors)}},e.prototype._extensionsPreGenerateBinaryAsync=function(){return w(this,void 0,void 0,(function(){var t,n,r,o;return A(this,(function(i){switch(i.label){case 0:t=0,n=e._ExtensionNames,i.label=1;case 1:return t<n.length?(r=n[t],(o=this._extensions[r]).preGenerateBinaryAsync?[4,o.preGenerateBinaryAsync(this._bufferManager)]:[3,3]):[3,4];case 2:i.sent(),i.label=3;case 3:return t++,[3,1];case 4:return[2]}}))}))},e.prototype._forEachExtensions=function(t){for(var n=0,r=e._ExtensionNames;n<r.length;n++){var o=r[n],i=this._extensions[o];i.enabled&&t(i)}},e.prototype._extensionsOnExporting=function(){var e=this;this._forEachExtensions((function(t){var n,r,o;t.wasUsed&&((n=e._glTF).extensionsUsed||(n.extensionsUsed=[]),-1===e._glTF.extensionsUsed.indexOf(t.name)&&e._glTF.extensionsUsed.push(t.name),t.required&&((r=e._glTF).extensionsRequired||(r.extensionsRequired=[]),-1===e._glTF.extensionsRequired.indexOf(t.name)&&e._glTF.extensionsRequired.push(t.name)),(o=e._glTF).extensions||(o.extensions={}),t.onExporting&&t.onExporting())}))},e.prototype._loadExtensions=function(){for(var t=0,n=e._ExtensionNames;t<n.length;t++){var r=n[t],o=e._ExtensionFactories[r](this);this._extensions[r]=o}},e.prototype.dispose=function(){for(var e in this._extensions)this._extensions[e].dispose()},Object.defineProperty(e.prototype,"options",{get:function(){return this._options},enumerable:!1,configurable:!0}),e.RegisterExtension=function(t,n,r){void 0===r&&(r=100),e.UnregisterExtension(t)&&g.Tools.Warn("Extension with the name ".concat(t," already exists")),e._ExtensionFactories[t]=n;var o=null!=r?r:0;e._ExtensionOrders[t]=o;for(var i=e._ExtensionNames.length,a=0;a<e._ExtensionNames.length;a++){var s=e._ExtensionNames[a];if(o<e._ExtensionOrders[s]){i=a;break}}e._ExtensionNames.splice(i,0,t)},e.UnregisterExtension=function(t){if(!e._ExtensionFactories[t])return!1;delete e._ExtensionFactories[t],delete e._ExtensionOrders[t];var n=e._ExtensionNames.indexOf(t);return-1!==n&&e._ExtensionNames.splice(n,1),!0},e.prototype._generateJSON=function(e,t,n){var r={byteLength:e};return r.byteLength&&(this._glTF.buffers=[r]),this._nodes&&this._nodes.length&&(this._glTF.nodes=this._nodes),this._meshes&&this._meshes.length&&(this._glTF.meshes=this._meshes),this._scenes&&this._scenes.length&&(this._glTF.scenes=this._scenes,this._glTF.scene=0),this._cameras&&this._cameras.length&&(this._glTF.cameras=this._cameras),this._bufferViews&&this._bufferViews.length&&(this._glTF.bufferViews=this._bufferViews),this._accessors&&this._accessors.length&&(this._glTF.accessors=this._accessors),this._animations&&this._animations.length&&(this._glTF.animations=this._animations),this._materials&&this._materials.length&&(this._glTF.materials=this._materials),this._textures&&this._textures.length&&(this._glTF.textures=this._textures),this._samplers&&this._samplers.length&&(this._glTF.samplers=this._samplers),this._skins&&this._skins.length&&(this._glTF.skins=this._skins),this._images&&this._images.length&&(this._glTF.images=this._images),this._shouldUseGlb||(r.uri=t+".bin"),n?JSON.stringify(this._glTF,null,2):JSON.stringify(this._glTF)},e.prototype.generateGLTFAsync=function(e){return w(this,void 0,void 0,(function(){var t,n,r,o,i,a,s;return A(this,(function(u){switch(u.label){case 0:return[4,this._generateBinaryAsync()];case 1:if(t=u.sent(),this._extensionsOnExporting(),n=this._generateJSON(t.byteLength,e,!0),r=new Blob([t],{type:"application/octet-stream"}),o=e+".gltf",i=e+".bin",(a=new v).files[o]=n,a.files[i]=r,this._imageData)for(s in this._imageData)a.files[s]=this._imageData[s];return[2,a]}}))}))},e.prototype._generateBinaryAsync=function(){return w(this,void 0,void 0,(function(){return A(this,(function(e){switch(e.label){case 0:return[4,this._exportSceneAsync()];case 1:return e.sent(),[4,this._extensionsPreGenerateBinaryAsync()];case 2:return e.sent(),[2,this._bufferManager.generateBinary(this._bufferViews)]}}))}))},e.prototype._getPadding=function(e){var t=e%4;return 0===t?t:4-t},e.prototype.generateGLBAsync=function(e){return w(this,void 0,void 0,(function(){var t,n,r,o,i,a,s,u,c,l,h,p,f,d;return A(this,(function(m){switch(m.label){case 0:return this._shouldUseGlb=!0,[4,this._generateBinaryAsync()];case 1:if(t=m.sent(),this._extensionsOnExporting(),n=this._generateJSON(t.byteLength),r=e+".glb",o=n.length,"undefined"!=typeof TextEncoder&&(a=new TextEncoder,i=a.encode(n),o=i.length),s=this._getPadding(o),u=this._getPadding(t.byteLength),c=28+o+s+t.byteLength+u,(l=new oe(c)).writeUInt32(1179937895),l.writeUInt32(2),l.writeUInt32(c),l.writeUInt32(o+s),l.writeUInt32(1313821514),i)l.writeTypedArray(i);else for(h="_".charCodeAt(0),f=0;f<o;++f)(p=n.charCodeAt(f))!=n.codePointAt(f)?l.writeUInt8(h):l.writeUInt8(p);for(f=0;f<s;++f)l.writeUInt8(32);for(l.writeUInt32(t.byteLength+u),l.writeUInt32(5130562),l.writeTypedArray(t),f=0;f<u;++f)l.writeUInt8(0);return(d=new v).files[r]=new Blob([l.getOutputData()],{type:"application/octet-stream"}),[2,d]}}))}))},e.prototype._setNodeTransformation=function(e,t,n){var r;if(t.getPivotPoint().equalsWithEpsilon(K,g.Epsilon)||g.Tools.Warn("Pivot points are not supported in the glTF serializer"),!t.position.equalsWithEpsilon(K,g.Epsilon)){var o=g.TmpVectors.Vector3[0].copyFrom(t.position);n&&Z(o),e.translation=o.asArray()}t.scaling.equalsWithEpsilon(q,g.Epsilon)||(e.scale=t.scaling.asArray());var i=(null===(r=t.rotationQuaternion)||void 0===r?void 0:r.clone())||g.Quaternion.FromEulerAngles(t.rotation.x,t.rotation.y,t.rotation.z);i.equalsWithEpsilon(W,g.Epsilon)||(n&&Y(i),e.rotation=i.normalize().asArray())},e.prototype._setCameraTransformation=function(e,t,n){var r=g.TmpVectors.Vector3[0],o=g.TmpVectors.Quaternion[0],i=t.getWorldMatrix();if(t.parent){var a=t.parent.getWorldMatrix().invertToRef(g.TmpVectors.Matrix[0]);i.multiplyToRef(a,g.TmpVectors.Matrix[1]).decompose(void 0,o,r)}else i.decompose(void 0,o,r);r.equalsWithEpsilon(K,g.Epsilon)||(n&&Z(r),e.translation=r.asArray()),n&&Y(o),this._babylonScene.useRightHandedSystem||J(o),o.equalsWithEpsilon(W,g.Epsilon)||(e.rotation=o.asArray())},e.prototype._listAvailableCameras=function(){for(var e=0,t=this._babylonScene.cameras;e<t.length;e++){var n=t[e],r={type:n.mode===g.Camera.PERSPECTIVE_CAMERA?"perspective":"orthographic"};if(n.name&&(r.name=n.name),"perspective"===r.type)r.perspective={aspectRatio:n.getEngine().getAspectRatio(n),yfov:n.fovMode===g.Camera.FOVMODE_VERTICAL_FIXED?n.fov:n.fov*n.getEngine().getAspectRatio(n),znear:n.minZ,zfar:n.maxZ};else if("orthographic"===r.type){var o=n.orthoLeft&&n.orthoRight?.5*(n.orthoRight-n.orthoLeft):.5*n.getEngine().getRenderWidth(),i=n.orthoBottom&&n.orthoTop?.5*(n.orthoTop-n.orthoBottom):.5*n.getEngine().getRenderHeight();r.orthographic={xmag:o,ymag:i,znear:n.minZ,zfar:n.maxZ}}this._camerasMap.set(n,r)}},e.prototype._exportAndAssignCameras=function(){for(var e=0,t=Array.from(this._camerasMap.values());e<t.length;e++){var n=t[e],r=this._nodesCameraMap.get(n);if(void 0!==r){this._cameras.push(n);for(var o=0,i=r;o<i.length;o++)i[o].camera=this._cameras.length-1}}},e.prototype._listAvailableSkeletons=function(){for(var e=0,t=this._babylonScene.skeletons;e<t.length;e++){var n=t[e];n.bones.length<=0||this._skinMap.set(n,{joints:[]})}},e.prototype._exportAndAssignSkeletons=function(e){for(var t,n=function(n){if(n.bones.length<=0)return"continue";var o=r._skinMap.get(n);if(null==o)return"continue";for(var i={},a=-1,s=0;s<n.bones.length;++s){var u=n.bones[s];-1!==(h=null!==(t=u.getIndex())&&void 0!==t?t:s)&&(i[h]=u,h>a&&(a=h))}for(var c,l=[],h=0;h<=a;++h){var p=(u=i[h]).getTransformNode(),f=p?r._nodeMap.get(p):void 0;if(void 0!==f){o.joints.push(f);var d=u.getAbsoluteInverseBindMatrix().clone();e.has(p)&&(c=d,L.invertToRef(g.TmpVectors.Matrix[0]).multiplyToRef(c,c).multiplyToRef(L,c)),l.push(d)}else g.Tools.Warn("Exporting a bone without a linked transform node is currently unsupported.")}var m=r._nodesSkinMap.get(o);if(o.joints.length>0&&void 0!==m){var x=new Float32Array(16*l.length);l.forEach((function(e,t){x.set(e.m,16*t)}));var _=r._bufferManager.createBufferView(x);r._accessors.push(r._bufferManager.createAccessor(_,"MAT4",5126,l.length)),o.inverseBindMatrices=r._accessors.length-1,r._skins.push(o);for(var v=r._skins.length-1,T=0,y=m;T<y.length;T++)y[T].skin=v}},r=this,o=0,i=this._babylonScene.skeletons;o<i.length;o++)n(i[o])},e.prototype._exportSceneAsync=function(){return w(this,void 0,void 0,(function(){var e,t,n,r,o,i,a,s,u,c,l,h,p,f,d,m,g,x,_,v,T,y,b;return A(this,(function(M){switch(M.label){case 0:for(e={nodes:[]},this._babylonScene.metadata&&(t=this._options.metadataSelector(this._babylonScene.metadata))&&(e.extras=t),n=new Array,r=new Array,o=new Array,i=0,a=this._babylonScene.rootNodes;i<a.length;i++)s=a[i],this._options.removeNoopRootNodes&&!this._options.includeCoordinateSystemConversionNodes&&z(s,this._babylonScene.useRightHandedSystem)?o.push.apply(o,s.getChildren()):this._babylonScene.useRightHandedSystem?n.push(s):r.push(s);return this._listAvailableCameras(),this._listAvailableSkeletons(),u=new le(!0,!1),l=(c=(T=e.nodes).push).apply,h=[T],[4,this._exportNodesAsync(r,u)];case 1:return l.apply(c,h.concat([M.sent()])),p=new le(!1,!1),d=(f=(y=e.nodes).push).apply,m=[y],[4,this._exportNodesAsync(n,p)];case 2:return d.apply(f,m.concat([M.sent()])),g=new le(!1,!0),_=(x=(b=e.nodes).push).apply,v=[b],[4,this._exportNodesAsync(o,g)];case 3:return _.apply(x,v.concat([M.sent()])),e.nodes.length&&this._scenes.push(e),this._exportAndAssignCameras(),this._exportAndAssignSkeletons(u.getNodesSet()),this._babylonScene.animationGroups.length&&ue._CreateNodeAndMorphAnimationFromAnimationGroups(this._babylonScene,this._animations,this._nodeMap,this._bufferManager,this._bufferViews,this._accessors,this._animationSampleRate,u.getNodesSet(),this._options.shouldExportAnimation),[2]}}))}))},e.prototype._shouldExportNode=function(e){var t=this._shouldExportNodeMap.get(e);return void 0===t&&(t=this._options.shouldExportNode(e),this._shouldExportNodeMap.set(e,t)),t},e.prototype._exportNodesAsync=function(e,t){return w(this,void 0,void 0,(function(){var n,r,o,i;return A(this,(function(a){switch(a.label){case 0:n=new Array,this._exportBuffers(e,t),r=0,o=e,a.label=1;case 1:return r<o.length?(i=o[r],[4,this._exportNodeAsync(i,n,t)]):[3,4];case 2:a.sent(),a.label=3;case 3:return r++,[3,1];case 4:return[2,n]}}))}))},e.prototype._collectBuffers=function(e,t,n,r,o){if(this._shouldExportNode(e)&&e instanceof g.AbstractMesh&&e.geometry){var i=e.geometry.getVertexBuffers();if(i)for(var a in i)if(X(a)){var s=i[a];o.setHasVertexColorAlpha(s,e.hasVertexAlpha);var u=s._buffer,c=t.get(u)||[];t.set(u,c),-1===c.indexOf(s)&&c.push(s);var l=n.get(s)||[];n.set(s,l),-1===l.indexOf(e)&&l.push(e)}var h=e.morphTargetManager;if(h)for(var p=0;p<h.numTargets;p++){var f=h.getTarget(p);l=r.get(f)||[],r.set(f,l),-1===l.indexOf(e)&&l.push(e)}}for(var d=0,m=e.getChildren();d<m.length;d++){var x=m[d];this._collectBuffers(x,t,n,r,o)}},e.prototype._exportBuffers=function(e,t){for(var n=new Map,r=new Map,o=new Map,i=0,a=e;i<a.length;i++){var s=a[i];this._collectBuffers(s,n,r,o,t)}for(var u=Array.from(n.keys()),c=function(e){var o=e.getData();if(!o)throw new Error("Buffer data is not available");var i=n.get(e);if(!i)return"continue";var a=i[0].byteStride;if(i.some((function(e){return e.byteStride!==a})))throw new Error("Vertex buffers pointing to the same buffer must have the same byte stride");for(var s=function(e){if(e instanceof Array){var t=new Float32Array(e);return new Uint8Array(t.buffer,t.byteOffset,t.byteLength)}return ArrayBuffer.isView(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):new Uint8Array(e)}(o).slice(),u=function(e){var t=r.get(e),n=j(e,t),o=n.byteOffset,i=n.byteStride,a=n.componentCount,u=n.type,c=n.count,h=n.normalized;switch(n.kind){case g.VertexBuffer.NormalKind:case g.VertexBuffer.TangentKind:(0,g.EnumerateFloatValues)(s,o,i,a,u,c,h,(function(e){var t=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);if(t>0){var n=1/t;e[0]*=n,e[1]*=n,e[2]*=n}}));break;case g.VertexBuffer.ColorKind:var p=t.filter((function(e){return e.material instanceof g.StandardMaterial||null==e.material})).length;if(0==p)break;if(p!=t.length){g.Logger.Warn("Not converting vertex color space, as buffer is shared by StandardMaterials and other material types. Results may look incorrect.");break}u==g.VertexBuffer.UNSIGNED_BYTE&&g.Logger.Warn("Converting uint8 vertex colors to linear space. Results may look incorrect.");var f=new g.Color3,d=new g.Color4,m=l._babylonScene.getEngine().useExactSrgbConversions;(0,g.EnumerateFloatValues)(s,o,i,a,u,c,h,(function(e){3===e.length?(f.fromArray(e,0),f.toLinearSpaceToRef(f,m),f.toArray(e,0)):(d.fromArray(e,0),d.toLinearSpaceToRef(d,m),d.toArray(e,0))}))}},c=0,h=i;c<h.length;c++)u(F=h[c]);if(t.convertToRightHanded){for(var p=0,f=i;p<f.length;p++){var d=j(F=f[p],r.get(F)),m=d.byteOffset,x=d.byteStride,_=d.componentCount,v=d.type,T=d.count,y=d.normalized;switch(C=d.kind){case g.VertexBuffer.PositionKind:case g.VertexBuffer.NormalKind:case g.VertexBuffer.TangentKind:(0,g.EnumerateFloatValues)(s,m,x,_,v,T,y,(function(e){e[0]=-e[0]}))}}t.convertedToRightHandedBuffers.set(e,s)}var b=l._bufferManager.createBufferView(s,a);t.setVertexBufferView(e,b);for(var M=new Map,w=0,A=i;w<A.length;w++){var R=j(F=A[w],r.get(F)),C=R.kind,E=R.totalVertices;switch(C){case g.VertexBuffer.MatricesIndicesKind:case g.VertexBuffer.MatricesIndicesExtraKind:if(F.type==g.VertexBuffer.FLOAT){var I=F.getFloatData(E);null!==I&&M.set(F,I)}}}0!==M.size&&g.Logger.Warn("Joint indices conversion needed: some joint indices are stored as floats in Babylon but GLTF requires UNSIGNED BYTES. We will perform the conversion but this might lead to unused data in the buffer.");for(var S=0,V=Array.from(M.keys());S<V.length;S++){var F=V[S],B=M.get(F);if(B){for(var O=B.some((function(e){return e>=256})),N=new(O?Uint16Array:Uint8Array)(B.length),P=0;P<B.length;P++)N[P]=B[P];var U=l._bufferManager.createBufferView(N,4*(O?2:1));t.setRemappedBufferView(e,F,U)}}},l=this,h=0,p=u;h<p.length;h++)c(p[h]);for(var f=0,d=Array.from(o.keys());f<d.length;f++){var m=d[f],x=o.get(m);if(x)for(var _=ce(m,x[0],this._bufferManager,this._bufferViews,this._accessors,t.convertToRightHanded),v=0,T=x;v<T.length;v++){var y=T[v];t.bindMorphDataToMesh(y,_)}}},e.prototype._exportNodeAsync=function(e,t,n){return w(this,void 0,void 0,(function(){var r,o,i,a,s,u,c,l,h=this;return A(this,(function(p){switch(p.label){case 0:return void 0!==(r=this._nodeMap.get(e))?(t.includes(r)||t.push(r),[2]):[4,this._createNodeAsync(e,n)];case 1:(o=p.sent())&&(r=this._nodes.length,this._nodes.push(o),this._nodeMap.set(e,r),n.pushExportedNode(e),t.push(r),i={name:"runtime animations",channels:[],samplers:[]},a=[],this._babylonScene.animationGroups.length||(ue._CreateMorphTargetAnimationFromMorphTargetAnimations(e,i,a,this._nodeMap,this._nodes,this._bufferManager,this._bufferViews,this._accessors,this._animationSampleRate,n.convertToRightHanded,this._options.shouldExportAnimation),e.animations.length&&ue._CreateNodeAnimationFromNodeAnimations(e,i,a,this._nodeMap,this._nodes,this._bufferManager,this._bufferViews,this._accessors,this._animationSampleRate,n.convertToRightHanded,this._options.shouldExportAnimation)),i.channels.length&&i.samplers.length&&this._animations.push(i),a.forEach((function(e){e.channels.length&&e.samplers.length&&h._animations.push(e)}))),s=o?[]:t,u=0,c=e.getChildren(),p.label=2;case 2:return u<c.length?(l=c[u],[4,this._exportNodeAsync(l,s,n)]):[3,5];case 3:p.sent(),p.label=4;case 4:return u++,[3,2];case 5:return o&&s.length&&(o.children=s),[2]}}))}))},e.prototype._createNodeAsync=function(e,t){return w(this,void 0,void 0,(function(){var n,r,o,i,a,s,u,c,l,h,p,f;return A(this,(function(d){switch(d.label){case 0:return this._shouldExportNode(e)?(n={},e.name&&(n.name=e.name),e.metadata&&(r=this._options.metadataSelector(e.metadata))&&(n.extras=r),e instanceof g.TransformNode?(this._setNodeTransformation(n,e,t.convertToRightHanded),e instanceof g.AbstractMesh?(o=e instanceof g.InstancedMesh?e.sourceMesh:e).subMeshes&&o.subMeshes.length>0?(i=n,[4,this._exportMeshAsync(o,t)]):[3,2]:[3,3]):[3,3]):[2,null];case 1:i.mesh=d.sent(),d.label=2;case 2:e.skeleton&&void 0!==(a=this._skinMap.get(e.skeleton))&&(void 0===this._nodesSkinMap.get(a)&&this._nodesSkinMap.set(a,[]),null===(h=this._nodesSkinMap.get(a))||void 0===h||h.push(n)),d.label=3;case 3:if(e instanceof g.TargetCamera&&(s=this._camerasMap.get(e))){if(void 0===this._nodesCameraMap.get(s)&&this._nodesCameraMap.set(s,[]),this._setCameraTransformation(n,e,t.convertToRightHanded),null!==(u=e.parent)&&ee(e,u)&&void 0!==(c=this._nodeMap.get(u)))return l=this._nodes[c],$(n,l),null===(p=this._nodesCameraMap.get(s))||void 0===p||p.push(l),[2,null];null===(f=this._nodesCameraMap.get(s))||void 0===f||f.push(n)}return[4,this._extensionsPostExportNodeAsync("exportNodeAsync",n,e,this._nodeMap,t.convertToRightHanded)];case 4:return d.sent()?[2,n]:(g.Logger.Warn("Not exporting node ".concat(e.name)),[2,null])}}))}))},e.prototype._exportIndices=function(e,t,n,r,o,i,a,s,u){var c=null;u.mode=function(e){switch(e){case g.Material.TriangleFillMode:return 4;case g.Material.TriangleStripDrawMode:return 5;case g.Material.TriangleFanDrawMode:return 6;case g.Material.PointListDrawMode:case g.Material.PointFillMode:return 0;case g.Material.LineLoopDrawMode:return 2;case g.Material.LineListDrawMode:return 1;case g.Material.LineStripDrawMode:return 3}throw new Error("Unknown fill mode: ".concat(e))}(i);var l=a!==g.Material.CounterClockWiseSideOrientation&&function(e){switch(e){case g.Material.TriangleFillMode:case g.Material.TriangleStripDrawMode:case g.Material.TriangleFanDrawMode:return!0}return!1}(i);if(l){if(i===g.Material.TriangleStripDrawMode||i===g.Material.TriangleFanDrawMode)throw new Error("Triangle strip/fan fill mode is not implemented");var h=t?new Uint32Array(r):new Uint16Array(r);if(e)for(var p=0;p+2<r;p+=3)h[p]=e[n+p]+o,h[p+1]=e[n+p+2]+o,h[p+2]=e[n+p+1]+o;else for(p=0;p+2<r;p+=3)h[p]=p,h[p+1]=p+2,h[p+2]=p+1;c=h}else if(e&&0!==o){for(h=t?new Uint32Array(r):new Uint16Array(r),p=0;p<r;p++)h[p]=e[n+p]+o;c=h}else e&&(c=function(e,t,n,r){var o=e;return 0===t&&n===e.length||(o=Array.isArray(e)?e.slice(t,t+n):e.subarray(t,t+n)),o instanceof Int32Array?new Uint32Array(o.buffer,o.byteOffset,o.length):Array.isArray(o)?r?new Uint32Array(o):new Uint16Array(o):o}(e,n,r,t));if(c){var f=s.getIndicesAccessor(e,n,r,o,l);if(void 0===f){var d=this._bufferManager.createBufferView(c),m=t?5125:5123;this._accessors.push(this._bufferManager.createAccessor(d,"SCALAR",m,r,0)),f=this._accessors.length-1,s.setIndicesAccessor(e,n,r,o,l,f)}u.indices=f}},e.prototype._exportVertexBuffer=function(e,t,n,r,o,i){var a=e.getKind();if(X(a)&&(!a.startsWith("uv")||this._options.exportUnusedUVs||t&&this._materialNeedsUVsSet.has(t))){var s=o.getVertexAccessor(e,n,r);if(void 0===s){var u=o.convertedToRightHandedBuffers.get(e._buffer)||e._buffer.getData(),c=a===g.VertexBuffer.PositionKind?function(e,t,n,r){var o=t.byteOffset,i=t.byteStride,a=t.type,s=t.normalized,u=t.getSize(),c=new Array(u).fill(1/0),l=new Array(u).fill(-1/0);return(0,g.EnumerateFloatValues)(e,o+n*i,i,u,a,r*u,s,(function(e){for(var t=0;t<u;t++)c[t]=Math.min(c[t],e[t]),l[t]=Math.max(l[t],e[t])})),{min:c,max:l}}(u,e,n,r):void 0,l=(a===g.VertexBuffer.MatricesIndicesKind||a===g.VertexBuffer.MatricesIndicesExtraKind)&&e.type===g.VertexBuffer.FLOAT,h=l?g.VertexBuffer.UNSIGNED_BYTE:e.type,p=l?void 0:e.normalized,f=l?o.getRemappedBufferView(e._buffer,e):o.getVertexBufferView(e._buffer),d=e.byteOffset+n*e.byteStride;this._accessors.push(this._bufferManager.createAccessor(f,function(e,t){if(e==g.VertexBuffer.ColorKind)return t?"VEC4":"VEC3";switch(e){case g.VertexBuffer.PositionKind:case g.VertexBuffer.NormalKind:return"VEC3";case g.VertexBuffer.TangentKind:case g.VertexBuffer.MatricesIndicesKind:case g.VertexBuffer.MatricesIndicesExtraKind:case g.VertexBuffer.MatricesWeightsKind:case g.VertexBuffer.MatricesWeightsExtraKind:return"VEC4";case g.VertexBuffer.UVKind:case g.VertexBuffer.UV2Kind:case g.VertexBuffer.UV3Kind:case g.VertexBuffer.UV4Kind:case g.VertexBuffer.UV5Kind:case g.VertexBuffer.UV6Kind:return"VEC2"}throw new Error("Unknown kind ".concat(e))}(a,o.hasVertexColorAlpha(e)),h,r,d,c,p)),s=this._accessors.length-1,o.setVertexAccessor(e,n,r,s)}i.attributes[function(e){switch(e){case g.VertexBuffer.PositionKind:return"POSITION";case g.VertexBuffer.NormalKind:return"NORMAL";case g.VertexBuffer.TangentKind:return"TANGENT";case g.VertexBuffer.ColorKind:return"COLOR_0";case g.VertexBuffer.UVKind:return"TEXCOORD_0";case g.VertexBuffer.UV2Kind:return"TEXCOORD_1";case g.VertexBuffer.UV3Kind:return"TEXCOORD_2";case g.VertexBuffer.UV4Kind:return"TEXCOORD_3";case g.VertexBuffer.UV5Kind:return"TEXCOORD_4";case g.VertexBuffer.UV6Kind:return"TEXCOORD_5";case g.VertexBuffer.MatricesIndicesKind:return"JOINTS_0";case g.VertexBuffer.MatricesIndicesExtraKind:return"JOINTS_1";case g.VertexBuffer.MatricesWeightsKind:return"WEIGHTS_0";case g.VertexBuffer.MatricesWeightsExtraKind:return"WEIGHTS_1"}throw new Error("Unknown kind: ".concat(e))}(a)]=s}},e.prototype._exportMaterialAsync=function(e,t,n,r){return w(this,void 0,void 0,(function(){var o,i;return A(this,(function(a){switch(a.label){case 0:return void 0!==(o=this._materialMap.get(e))?[3,8]:(i=t&&Object.keys(t).some((function(e){return e.startsWith("uv")})),(e=e instanceof g.MultiMaterial?e.subMaterials[n.materialIndex]:e)instanceof g.PBRBaseMaterial?[4,this._materialExporter.exportPBRMaterialAsync(e,i)]:[3,2]);case 1:return o=a.sent(),[3,7];case 2:return e instanceof g.StandardMaterial?[4,this._materialExporter.exportStandardMaterialAsync(e,i)]:[3,4];case 3:return o=a.sent(),[3,7];case 4:return e instanceof g.OpenPBRMaterial?[4,this._materialExporter.exportOpenPBRMaterialAsync(e,i)]:[3,6];case 5:return o=a.sent(),[3,7];case 6:return g.Logger.Warn("Unsupported material '".concat(e.name,"' with type ").concat(e.getClassName())),[2];case 7:this._materialMap.set(e,o),a.label=8;case 8:return r.material=o,[2]}}))}))},e.prototype._exportMeshAsync=function(e,t){return w(this,void 0,void 0,(function(){var n,r,o,i,a,s,u,c,l,h,p,f,d,m,x,_,v,T,y,b,M,w,C,E,I,S,V,F,B,O,N,P,U,k;return A(this,(function(A){switch(A.label){case 0:if(void 0!==(n=t.getMesh(e)))return[2,n];if(r={primitives:[]},n=this._meshes.length,this._meshes.push(r),t.setMesh(e,n),o=e.isUnIndexed?null:e.getIndices(),i=null===(B=e.geometry)||void 0===B?void 0:B.getVertexBuffers(),a=t.getMorphTargetsFromMesh(e),s=e instanceof g.LinesMesh,u=e instanceof g.GreasedLineBaseMesh,c=e.subMeshes,!(i&&c&&c.length>0))return[3,7];l=0,h=c,A.label=1;case 1:return l<h.length?(p=h[l],f={attributes:{}},d=p.getMaterial()||this._babylonScene.defaultMaterial,u?(v={name:d.name},T=e,m=g.Color3.White(),x=null!==(N=null===(O=T.material)||void 0===O?void 0:O.alpha)&&void 0!==N?N:1,(!(_=null!==(U=null===(P=T.greasedLineMaterial)||void 0===P?void 0:P.color)&&void 0!==U?U:m).equalsWithEpsilon(m,g.Epsilon)||x<1)&&(v.pbrMetallicRoughness={baseColorFactor:R(R([],_.asArray(),!0),[x],!1)}),this._materials.push(v),f.material=this._materials.length-1,[3,5]):[3,2]):[3,7];case 2:return s?(v={name:d.name},(!(T=e).color.equalsWithEpsilon(g.Color3.White(),g.Epsilon)||T.alpha<1)&&(v.pbrMetallicRoughness={baseColorFactor:R(R([],T.color.asArray(),!0),[T.alpha],!1)}),this._materials.push(v),f.material=this._materials.length-1,[3,5]):[3,3];case 3:return[4,this._exportMaterialAsync(d,i,p,f)];case 4:A.sent(),A.label=5;case 5:for(y=s||u?g.Material.LineListDrawMode:null!==(k=e.overrideRenderingFillMode)&&void 0!==k?k:d.fillMode,b=d._getEffectiveOrientation(e),t.wasAddedByNoopNode&&!e.getScene().useRightHandedSystem&&(b=b===g.Material.ClockWiseSideOrientation?g.Material.CounterClockWiseSideOrientation:g.Material.ClockWiseSideOrientation),this._exportIndices(o,o?(0,g.AreIndices32Bits)(o,p.indexCount,p.indexStart,p.verticesStart):p.verticesCount>65535,o?p.indexStart:p.verticesStart,o?p.indexCount:p.verticesCount,-p.verticesStart,y,b,t,f),M=0,w=Object.values(i);M<w.length;M++)C=w[M],this._exportVertexBuffer(C,d,p.verticesStart,p.verticesCount,t,f);if(a)for(f.targets=[],E=0,I=a;E<I.length;E++)F=I[E],f.targets.push(F.attributes);r.primitives.push(f),this._extensionsPostExportMeshPrimitive(f),A.label=6;case 6:return l++,[3,1];case 7:if(a)for(r.weights=[],r.extras||(r.extras={}),r.extras.targetNames=[],S=0,V=a;S<V.length;S++)F=V[S],r.weights.push(F.influence),r.extras.targetNames.push(F.name);return[2,n]}}))}))},e._ExtensionNames=new Array,e._ExtensionFactories={},e._ExtensionOrders={},e}(),pe=function(){function e(){}return e.GLTFAsync=function(e,t,n){return w(this,void 0,void 0,(function(){var r,o;return A(this,(function(i){switch(i.label){case 0:return n&&n.exportWithoutWaitingForScene?[3,2]:[4,e.whenReadyAsync()];case 1:i.sent(),i.label=2;case 2:return[4,(r=new he(e,n)).generateGLTFAsync(t.replace(/\.[^/.]+$/,""))];case 3:return o=i.sent(),r.dispose(),[2,o]}}))}))},e.GLBAsync=function(e,t,n){return w(this,void 0,void 0,(function(){var r,o;return A(this,(function(i){switch(i.label){case 0:return n&&n.exportWithoutWaitingForScene?[3,2]:[4,e.whenReadyAsync()];case 1:i.sent(),i.label=2;case 2:return[4,(r=new he(e,n)).generateGLBAsync(t.replace(/\.[^/.]+$/,""))];case 3:return o=i.sent(),r.dispose(),[2,o]}}))}))},e}(),fe="EXT_mesh_gpu_instancing";function de(e,t){for(var n=new Float32Array(3*t),r=0;r<t;r++)n[3*r+0]=e[4*r+0],n[3*r+1]=e[4*r+1],n[3*r+2]=e[4*r+2];return n}var me=function(){function e(e){this.name=fe,this.enabled=!0,this.required=!1,this._instanceColorWarned=!1,this._wasUsed=!1,this._exporter=e}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportNodeAsync=function(e,t,n,r,o,i){return w(this,void 0,void 0,(function(){var e=this;return A(this,(function(r){switch(r.label){case 0:return[4,new Promise((function(r){var a,s;if(t&&n instanceof g.Mesh&&n.hasThinInstances&&e._exporter){e._wasUsed=!0;for(var u=g.Vector3.Zero(),c=g.Quaternion.Identity(),l=g.Vector3.One(),h=n.thinInstanceGetWorldMatrices(),p=g.TmpVectors.Vector3[2],f=g.TmpVectors.Quaternion[1],d=g.TmpVectors.Vector3[3],m=!1,x=!1,_=!1,v=new Float32Array(3*n.thinInstanceCount),T=new Float32Array(4*n.thinInstanceCount),y=new Float32Array(3*n.thinInstanceCount),b=0,M=0,w=h;M<w.length;M++)w[M].decompose(d,f,p),o&&(Z(p),Y(f)),v.set(p.asArray(),3*b),T.set(f.normalize().asArray(),4*b),y.set(d.asArray(),3*b),m=m||!p.equalsWithEpsilon(u),x=x||!f.equalsWithEpsilon(c),_=_||!d.equalsWithEpsilon(l),b++;var A={attributes:{}};m&&(A.attributes.TRANSLATION=e._buildAccessor(v,"VEC3",n.thinInstanceCount,i)),x&&(A.attributes.ROTATION=e._buildAccessor(T,"VEC4",n.thinInstanceCount,i)),_&&(A.attributes.SCALE=e._buildAccessor(y,"VEC3",n.thinInstanceCount,i));var R=null===(s=null===(a=n._userThinInstanceBuffersStorage)||void 0===a?void 0:a.data)||void 0===s?void 0:s.instanceColor;if(R){var C=n.thinInstanceCount;n.hasVertexAlpha&&R.length===4*C?(e._instanceColorWarned||(g.Logger.Warn("EXT_mesh_gpu_instancing: Exporting instance colors as RGB, alpha channel of instance color is not exported"),e._instanceColorWarned=!0),R=de(R,C)):R.length===4*C&&(R=de(R,C)),R.length===3*C&&(A.attributes._COLOR_0=e._buildAccessor(R,"VEC3",C,i))}t.extensions=t.extensions||{},t.extensions[fe]=A}r(t)}))];case 1:return[2,r.sent()]}}))}))},e.prototype._buildAccessor=function(e,t,n,r){var o=r.createBufferView(e),i=r.createAccessor(o,t,5126,n);return this._exporter._accessors.push(i),this._exporter._accessors.length-1},e}();he.RegisterExtension(fe,(function(e){return new me(e)}));var ge="KHR_draco_mesh_compression",xe=function(){function e(e){this.name=ge,this.required=!0,this._bufferViewsUsed=new Set,this._accessorsUsed=new Set,this._encodePromises=[],this._wasUsed=!1,this.enabled="Draco"===e.options.meshCompressionMethod&&g.DracoEncoder.DefaultAvailable}return Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.dispose=function(){},e.prototype.postExportMeshPrimitive=function(e,t,n){var r=this;if(this.enabled)if(4===e.mode||5===e.mode){var o=[],i=[],a=null;if(void 0!==e.indices){var s=n[e.indices],u=t.getBufferView(s);a=t.getData(u).slice(),o.push(u),i.push(s)}for(var c,l=[],h=0,p=Object.entries(e.attributes);h<p.length;h++){var f=p[h],d=f[0],m=(s=n[f[1]],u=t.getBufferView(s),H(s.type)),x=(0,g.GetTypedArrayData)(t.getData(u),m,s.componentType,s.byteOffset||0,u.byteStride||(0,g.GetTypeByteLength)(s.componentType)*m,s.count,!0);l.push({kind:d,dracoName:(c=d,"POSITION"===c?"POSITION":"NORMAL"===c?"NORMAL":c.startsWith("COLOR")?"COLOR":c.startsWith("TEXCOORD")?"TEX_COORD":"GENERIC"),size:H(s.type),data:x}),o.push(u),i.push(s)}var _={method:e.targets?"MESH_SEQUENTIAL_ENCODING":"MESH_EDGEBREAKER_ENCODING"},v=g.DracoEncoder.Default._encodeAsync(l,a,_).then((function(n){var a={bufferView:-1,attributes:n.attributeIds},s=t.createBufferView(n.data);t.setBufferView(a,s);for(var u=0,c=o;u<c.length;u++){var l=c[u];r._bufferViewsUsed.add(l)}for(var h=0,p=i;h<p.length;h++){var f=p[h];r._accessorsUsed.add(f)}e.extensions||(e.extensions={}),e.extensions[ge]=a})).catch((function(e){g.Logger.Error("KHR_draco_mesh_compression: Failed to export Draco-encoded primitive. Resulting glTF may be invalid. "+e.message)}));this._encodePromises.push(v),this._wasUsed=!0}else g.Logger.Warn("Cannot compress primitive with mode "+e.mode+".")},e.prototype.preGenerateBinaryAsync=function(e){return w(this,void 0,void 0,(function(){var t=this;return A(this,(function(n){switch(n.label){case 0:return this.enabled?[4,Promise.all(this._encodePromises)]:[2];case 1:return n.sent(),this._bufferViewsUsed.forEach((function(n){e.getPropertiesWithBufferView(n).every((function(e){return t._accessorsUsed.has(e)}))&&e.removeBufferView(n)})),this._bufferViewsUsed.clear(),this._accessorsUsed.clear(),[2]}}))}))},e}();he.RegisterExtension(ge,(function(e){return new xe(e)}));var _e="KHR_lights_punctual",ve={name:"",color:[1,1,1],intensity:1,range:Number.MAX_VALUE},Te={innerConeAngle:0,outerConeAngle:Math.PI/4},ye=g.Vector3.Backward(),be=function(){function e(e){this.name=_e,this.enabled=!0,this.required=!1,this._exporter=e}return e.prototype.dispose=function(){this._lights=null},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return!!this._lights},enumerable:!1,configurable:!0}),e.prototype.onExporting=function(){this._exporter._glTF.extensions[_e]=this._lights},e.prototype.postExportNodeAsync=function(e,t,n,r,o){return w(this,void 0,void 0,(function(){var i=this;return A(this,(function(a){switch(a.label){case 0:return[4,new Promise((function(a){if(n instanceof g.Light){var s=n.getTypeID()==g.Light.LIGHTTYPEID_POINTLIGHT?"point":n.getTypeID()==g.Light.LIGHTTYPEID_DIRECTIONALLIGHT?"directional":n.getTypeID()==g.Light.LIGHTTYPEID_SPOTLIGHT?"spot":null;if(!(s&&n instanceof g.ShadowLight))return g.Logger.Warn("".concat(e,": Light ").concat(n.name," is not supported in ").concat(_e)),void a(t);if(n.falloffType!==g.Light.FALLOFF_GLTF&&g.Logger.Warn("".concat(e,": Light falloff for ").concat(n.name," does not match the ").concat(_e," specification!")),!n.position.equalsToFloats(0,0,0)){var u=g.TmpVectors.Vector3[0].copyFrom(n.position);o&&Z(u),t.translation=u.asArray()}if("point"!==s){var c=n.direction.normalizeToRef(g.TmpVectors.Vector3[0]);o&&Z(c);var l=g.Quaternion.FromUnitVectorsToRef(ye,c,g.TmpVectors.Quaternion[0]);g.Quaternion.IsIdentity(l)||(t.rotation=l.asArray())}var h={type:s,name:n.name,color:n.diffuse.asArray(),intensity:n.intensity,range:n.range};if(te(h,ve),"spot"===s){var p=n;h.spot={innerConeAngle:p.innerAngle/2,outerConeAngle:p.angle/2},te(h.spot,Te)}i._lights||(i._lights={lights:[]}),i._lights.lights.push(h);var f={light:i._lights.lights.length-1},d=n.parent;if(d&&ee(n,d)){var m=r.get(d);if(m){var x=i._exporter._nodes[m];return $(t,x),x.extensions||(x.extensions={}),x.extensions[_e]=f,void a(null)}}t.extensions||(t.extensions={}),t.extensions[_e]=f,a(t)}else a(t)}))];case 1:return[2,a.sent()]}}))}))},e}();he.RegisterExtension(_e,(function(e){return new be(e)}));var Me="EXT_lights_area",we={name:"",color:[1,1,1],intensity:1,size:1},Ae={aspect:1},Re=g.Vector3.Backward(),Ce=function(){function e(e){this.name=Me,this.enabled=!0,this.required=!1,this._exporter=e}return e.prototype.dispose=function(){this._lights=null},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return!!this._lights},enumerable:!1,configurable:!0}),e.prototype.onExporting=function(){this._exporter._glTF.extensions[Me]=this._lights},e.prototype.postExportNodeAsync=function(e,t,n,r,o){return w(this,void 0,void 0,(function(){var i=this;return A(this,(function(a){switch(a.label){case 0:return[4,new Promise((function(a){if(n instanceof g.Light){var s=n.getTypeID()==g.Light.LIGHTTYPEID_RECT_AREALIGHT?"rect":null;if(!s)return g.Logger.Warn("".concat(e,": Light ").concat(n.name," is not supported in ").concat(Me)),void a(t);var u=n;if(u.falloffType!==g.Light.FALLOFF_GLTF&&g.Logger.Warn("".concat(e,": Light falloff for ").concat(n.name," does not match the ").concat(Me," specification!")),!u.position.equalsToFloats(0,0,0)){var c=g.TmpVectors.Vector3[0].copyFrom(u.position);o&&Z(c),t.translation=c.asArray()}var l=g.Vector3.Forward();o&&Z(l);var h=g.Quaternion.FromUnitVectorsToRef(Re,l,g.TmpVectors.Quaternion[0]);g.Quaternion.IsIdentity(h)||(t.rotation=h.asArray());var p={type:s,name:u.name,color:u.diffuse.asArray(),intensity:u.intensity,size:u.height,rect:{aspect:u.width/u.height}};te(p,we),p.rect&&te(p.rect,Ae),i._lights||(i._lights={lights:[]}),i._lights.lights.push(p);var f={light:i._lights.lights.length-1},d=n.parent;if(d&&ee(u,d)){var m=r.get(d);if(m){var x=i._exporter._nodes[m];return $(t,x),x.extensions||(x.extensions={}),x.extensions[Me]=f,void a(null)}}t.extensions||(t.extensions={}),t.extensions[Me]=f,a(t)}else a(t)}))];case 1:return[2,a.sent()]}}))}))},e}();he.RegisterExtension(Me,(function(e){return new Ce(e)}));var Ee="KHR_materials_anisotropy";function Ie(e){return w(this,void 0,void 0,(function(){var t,n,r;return A(this,(function(o){switch(o.label){case 0:return t=e.getScene(),n=e.specularRoughnessAnisotropyTexture,r=e.geometryTangentTexture,n||r?[4,(0,g.MergeTexturesAsync)("AnisotropyTexture",(0,g.CreateRGBAConfiguration)(r?(0,g.CreateTextureInput)(r,0):(0,g.CreateConstantInput)(1),r?(0,g.CreateTextureInput)(r,1):(0,g.CreateConstantInput)(0),n?(0,g.CreateTextureInput)(n,0):(0,g.CreateConstantInput)(1)),t)]:[2,null];case 1:return[2,o.sent()]}}))}))}var Se=function(){function e(e){this.name=Ee,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._anisoTexturesMap={},this._exporter=e}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportMaterialAdditionalTexturesAsync=function(e,t,n){return w(this,void 0,void 0,(function(){var e,t,r;return A(this,(function(o){switch(o.label){case 0:return e=[],n instanceof g.PBRBaseMaterial?n.anisotropy.isEnabled&&!n.anisotropy.legacy?(n.anisotropy.texture&&e.push(n.anisotropy.texture),[2,e]):[3,5]:[3,1];case 1:return n instanceof g.OpenPBRMaterial&&n.specularRoughnessAnisotropy>0?(t=function(e){var t=e.specularRoughnessAnisotropyTexture,n=e.geometryTangentTexture,r=t&&t.getInternalTexture()?t.getInternalTexture().uniqueId:"NoStrength",o=n&&n.getInternalTexture()?n.getInternalTexture().uniqueId:"NoTangent";return"".concat(r,"_").concat(o)}(n),this._anisoTexturesMap[t]?(e.push(this._anisoTexturesMap[t]),[3,4]):[3,2]):[3,5];case 2:return[4,Ie(n)];case 3:(r=o.sent())&&(e.push(r),this._anisoTexturesMap[t]=r),o.label=4;case 4:return[2,e];case 5:return[2,[]]}}))}))},e.prototype.postExportMaterialAsync=function(e,t,n){var r=this;return new Promise((function(e){var o,i,a,s,u,c;if(n instanceof g.PBRBaseMaterial){if(!n.anisotropy.isEnabled||n.anisotropy.legacy)return void e(t);r._wasUsed=!0,t.extensions=t.extensions||{};var l=r._exporter._materialExporter.getTextureInfo(n.anisotropy.texture);null!==(v={anisotropyStrength:n.anisotropy.intensity,anisotropyRotation:n.anisotropy.angle,anisotropyTexture:null!=l?l:void 0}).anisotropyTexture&&r._exporter._materialNeedsUVsSet.add(n),t.extensions[Ee]=v}else if(n instanceof g.OpenPBRMaterial&&n.specularRoughnessAnisotropy>0){r._wasUsed=!0,t.extensions=t.extensions||{};var h=n.specularRoughnessTexture;n._useRoughnessFromMetallicTextureGreen&&(h=n.baseMetalnessTexture);var p=r._anisoTexturesMap[n.id];if(!h&&!p){var f=n.specularRoughness,d=n.specularRoughnessAnisotropy;if(!n._useGltfStyleAnisotropy){var m=(i=n.specularRoughness,c=(1-(a=n.specularRoughnessAnisotropy))*(u=(s=i*i)*Math.sqrt(2/(1+(1-a)*(1-a)))),{newBaseRoughness:Math.sqrt(c),newAnisotropyStrength:Math.min(Math.sqrt((u-s)/Math.max(1-s,1e-4)),1)});f=m.newBaseRoughness,d=m.newAnisotropyStrength}t.pbrMetallicRoughness&&(t.pbrMetallicRoughness.roughnessFactor=f);var x={anisotropyStrength:d,anisotropyRotation:n.geometryTangentAngle+.5*Math.PI,anisotropyTexture:void 0};return t.extensions[Ee]=x,e(t)}var _=p?r._exporter._materialExporter.getTextureInfo(p):null,v={anisotropyStrength:n.specularRoughnessAnisotropy,anisotropyRotation:n.geometryTangentAngle,anisotropyTexture:_||void 0,extensions:{}};n._useGltfStyleAnisotropy||(t.extensions.KHR_materials_openpbr={},(o=r._exporter._glTF).extensionsUsed||(o.extensionsUsed=[]),-1===r._exporter._glTF.extensionsUsed.indexOf("KHR_materials_openpbr")&&r._exporter._glTF.extensionsUsed.push("KHR_materials_openpbr")),r._exporter._materialNeedsUVsSet.add(n),t.extensions[Ee]=v}e(t)}))},e}();he.RegisterExtension(Ee,(function(e){return new Se(e)}));var Ve="KHR_materials_clearcoat";function Fe(e){return w(this,void 0,void 0,(function(){var t,n,r;return A(this,(function(o){switch(o.label){case 0:return t=e.getScene(),n=e.coatWeightTexture,r=e.coatRoughnessTexture,n||r?[4,(0,g.MergeTexturesAsync)("CoatTexture",(0,g.CreateRGBAConfiguration)(n?(0,g.CreateTextureInput)(n,0):(0,g.CreateConstantInput)(1),r?(0,g.CreateTextureInput)(r,e._useCoatRoughnessFromGreenChannel?1:0):(0,g.CreateConstantInput)(1)),t)]:[2,null];case 1:return[2,o.sent().getInternalTexture()]}}))}))}function Be(e,t){var n=new g.Texture(t.name,t.getScene());return n._texture=e,n.coordinatesIndex=t.coordinatesIndex,t instanceof g.Texture&&(n.uOffset=t.uOffset,n.vOffset=t.vOffset,n.uScale=t.uScale,n.vScale=t.vScale,n.wAng=t.wAng),n.wrapU=t.wrapU,n.wrapV=t.wrapV,n}var Oe=function(){function e(e){this.name=Ve,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._mergedTexturesMap={},this._cachedInternalTexturesMap={},this._exporter=e}return e.prototype.dispose=function(){for(var e=0,t=Object.keys(this._mergedTexturesMap);e<t.length;e++){var n=t[e];this._mergedTexturesMap[n].dispose()}this._mergedTexturesMap={};for(var r=0,o=Object.keys(this._cachedInternalTexturesMap);r<o.length;r++)n=o[r],this._cachedInternalTexturesMap[n].dispose();this._cachedInternalTexturesMap={}},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportMaterialAdditionalTexturesAsync=function(e,t,n){return w(this,void 0,void 0,(function(){var e,t,r,o;return A(this,(function(i){switch(i.label){case 0:return e=[],n instanceof g.PBRBaseMaterial?n.clearCoat.isEnabled?(n.clearCoat.texture&&e.push(n.clearCoat.texture),!n.clearCoat.useRoughnessFromMainTexture&&n.clearCoat.textureRoughness&&e.push(n.clearCoat.textureRoughness),n.clearCoat.bumpTexture&&e.push(n.clearCoat.bumpTexture),[2,e]):[3,5]:[3,1];case 1:return n instanceof g.OpenPBRMaterial&&n.coatWeight>0?(t=!1,n.coatWeightTexture?n.coatRoughnessTexture?n._useCoatRoughnessFromGreenChannel&&n.coatWeightTexture.getInternalTexture()===n.coatRoughnessTexture.getInternalTexture()?(e.push(n.coatWeightTexture),e.push(n.coatRoughnessTexture)):t=!0:e.push(n.coatWeightTexture):n.coatRoughnessTexture&&(n._useCoatRoughnessFromGreenChannel?e.push(n.coatRoughnessTexture):t=!0),t?(r=function(e){var t=e.coatWeightTexture,n=t&&t.getInternalTexture()?t.getInternalTexture().uniqueId:"NoCoat",r=e.coatRoughnessTexture,o=r&&r.getInternalTexture()?r.getInternalTexture().uniqueId:"NoRoughness";return"".concat(n,"_").concat(o)}(n),this._cachedInternalTexturesMap[r]?[3,3]:[4,Fe(n)]):[3,4]):[3,5];case 2:(o=i.sent())&&(this._cachedInternalTexturesMap[r]=o),i.label=3;case 3:this._cachedInternalTexturesMap[r]&&(n.coatWeightTexture&&(this._mergedTexturesMap[n.coatWeightTexture.uniqueId]=Be(this._cachedInternalTexturesMap[r],n.coatWeightTexture),e.push(this._mergedTexturesMap[n.coatWeightTexture.uniqueId])),n.coatRoughnessTexture&&(this._mergedTexturesMap[n.coatRoughnessTexture.uniqueId]=Be(this._cachedInternalTexturesMap[r],n.coatRoughnessTexture),e.push(this._mergedTexturesMap[n.coatRoughnessTexture.uniqueId]))),i.label=4;case 4:return n.geometryCoatNormalTexture&&e.push(n.geometryCoatNormalTexture),[2,e];case 5:return[2,[]]}}))}))},e.prototype.postExportMaterialAsync=function(e,t,n){var r=this;return new Promise((function(e){if(n instanceof g.PBRBaseMaterial){if(!n.clearCoat.isEnabled)return void e(t);r._wasUsed=!0,t.extensions=t.extensions||{};var o,i=r._exporter._materialExporter.getTextureInfo(n.clearCoat.texture);o=n.clearCoat.useRoughnessFromMainTexture?r._exporter._materialExporter.getTextureInfo(n.clearCoat.texture):r._exporter._materialExporter.getTextureInfo(n.clearCoat.textureRoughness),n.clearCoat.isTintEnabled&&g.Tools.Warn("Clear Color tint is not supported for glTF export. Ignoring for: ".concat(n.name)),n.clearCoat.remapF0OnInterfaceChange&&g.Tools.Warn("Clear Color F0 remapping is not supported for glTF export. Ignoring for: ".concat(n.name));var a=r._exporter._materialExporter.getTextureInfo(n.clearCoat.bumpTexture);null===(c={clearcoatFactor:n.clearCoat.intensity,clearcoatTexture:null!=i?i:void 0,clearcoatRoughnessFactor:n.clearCoat.roughness,clearcoatRoughnessTexture:null!=o?o:void 0,clearcoatNormalTexture:null!=a?a:void 0}).clearcoatTexture&&null===c.clearcoatRoughnessTexture&&null===c.clearcoatRoughnessTexture||r._exporter._materialNeedsUVsSet.add(n),t.extensions[Ve]=c}else if(n instanceof g.OpenPBRMaterial){if(0==n.coatWeight)return void e(t);r._wasUsed=!0,t.extensions=t.extensions||{};var s=null,u=void 0;n.coatWeightTexture&&(s=r._mergedTexturesMap[n.coatWeightTexture.uniqueId],u=r._exporter._materialExporter.getTextureInfo(s));var c,l=null,h=void 0;n.coatRoughnessTexture&&(l=r._mergedTexturesMap[n.coatRoughnessTexture.uniqueId],h=r._exporter._materialExporter.getTextureInfo(l)),n.coatColorTexture&&g.Tools.Warn("Clear Color tint is not supported for glTF export. Ignoring for: ".concat(n.name)),a=r._exporter._materialExporter.getTextureInfo(n.geometryCoatNormalTexture),null===(c={clearcoatFactor:n.coatWeight,clearcoatTexture:null!=u?u:void 0,clearcoatRoughnessFactor:n.coatRoughness,clearcoatRoughnessTexture:null!=h?h:void 0,clearcoatNormalTexture:null!=a?a:void 0}).clearcoatTexture&&null===c.clearcoatRoughnessTexture&&null===c.clearcoatRoughnessTexture||r._exporter._materialNeedsUVsSet.add(n),t.extensions[Ve]=c}e(t)}))},e}();he.RegisterExtension(Ve,(function(e){return new Oe(e)}));var Ne="KHR_materials_coat";function Pe(e){var t=e.coatRoughnessAnisotropyTexture,n=e.geometryCoatTangentTexture,r=t&&t.getInternalTexture()?t.getInternalTexture().uniqueId:"NoStrength",o=n&&n.getInternalTexture()?n.getInternalTexture().uniqueId:"NoTangent";return"".concat(r,"_").concat(o)}function Ue(e){return w(this,void 0,void 0,(function(){var t,n,r;return A(this,(function(o){switch(o.label){case 0:return t=e.getScene(),n=e.coatRoughnessAnisotropyTexture,r=e.geometryCoatTangentTexture,n||r?[4,(0,g.MergeTexturesAsync)("AnisotropyTexture",(0,g.CreateRGBAConfiguration)(r?(0,g.CreateTextureInput)(r,0):(0,g.CreateConstantInput)(1),r?(0,g.CreateTextureInput)(r,1):(0,g.CreateConstantInput)(0),n?(0,g.CreateTextureInput)(n,0):(0,g.CreateConstantInput)(1)),t)]:[2,null];case 1:return[2,o.sent()]}}))}))}function ke(e){return w(this,void 0,void 0,(function(){var t,n,r;return A(this,(function(o){switch(o.label){case 0:return t=e.getScene(),n=e.coatWeightTexture,r=e.coatRoughnessTexture,n||r?[4,(0,g.MergeTexturesAsync)("CoatTexture",(0,g.CreateRGBAConfiguration)(n?(0,g.CreateTextureInput)(n,0):(0,g.CreateConstantInput)(1),r?(0,g.CreateTextureInput)(r,e._useCoatRoughnessFromGreenChannel?1:0):(0,g.CreateConstantInput)(1)),t)]:[2,null];case 1:return[2,o.sent().getInternalTexture()]}}))}))}function De(e,t){var n=new g.Texture(t.name,t.getScene());return n._texture=e,n.coordinatesIndex=t.coordinatesIndex,t instanceof g.Texture&&(n.uOffset=t.uOffset,n.vOffset=t.vOffset,n.uScale=t.uScale,n.vScale=t.vScale,n.wAng=t.wAng),n.wrapU=t.wrapU,n.wrapV=t.wrapV,n}var Le=function(){function e(e){this.name=Ne,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._mergedTexturesMap={},this._cachedInternalTexturesMap={},this._exporter=e}return e.prototype.dispose=function(){for(var e=0,t=Object.keys(this._mergedTexturesMap);e<t.length;e++){var n=t[e];this._mergedTexturesMap[n].dispose()}this._mergedTexturesMap={};for(var r=0,o=Object.keys(this._cachedInternalTexturesMap);r<o.length;r++)n=o[r],this._cachedInternalTexturesMap[n].dispose();this._cachedInternalTexturesMap={}},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportMaterialAdditionalTexturesAsync=function(e,t,n){return w(this,void 0,void 0,(function(){var e,t,r,o,i;return A(this,(function(a){switch(a.label){case 0:return e=[],n instanceof g.PBRBaseMaterial?n.clearCoat.isEnabled?(n.clearCoat.texture&&e.push(n.clearCoat.texture),!n.clearCoat.useRoughnessFromMainTexture&&n.clearCoat.textureRoughness&&e.push(n.clearCoat.textureRoughness),n.clearCoat.bumpTexture&&e.push(n.clearCoat.bumpTexture),n.clearCoat.tintTexture&&e.push(n.clearCoat.tintTexture),[2,e]):[3,9]:[3,1];case 1:return n instanceof g.OpenPBRMaterial&&n.coatWeight>0?(t=!1,n.coatWeightTexture?n.coatRoughnessTexture?n._useCoatRoughnessFromGreenChannel&&n.coatWeightTexture.getInternalTexture()===n.coatRoughnessTexture.getInternalTexture()?(e.push(n.coatWeightTexture),e.push(n.coatRoughnessTexture)):t=!0:e.push(n.coatWeightTexture):n.coatRoughnessTexture&&(n._useCoatRoughnessFromGreenChannel?e.push(n.coatRoughnessTexture):t=!0),t?(o=function(e){var t=e.coatWeightTexture,n=t&&t.getInternalTexture()?t.getInternalTexture().uniqueId:"NoCoat",r=e.coatRoughnessTexture,o=r&&r.getInternalTexture()?r.getInternalTexture().uniqueId:"NoRoughness";return"".concat(n,"_").concat(o)}(n),this._cachedInternalTexturesMap[o]?[3,3]:[4,ke(n)]):[3,4]):[3,9];case 2:(r=a.sent())&&(this._cachedInternalTexturesMap[o]=r),a.label=3;case 3:this._cachedInternalTexturesMap[o]&&(n.coatWeightTexture&&(this._mergedTexturesMap[n.coatWeightTexture.uniqueId]=De(this._cachedInternalTexturesMap[o],n.coatWeightTexture),e.push(this._mergedTexturesMap[n.coatWeightTexture.uniqueId])),n.coatRoughnessTexture&&(this._mergedTexturesMap[n.coatRoughnessTexture.uniqueId]=De(this._cachedInternalTexturesMap[o],n.coatRoughnessTexture),e.push(this._mergedTexturesMap[n.coatRoughnessTexture.uniqueId]))),a.label=4;case 4:return n.geometryCoatNormalTexture&&e.push(n.geometryCoatNormalTexture),n.coatColorTexture&&e.push(n.coatColorTexture),n.coatRoughnessAnisotropy>0?(o=Pe(n),this._mergedTexturesMap[o]?(e.push(this._mergedTexturesMap[o]),[3,7]):[3,5]):[3,8];case 5:return[4,Ue(n)];case 6:(i=a.sent())&&(e.push(i),this._mergedTexturesMap[o]=i),a.label=7;case 7:case 8:return[2,e];case 9:return[2,[]]}}))}))},e.prototype.postExportMaterialAsync=function(e,t,n){var r=this;return new Promise((function(e){var o,i,a,s,u,c;if(n instanceof g.PBRBaseMaterial){if(!n.clearCoat.isEnabled)return void e(t);r._wasUsed=!0,t.extensions=t.extensions||{};var l,h=r._exporter._materialExporter.getTextureInfo(n.clearCoat.texture);l=n.clearCoat.useRoughnessFromMainTexture?r._exporter._materialExporter.getTextureInfo(n.clearCoat.texture):r._exporter._materialExporter.getTextureInfo(n.clearCoat.textureRoughness);var p=void 0;n.clearCoat.isTintEnabled&&(p=r._exporter._materialExporter.getTextureInfo(n.clearCoat.tintTexture));var f=r._exporter._materialExporter.getTextureInfo(n.clearCoat.bumpTexture),d=n.clearCoat.indexOfRefraction;null===(v={coatFactor:n.clearCoat.intensity,coatTexture:null!=h?h:void 0,coatRoughnessFactor:n.clearCoat.roughness,coatRoughnessTexture:null!=l?l:void 0,coatNormalTexture:null!=f?f:void 0,coatColorFactor:n.clearCoat.tintColor.asArray(),coatColorTexture:null!=p?p:void 0,coatIor:1.5!==d?d:void 0}).coatTexture&&null===v.coatRoughnessTexture&&null===v.coatRoughnessTexture&&null===v.coatColorTexture||r._exporter._materialNeedsUVsSet.add(n),t.extensions[Ne]=v}else if(n instanceof g.OpenPBRMaterial){if(0==n.coatWeight)return void e(t);r._wasUsed=!0,t.extensions=t.extensions||{};var m=null;h=void 0,n.coatWeightTexture&&(m=r._mergedTexturesMap[n.coatWeightTexture.uniqueId]?r._mergedTexturesMap[n.coatWeightTexture.uniqueId]:n.coatWeightTexture,h=r._exporter._materialExporter.getTextureInfo(m));var x=null,_=void 0;n.coatRoughnessTexture&&(x=r._mergedTexturesMap[n.coatRoughnessTexture.uniqueId]?r._mergedTexturesMap[n.coatRoughnessTexture.uniqueId]:n.coatRoughnessTexture,_=r._exporter._materialExporter.getTextureInfo(x)),f=r._exporter._materialExporter.getTextureInfo(n.geometryCoatNormalTexture),p=r._exporter._materialExporter.getTextureInfo(n.coatColorTexture),d=n.coatIor;var v,T=n.coatDarkening,y=n.coatRoughnessTexture,b=Pe(n),M=r._mergedTexturesMap[b],w=0,A=0,R=void 0;if(n.coatRoughnessAnisotropy>0){if(y||M){var C=M?r._exporter._materialExporter.getTextureInfo(M):null;w=n.coatRoughnessAnisotropy,A=n.geometryCoatTangentAngle,R=C||void 0}else{var E=n.coatRoughness,I=n.coatRoughnessAnisotropy;if(!n._useGltfStyleAnisotropy){var S=(i=n.coatRoughness,c=(1-(a=n.coatRoughnessAnisotropy))*(u=(s=i*i)*Math.sqrt(2/(1+(1-a)*(1-a)))),{newBaseRoughness:Math.sqrt(c),newAnisotropyStrength:Math.min(Math.sqrt((u-s)/Math.max(1-s,1e-4)),1)});E=S.newBaseRoughness,I=S.newAnisotropyStrength}t.pbrMetallicRoughness&&(t.pbrMetallicRoughness.roughnessFactor=E),w=I,A=n.geometryCoatTangentAngle+.5*Math.PI,R=void 0}n._useGltfStyleAnisotropy||(t.extensions.KHR_materials_openpbr={},(o=r._exporter._glTF).extensionsUsed||(o.extensionsUsed=[]),-1===r._exporter._glTF.extensionsUsed.indexOf("KHR_materials_openpbr")&&r._exporter._glTF.extensionsUsed.push("KHR_materials_openpbr"))}null===(v={coatFactor:n.coatWeight,coatTexture:null!=h?h:void 0,coatRoughnessFactor:n.coatRoughness,coatRoughnessTexture:null!=_?_:void 0,coatNormalTexture:null!=f?f:void 0,coatColorFactor:n.coatColor.asArray(),coatColorTexture:null!=p?p:void 0,coatIor:1.5!==d?d:void 0,coatDarkeningFactor:1!==T?T:void 0,coatAnisotropyRotation:A,coatAnisotropyStrength:w,coatAnisotropyTexture:R}).coatTexture&&null===v.coatRoughnessTexture&&null===v.coatRoughnessTexture&&null===v.coatAnisotropyTexture&&null===v.coatColorTexture||r._exporter._materialNeedsUVsSet.add(n),t.extensions[Ne]=v}e(t)}))},e}();he.RegisterExtension(Ne,(function(e){return new Le(e)}));var ze="KHR_materials_diffuse_transmission";function Ke(e,t){var n=t.subSurface,r=null;return n.translucencyIntensityTexture?r=n.translucencyIntensityTexture:n.thicknessTexture&&n.useMaskFromThicknessTexture&&(r=n.thicknessTexture),r&&!n.useGltfStyleTextures?(g.Logger.Warn("".concat(e,": Translucency intensity texture is not supported when useGltfStyleTextures = false. Ignoring for: ").concat(t.name),1),null):r}var We=function(){function e(e){this.name=ze,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportMaterialAdditionalTexturesAsync=function(e,t,n){return w(this,void 0,void 0,(function(){var t,r;return A(this,(function(o){return t=[],n instanceof g.PBRMaterial&&this._isExtensionEnabled(n)?((r=Ke(e,n))&&t.push(r),n.subSurface.translucencyColorTexture&&t.push(n.subSurface.translucencyColorTexture),[2,t]):[2,t]}))}))},e.prototype._isExtensionEnabled=function(e){if(e.unlit)return!1;var t=e.subSurface;return!!t.isTranslucencyEnabled&&!e.unlit&&!t.useAlbedoToTintTranslucency&&t.useGltfStyleTextures&&1===t.volumeIndexOfRefraction&&0===t.minimumThickness&&0===t.maximumThickness},e.prototype.postExportMaterialAsync=function(e,t,n){var r=this;return new Promise((function(o){var i,a;if(n instanceof g.PBRMaterial&&r._isExtensionEnabled(n)){r._wasUsed=!0;var s=n.subSurface,u=Ke(e,n),c=0==s.translucencyIntensity?void 0:s.translucencyIntensity,l=null!==(i=r._exporter._materialExporter.getTextureInfo(u))&&void 0!==i?i:void 0,h=!s.translucencyColor||s.translucencyColor.equalsFloats(1,1,1)?void 0:s.translucencyColor.asArray(),p=null!==(a=r._exporter._materialExporter.getTextureInfo(s.translucencyColorTexture))&&void 0!==a?a:void 0,f={diffuseTransmissionFactor:c,diffuseTransmissionTexture:l,diffuseTransmissionColorFactor:h,diffuseTransmissionColorTexture:p};(l||p)&&r._exporter._materialNeedsUVsSet.add(n),t.extensions=t.extensions||{},t.extensions[ze]=f}o(t)}))},e}();he.RegisterExtension(ze,(function(e){return new We(e)}));var qe="KHR_materials_dispersion",Ge=function(){function e(){this.name=qe,this.enabled=!0,this.required=!1,this._wasUsed=!1}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype._isExtensionEnabled=function(e){if(e.unlit)return!1;var t=e.subSurface;return!(!t.isRefractionEnabled&&!t.isDispersionEnabled)},e.prototype.postExportMaterialAsync=function(e,t,n){var r=this;return new Promise((function(e){if(n instanceof g.PBRMaterial&&r._isExtensionEnabled(n)){r._wasUsed=!0;var o={dispersion:n.subSurface.dispersion};t.extensions=t.extensions||{},t.extensions[qe]=o}e(t)}))},e}();he.RegisterExtension(qe,(function(){return new Ge}));var je="KHR_materials_emissive_strength",He=function(){function e(){this.name=je,this.enabled=!0,this.required=!1,this._wasUsed=!1}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportMaterialAsync=function(e,t,n){return w(this,void 0,void 0,(function(){var e=this;return A(this,(function(r){switch(r.label){case 0:return[4,new Promise((function(r){if(!(n instanceof g.PBRMaterial))return r(t);var o=n.emissiveColor.scale(n.emissiveIntensity),i=Math.max.apply(Math,o.asArray());if(i>1){t.emissiveFactor=o.scale(1/i).asArray(),e._wasUsed=!0;var a={emissiveStrength:i};t.extensions||(t.extensions={}),t.extensions[je]=a}else t.emissiveFactor=o.asArray();return r(t)}))];case 1:return[2,r.sent()]}}))}))},e}();he.RegisterExtension(je,(function(){return new He}));var Xe="KHR_materials_ior",Qe=function(){function e(){this.name=Xe,this.enabled=!0,this.required=!1,this._wasUsed=!1}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype._isExtensionEnabled=function(e){return!e.unlit&&null!=e.indexOfRefraction&&1.5!=e.indexOfRefraction},e.prototype.postExportMaterialAsync=function(e,t,n){var r=this;return new Promise((function(e){if(n instanceof g.PBRMaterial&&r._isExtensionEnabled(n)){r._wasUsed=!0;var o={ior:n.indexOfRefraction};t.extensions=t.extensions||{},t.extensions[Xe]=o}e(t)}))},e}();he.RegisterExtension(Xe,(function(e){return new Qe}));var Ze="KHR_materials_iridescence",Ye=function(){function e(e){this.name=Ze,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportMaterialAdditionalTexturesAsync=function(e,t,n){return w(this,void 0,void 0,(function(){var e;return A(this,(function(t){if(e=[],n instanceof g.PBRBaseMaterial){if(n.iridescence.isEnabled)return n.iridescence.texture&&e.push(n.iridescence.texture),n.iridescence.thicknessTexture&&n.iridescence.thicknessTexture!==n.iridescence.texture&&e.push(n.iridescence.thicknessTexture),[2,e]}else if(n instanceof g.OpenPBRMaterial&&n.thinFilmWeight>0)return n.thinFilmWeightTexture&&e.push(n.thinFilmWeightTexture),n.thinFilmThicknessTexture&&n.thinFilmThicknessTexture!==n.thinFilmWeightTexture&&e.push(n.thinFilmThicknessTexture),[2,e];return[2,[]]}))}))},e.prototype.postExportMaterialAsync=function(e,t,n){var r=this;return new Promise((function(e){if(n instanceof g.PBRBaseMaterial){if(!n.iridescence.isEnabled)return void e(t);r._wasUsed=!0,t.extensions=t.extensions||{};var o=r._exporter._materialExporter.getTextureInfo(n.iridescence.texture),i=r._exporter._materialExporter.getTextureInfo(n.iridescence.thicknessTexture);null===(a={iridescenceFactor:n.iridescence.intensity,iridescenceIor:n.iridescence.indexOfRefraction,iridescenceThicknessMinimum:n.iridescence.minimumThickness,iridescenceThicknessMaximum:n.iridescence.maximumThickness,iridescenceTexture:null!=o?o:void 0,iridescenceThicknessTexture:null!=i?i:void 0}).iridescenceTexture&&null===a.iridescenceThicknessTexture||r._exporter._materialNeedsUVsSet.add(n),t.extensions[Ze]=a}else if(n instanceof g.OpenPBRMaterial){if(n.thinFilmWeight<=0)return void e(t);r._wasUsed=!0,t.extensions=t.extensions||{};var a,s=r._exporter._materialExporter.getTextureInfo(n.thinFilmWeightTexture),u=r._exporter._materialExporter.getTextureInfo(n.thinFilmThicknessTexture);null===(a={iridescenceFactor:n.thinFilmWeight,iridescenceIor:n.thinFilmIor,iridescenceThicknessMinimum:1e3*n.thinFilmThicknessMin,iridescenceThicknessMaximum:1e3*n.thinFilmThickness,iridescenceTexture:null!=s?s:void 0,iridescenceThicknessTexture:null!=u?u:void 0}).iridescenceTexture&&null===a.iridescenceThicknessTexture||r._exporter._materialNeedsUVsSet.add(n),t.extensions[Ze]=a}e(t)}))},e}();he.RegisterExtension(Ze,(function(e){return new Ye(e)}));var Je="KHR_materials_sheen",$e=function(){function e(e){this.name=Je,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportMaterialAdditionalTexturesAsync=function(e,t,n){return w(this,void 0,void 0,(function(){return A(this,(function(e){return n instanceof g.PBRMaterial&&n.sheen.isEnabled&&n.sheen.texture?[2,[n.sheen.texture]]:[2,[]]}))}))},e.prototype.postExportMaterialAsync=function(e,t,n){return w(this,void 0,void 0,(function(){var e=this;return A(this,(function(r){switch(r.label){case 0:return[4,new Promise((function(r){var o,i,a,s;if(n instanceof g.PBRMaterial){if(!n.sheen.isEnabled)return void r(t);e._wasUsed=!0,null==t.extensions&&(t.extensions={});var u={sheenColorFactor:n.sheen.color.asArray(),sheenRoughnessFactor:null!==(o=n.sheen.roughness)&&void 0!==o?o:0};null===u.sheenColorTexture&&null===u.sheenRoughnessTexture||e._exporter._materialNeedsUVsSet.add(n),n.sheen.texture&&(u.sheenColorTexture=null!==(i=e._exporter._materialExporter.getTextureInfo(n.sheen.texture))&&void 0!==i?i:void 0),n.sheen.textureRoughness&&!n.sheen.useRoughnessFromMainTexture?u.sheenRoughnessTexture=null!==(a=e._exporter._materialExporter.getTextureInfo(n.sheen.textureRoughness))&&void 0!==a?a:void 0:n.sheen.texture&&n.sheen.useRoughnessFromMainTexture&&(u.sheenRoughnessTexture=null!==(s=e._exporter._materialExporter.getTextureInfo(n.sheen.texture))&&void 0!==s?s:void 0),t.extensions[Je]=u}r(t)}))];case 1:return[2,r.sent()]}}))}))},e}();he.RegisterExtension(Je,(function(e){return new $e(e)}));var et="KHR_materials_fuzz";function tt(e){return w(this,void 0,void 0,(function(){var t,n,r;return A(this,(function(o){switch(o.label){case 0:return t=e.getScene(),n=e.fuzzColorTexture,r=e.fuzzRoughnessTexture,n||r?[4,(0,g.MergeTexturesAsync)("FuzzTexture",(0,g.CreateRGBAConfiguration)(n?(0,g.CreateTextureInput)(n,0):(0,g.CreateConstantInput)(1),n?(0,g.CreateTextureInput)(n,1):(0,g.CreateConstantInput)(1),n?(0,g.CreateTextureInput)(n,2):(0,g.CreateConstantInput)(1),r?(0,g.CreateTextureInput)(r,e._useFuzzRoughnessFromTextureAlpha?3:0):(0,g.CreateConstantInput)(1)),t)]:[2,null];case 1:return[2,o.sent().getInternalTexture()]}}))}))}function nt(e,t){var n=new g.Texture(t.name,t.getScene());return n._texture=e,n.coordinatesIndex=t.coordinatesIndex,t instanceof g.Texture&&(n.uOffset=t.uOffset,n.vOffset=t.vOffset,n.uScale=t.uScale,n.vScale=t.vScale,n.wAng=t.wAng),n.wrapU=t.wrapU,n.wrapV=t.wrapV,n}var rt=function(){function e(e){this.name=et,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._mergedTexturesMap={},this._cachedInternalTexturesMap={},this._exporter=e}return e.prototype.dispose=function(){for(var e=0,t=Object.keys(this._mergedTexturesMap);e<t.length;e++){var n=t[e];this._mergedTexturesMap[n].dispose()}this._mergedTexturesMap={};for(var r=0,o=Object.keys(this._cachedInternalTexturesMap);r<o.length;r++)n=o[r],this._cachedInternalTexturesMap[n].dispose();this._cachedInternalTexturesMap={}},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportMaterialAdditionalTexturesAsync=function(e,t,n){return w(this,void 0,void 0,(function(){var e,t,r,o;return A(this,(function(i){switch(i.label){case 0:return n instanceof g.OpenPBRMaterial?(e=[],n.fuzzWeight>0?(n.fuzzWeightTexture&&e.push(n.fuzzWeightTexture),t=!1,n.fuzzRoughnessTexture&&(n._useFuzzRoughnessFromTextureAlpha?e.push(n.fuzzRoughnessTexture):t=!0),n.fuzzColorTexture&&!t&&e.push(n.fuzzColorTexture),t?(r=function(e){var t=e.fuzzColorTexture,n=t&&t.getInternalTexture()?t.getInternalTexture().uniqueId:"NoFuzzColor",r=e.fuzzRoughnessTexture,o=r&&r.getInternalTexture()?r.getInternalTexture().uniqueId:"NoFuzzRoughness";return"FuzzColor_".concat(n,"_FuzzRoughness_").concat(o)}(n),this._cachedInternalTexturesMap[r]?[3,2]:[4,tt(n)]):[3,3]):[3,3]):[3,4];case 1:(o=i.sent())&&(this._cachedInternalTexturesMap[r]=o),i.label=2;case 2:this._cachedInternalTexturesMap[r]&&(n.fuzzColorTexture&&(this._mergedTexturesMap[n.fuzzColorTexture.uniqueId]=nt(this._cachedInternalTexturesMap[r],n.fuzzColorTexture),e.push(this._mergedTexturesMap[n.fuzzColorTexture.uniqueId])),n.fuzzRoughnessTexture&&(this._mergedTexturesMap[n.fuzzRoughnessTexture.uniqueId]=nt(this._cachedInternalTexturesMap[r],n.fuzzRoughnessTexture),e.push(this._mergedTexturesMap[n.fuzzRoughnessTexture.uniqueId]))),i.label=3;case 3:return[2,e];case 4:return[2,[]]}}))}))},e.prototype.postExportMaterialAsync=function(e,t,n){return w(this,void 0,void 0,(function(){var e=this;return A(this,(function(r){switch(r.label){case 0:return[4,new Promise((function(r){var o,i,a;if(n instanceof g.OpenPBRMaterial){if(0==n.fuzzWeight)return void r(t);e._wasUsed=!0,null==t.extensions&&(t.extensions={});var s={fuzzFactor:n.fuzzWeight,fuzzColorFactor:n.fuzzColor.asArray(),fuzzRoughnessFactor:n.fuzzRoughness};n.fuzzWeightTexture&&(s.fuzzTexture=null!==(o=e._exporter._materialExporter.getTextureInfo(n.fuzzWeightTexture))&&void 0!==o?o:void 0);var u=null;n.fuzzColorTexture&&(u=e._mergedTexturesMap[n.fuzzColorTexture.uniqueId]?e._mergedTexturesMap[n.fuzzColorTexture.uniqueId]:n.fuzzColorTexture,s.fuzzColorTexture=null!==(i=e._exporter._materialExporter.getTextureInfo(u))&&void 0!==i?i:void 0);var c=null;n.fuzzRoughnessTexture&&(c=e._mergedTexturesMap[n.fuzzRoughnessTexture.uniqueId]?e._mergedTexturesMap[n.fuzzRoughnessTexture.uniqueId]:n.fuzzRoughnessTexture,s.fuzzRoughnessTexture=null!==(a=e._exporter._materialExporter.getTextureInfo(c))&&void 0!==a?a:void 0),null===s.fuzzColorTexture&&null===s.fuzzRoughnessTexture||e._exporter._materialNeedsUVsSet.add(n),t.extensions[et]=s}r(t)}))];case 1:return[2,r.sent()]}}))}))},e}();he.RegisterExtension(et,(function(e){return new rt(e)}));var ot="KHR_materials_specular",it=function(){function e(e){this.name=ot,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportMaterialAdditionalTexturesAsync=function(e,t,n){return w(this,void 0,void 0,(function(){var e;return A(this,(function(t){return e=[],n instanceof g.PBRMaterial&&this._isExtensionEnabled(n)?(n.metallicReflectanceTexture&&e.push(n.metallicReflectanceTexture),n.reflectanceTexture&&e.push(n.reflectanceTexture),[2,e]):[2,e]}))}))},e.prototype._isExtensionEnabled=function(e){return!e.unlit&&(null!=e.metallicF0Factor&&1!=e.metallicF0Factor||null!=e.metallicReflectanceColor&&!e.metallicReflectanceColor.equalsFloats(1,1,1)||this._hasTexturesExtension(e))},e.prototype._hasTexturesExtension=function(e){return null!=e.metallicReflectanceTexture||null!=e.reflectanceTexture},e.prototype.postExportMaterialAsync=function(e,t,n){var r=this;return new Promise((function(e){var o,i,a,s,u;if(n instanceof g.PBRMaterial&&r._isExtensionEnabled(n)){r._wasUsed=!0,t.extensions=t.extensions||{};var c=null!==(o=r._exporter._materialExporter.getTextureInfo(n.metallicReflectanceTexture))&&void 0!==o?o:void 0,l=null!==(i=r._exporter._materialExporter.getTextureInfo(n.reflectanceTexture))&&void 0!==i?i:void 0,h={specularFactor:1==n.metallicF0Factor?void 0:n.metallicF0Factor,specularTexture:c,specularColorFactor:n.metallicReflectanceColor.equalsFloats(1,1,1)?void 0:n.metallicReflectanceColor.asArray(),specularColorTexture:l};r._hasTexturesExtension(n)&&r._exporter._materialNeedsUVsSet.add(n),t.extensions[ot]=h}else if(n instanceof g.OpenPBRMaterial){t.extensions=t.extensions||{};var p=null!==(a=r._exporter._materialExporter.getTextureInfo(n.specularWeightTexture))&&void 0!==a?a:void 0,f=null!==(s=r._exporter._materialExporter.getTextureInfo(n.specularColorTexture))&&void 0!==s?s:void 0,d=1==n.specularWeight?void 0:n.specularWeight,m=n.specularColor.equalsFloats(1,1,1)?void 0:n.specularColor.asArray();if(!f&&!p&&void 0===d&&void 0===m)return e(t);r._wasUsed=!0,(h={specularFactor:d,specularTexture:p,specularColorFactor:m,specularColorTexture:f,extensions:{}}).extensions.EXT_materials_specular_edge_color={specularEdgeColorEnabled:!0},(u=r._exporter._glTF).extensionsUsed||(u.extensionsUsed=[]),-1===r._exporter._glTF.extensionsUsed.indexOf("EXT_materials_specular_edge_color")&&r._exporter._glTF.extensionsUsed.push("EXT_materials_specular_edge_color"),(p||f)&&r._exporter._materialNeedsUVsSet.add(n),t.extensions[ot]=h}e(t)}))},e}();he.RegisterExtension(ot,(function(e){return new it(e)}));var at="KHR_materials_transmission",st=function(){function e(e){this.name=at,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportMaterialAdditionalTexturesAsync=function(e,t,n){return w(this,void 0,void 0,(function(){var e;return A(this,(function(t){if(e=[],n instanceof g.PBRMaterial){if(this._isExtensionEnabled(n))return n.subSurface.refractionIntensityTexture&&n.subSurface.useGltfStyleTextures&&e.push(n.subSurface.refractionIntensityTexture),[2,e]}else n instanceof g.OpenPBRMaterial&&n.transmissionWeight>0&&n.transmissionWeightTexture&&e.push(n.transmissionWeightTexture);return[2,e]}))}))},e.prototype._isExtensionEnabled=function(e){if(e instanceof g.OpenPBRMaterial&&!e.unlit)return e.transmissionWeight>0;if(e instanceof g.PBRMaterial&&!e.unlit){var t=e.subSurface;return t.isRefractionEnabled&&null!=t.refractionIntensity&&0!=t.refractionIntensity||null!=t.refractionIntensityTexture&&t.useGltfStyleTextures}return!1},e.prototype.postExportMaterialAsync=function(e,t,n){return w(this,void 0,void 0,(function(){var r,o,i,a;return A(this,(function(s){return this._isExtensionEnabled(n)?(n instanceof g.PBRMaterial?(this._wasUsed=!0,r=n.subSurface,o=0===r.refractionIntensity?void 0:r.refractionIntensity,i={transmissionFactor:o},r.refractionIntensityTexture&&(r.useGltfStyleTextures?(this._exporter._materialNeedsUVsSet.add(n),(a=this._exporter._materialExporter.getTextureInfo(r.refractionIntensityTexture))&&(i.transmissionTexture=a)):g.Logger.Warn("".concat(e,": Exporting a subsurface refraction intensity texture without `useGltfStyleTextures` is not supported"))),t.extensions||(t.extensions={}),t.extensions[at]=i):n instanceof g.OpenPBRMaterial&&(this._wasUsed=!0,o=n.transmissionWeight,i={transmissionFactor:o},n.transmissionWeightTexture&&(this._exporter._materialNeedsUVsSet.add(n),(a=this._exporter._materialExporter.getTextureInfo(n.transmissionWeightTexture))&&(i.transmissionTexture=a)),1===o&&t.pbrMetallicRoughness&&(t.pbrMetallicRoughness.baseColorFactor=void 0),t.extensions||(t.extensions={}),t.extensions[at]=i),[2,t]):[2,t]}))}))},e}();he.RegisterExtension(at,(function(e){return new st(e)}));var ut="KHR_materials_unlit",ct=function(){function e(){this.name=ut,this.enabled=!0,this.required=!1,this._wasUsed=!1}return Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.dispose=function(){},e.prototype.postExportMaterialAsync=function(e,t,n){var r=this;return new Promise((function(e){var o=!1;n instanceof g.PBRMaterial?o=n.unlit:n instanceof g.StandardMaterial&&(o=n.disableLighting),o&&(r._wasUsed=!0,null==t.extensions&&(t.extensions={}),t.extensions[ut]={}),e(t)}))},e}();he.RegisterExtension(ut,(function(){return new ct}));var lt="KHR_materials_volume",ht=function(){function e(e){this.name=lt,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportMaterialAdditionalTexturesAsync=function(e,t,n){return w(this,void 0,void 0,(function(){var e;return A(this,(function(t){if(e=[],n instanceof g.PBRMaterial){if(this._isExtensionEnabled(n))return n.subSurface.thicknessTexture&&e.push(n.subSurface.thicknessTexture),[2,e]}else n instanceof g.OpenPBRMaterial&&n.transmissionWeight>0&&n.geometryThicknessTexture&&e.push(n.geometryThicknessTexture);return[2,e]}))}))},e.prototype._isExtensionEnabled=function(e){if(e.unlit)return!1;var t=e.subSurface;return!(!t.isRefractionEnabled&&!t.isTranslucencyEnabled)&&(null!=t.maximumThickness&&0!=t.maximumThickness||null!=t.tintColorAtDistance&&t.tintColorAtDistance!=Number.POSITIVE_INFINITY||null!=t.tintColor&&t.tintColor!=g.Color3.White()||this._hasTexturesExtension(e))},e.prototype._hasTexturesExtension=function(e){return null!=e.subSurface.thicknessTexture},e.prototype.postExportMaterialAsync=function(e,t,n){var r=this;return new Promise((function(e){var o,i;if(n instanceof g.PBRMaterial&&r._isExtensionEnabled(n)){r._wasUsed=!0;var a=n.subSurface,s={thicknessFactor:0==a.maximumThickness?void 0:a.maximumThickness,thicknessTexture:null!==(o=r._exporter._materialExporter.getTextureInfo(a.thicknessTexture))&&void 0!==o?o:void 0,attenuationDistance:a.tintColorAtDistance==Number.POSITIVE_INFINITY?void 0:a.tintColorAtDistance,attenuationColor:a.tintColor.equalsFloats(1,1,1)?void 0:a.tintColor.asArray()};r._hasTexturesExtension(n)&&r._exporter._materialNeedsUVsSet.add(n),t.extensions=t.extensions||{},t.extensions[lt]=s}else n instanceof g.OpenPBRMaterial&&n.transmissionWeight>0&&(r._wasUsed=!0,s={thicknessFactor:n.geometryThickness,thicknessTexture:null!==(i=r._exporter._materialExporter.getTextureInfo(n.geometryThicknessTexture))&&void 0!==i?i:void 0,attenuationDistance:n.transmissionDepth,attenuationColor:n.transmissionColor.equalsFloats(1,1,1)?void 0:n.transmissionColor.asArray()},t.extensions=t.extensions||{},t.extensions[lt]=s);e(t)}))},e}();he.RegisterExtension(lt,(function(e){return new ht(e)}));var pt="KHR_materials_volume_scatter",ft=function(){function e(e){this.name=pt,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportMaterialAdditionalTexturesAsync=function(e,t,n){return w(this,void 0,void 0,(function(){var e;return A(this,(function(t){return e=[],n instanceof g.OpenPBRMaterial&&n.transmissionWeight>0&&n.transmissionScatterTexture&&e.push(n.transmissionScatterTexture),[2,e]}))}))},e.prototype._isExtensionEnabled=function(e){return!e.unlit&&0!=e.transmissionWeight&&!e.transmissionScatter.equals(g.Color3.Black())},e.prototype.postExportMaterialAsync=function(e,t,n){var r=this;return new Promise((function(e){if(n instanceof g.OpenPBRMaterial&&r._isExtensionEnabled(n)){r._wasUsed=!0;var o=1/n.transmissionDepth,i=new g.Vector3(-Math.log(n.transmissionColor.r)*o,-Math.log(n.transmissionColor.g)*o,-Math.log(n.transmissionColor.b)*o),a=new g.Vector3(n.transmissionScatter.r*o,n.transmissionScatter.g*o,n.transmissionScatter.b*o),s=i.subtract(a),u=Math.min(s.x,s.y,s.z);u<0&&(s.subtractInPlace(new g.Vector3(u,u,u)),i.copyFrom(s).addInPlace(a));var c={multiscatterColor:(f=new g.Vector3(a.x/i.x,a.y/i.y,a.z/i.z),d=new g.Vector3(Math.sqrt(1-f.x),Math.sqrt(1-f.y),Math.sqrt(1-f.z)),m=new g.Vector3(1,1,1),x=m.subtract(d),_=m.subtract(new g.Vector3(.139,.139,.139).multiplyInPlace(d)),v=m.add(new g.Vector3(1.17,1.17,1.17).multiplyInPlace(d)),x.multiplyInPlace(_).divideInPlace(v)).asArray(),scatterAnisotropy:n.transmissionScatterAnisotropy};if(n.transmissionScatterTexture){r._exporter._materialNeedsUVsSet.add(n);var l=r._exporter._materialExporter.getTextureInfo(n.transmissionScatterTexture);l&&(c.multiscatterColorTexture=l)}if(t.extensions=t.extensions||{},t.extensions[pt]=c,t.extensions.KHR_materials_volume){var h=t.extensions.KHR_materials_volume,p=Math.max(i.x,i.y,i.z);h.attenuationDistance=1/Math.max(p,1e-4),h.attenuationColor=new g.Color3(Math.exp(-i.x*h.attenuationDistance),Math.exp(-i.y*h.attenuationDistance),Math.exp(-i.z*h.attenuationDistance)).asArray()}}var f,d,m,x,_,v;e(t)}))},e}();he.RegisterExtension(pt,(function(e){return new ft(e)}),101);var dt="KHR_materials_diffuse_roughness",mt=function(){function e(e){this.name=dt,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportMaterialAdditionalTexturesAsync=function(e,t,n){return w(this,void 0,void 0,(function(){var e;return A(this,(function(t){if(e=[],n instanceof g.PBRBaseMaterial){if(n._baseDiffuseRoughness)return n._baseDiffuseRoughnessTexture&&e.push(n._baseDiffuseRoughnessTexture),[2,e]}else if(n instanceof g.OpenPBRMaterial&&n.baseDiffuseRoughness)return n.baseDiffuseRoughnessTexture&&e.push(n.baseDiffuseRoughnessTexture),[2,e];return[2,[]]}))}))},e.prototype.postExportMaterialAsync=function(e,t,n){var r=this;return new Promise((function(e){var o=null,i=null;if(n instanceof g.PBRBaseMaterial?(o=n._baseDiffuseRoughness,i=n._baseDiffuseRoughnessTexture):n instanceof g.OpenPBRMaterial&&(o=n.baseDiffuseRoughness,i=n.baseDiffuseRoughnessTexture),o){r._wasUsed=!0,t.extensions=t.extensions||{};var a=r._exporter._materialExporter.getTextureInfo(i),s={diffuseRoughnessFactor:o,diffuseRoughnessTexture:null!=a?a:void 0};null!==s.diffuseRoughnessTexture&&r._exporter._materialNeedsUVsSet.add(n),t.extensions[dt]=s,e(t)}else e(t)}))},e}();he.RegisterExtension(dt,(function(e){return new mt(e)}));var gt="KHR_materials_openpbr",xt=function(){function e(){this.name=gt,this.enabled=!0,this.required=!1,this._wasUsed=!1}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportMaterialAsync=function(e,t,n){var r=this;return new Promise((function(e){n instanceof g.OpenPBRMaterial&&(r._wasUsed=!0,t.extensions=t.extensions||{},t.extensions[gt]={}),e(t)}))},e}();he.RegisterExtension(gt,(function(e){return new xt}));var _t="KHR_texture_transform",vt=function(){function e(){this.name=_t,this.enabled=!0,this.required=!1,this._wasUsed=!1}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportTexture=function(e,t,n){if(n.getScene()||g.Tools.Warn("".concat(e,': "scene" is not defined for Babylon texture ').concat(n.name,"!")),0===n.uAng&&0===n.vAng||(g.Tools.Warn("".concat(e,": Texture ").concat(n.name," with rotation in the u or v axis is not supported in glTF.")),0===n.uRotationCenter&&0===n.vRotationCenter)){var r={},o=!1;if(0===n.uOffset&&0===n.vOffset||(r.offset=[n.uOffset,n.vOffset],o=!0),1===n.uScale&&1===n.vScale||(r.scale=[n.uScale,n.vScale],o=!0),0!==n.wAng){if(0!==n.uRotationCenter||0!==n.vRotationCenter){if(n.homogeneousRotationInUVTransform&&n.uScale!==n.vScale)return void g.Tools.Warn("".concat(e,": Texture ").concat(n.name," with homogenousRotationInUVTransform, non-uniform scaling, and non-zero rotation cannot be exported with ").concat(_t,"."));g.Tools.Warn("".concat(e,": Texture ").concat(n.name," with non-origin rotation center will be exported using an adjusted offset with ").concat(_t,".")),r.offset=function(e){var t=e.uOffset,n=e.vOffset,r=e.uRotationCenter,o=e.vRotationCenter,i=e.uScale,a=e.vScale,s=e.wAng,u=Math.cos(s),c=Math.sin(s),l=r*i,h=o*a;return[t+(l*(1-u)+h*c),n+(h*(1-u)-l*c)]}(n)}r.rotation=-n.wAng,o=!0}0!==n.coordinatesIndex&&(r.texCoord=n.coordinatesIndex,o=!0),o&&(this._wasUsed=!0,t.extensions||(t.extensions={}),t.extensions[_t]=r)}},e}();he.RegisterExtension(_t,(function(){return new vt}));var Tt="KHR_texture_basisu",yt=function(){function e(e){this.name=Tt,this.enabled=!0,this.required=!0,this._wasUsed=!1,this._exporter=e}return Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.dispose=function(){},e.prototype.postExportTexture=function(e,t){var n=this._exporter._textures[t.index],r=n.source;if(void 0!==r){var o=this._exporter._images[r];"image/ktx2"===(o.mimeType||(0,g.GetMimeType)(o.uri))&&(n.source=void 0,n.extensions||(n.extensions={}),n.extensions[Tt]={source:r},this._wasUsed=!0)}},e}();he.RegisterExtension(Tt,(function(e){return new yt(e)}));var bt="EXT_texture_webp",Mt=function(){function e(e){this.name=bt,this.enabled=!0,this.required=!0,this._wasUsed=!1,this._exporter=e}return Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.dispose=function(){},e.prototype.postExportTexture=function(e,t){var n=this._exporter._textures[t.index],r=n.source;if(void 0!==r){var o=this._exporter._images[r];"image/webp"===(o.mimeType||(0,g.GetMimeType)(o.uri))&&(n.source=void 0,n.extensions||(n.extensions={}),n.extensions[bt]={source:r},this._wasUsed=!0)}},e}();he.RegisterExtension(bt,(function(e){return new Mt(e)}));var wt="EXT_texture_avif",At=function(){function e(e){this.name=wt,this.enabled=!0,this.required=!0,this._wasUsed=!1,this._exporter=e}return Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.dispose=function(){},e.prototype.postExportTexture=function(e,t){var n=this._exporter._textures[t.index],r=n.source;if(void 0!==r){var o=this._exporter._images[r];"image/avif"===(o.mimeType||(0,g.GetMimeType)(o.uri))&&(n.source=void 0,n.extensions||(n.extensions={}),n.extensions[wt]={source:r},this._wasUsed=!0)}},e}();he.RegisterExtension(wt,(function(e){return new At(e)}));var Rt=function(){function e(){}return e.CreateSTL=function(e,t,n,r,o,i,a,s){void 0===t&&(t=!0),void 0===n&&(n="stlmesh"),void 0===r&&(r=!1),void 0===o&&(o=!0),void 0===i&&(i=!1),void 0===a&&(a=!1),void 0===s&&(s=!1);var u=function(e,t,n){var r=[3*e[n],3*e[n+1],3*e[n+2]],o=[new g.Vector3(t[r[0]],t[r[0]+2],t[r[0]+1]),new g.Vector3(t[r[1]],t[r[1]+2],t[r[1]+1]),new g.Vector3(t[r[2]],t[r[2]+2],t[r[2]+1])],i=o[0].subtract(o[1]),a=o[2].subtract(o[1]);return{v:o,n:g.Vector3.Cross(a,i).normalize()}},c=function(e,t,n,r){return t=l(e,t,n.x,r),t=l(e,t,n.y,r),l(e,t,n.z,r)},l=function(e,t,n,r){return e.setFloat32(t,n,r),t+4},h=function(e){if(a){var t=e;e instanceof g.InstancedMesh&&(t=e.sourceMesh);var n=t.getVerticesData(g.VertexBuffer.PositionKind,!0,!0);if(!n)return[];var r=g.Vector3.Zero(),o=void 0;for(o=0;o<n.length;o+=3)g.Vector3.TransformCoordinatesFromFloatsToRef(n[o],n[o+1],n[o+2],e.computeWorldMatrix(!0),r).toArray(n,o);return n}return e.getVerticesData(g.VertexBuffer.PositionKind)||[]};a&&(i=!0);var p="",f=0,d=0;if(r){for(var m=0;m<e.length;m++)f+=(T=(_=e[m]).getIndices())?T.length/3:0;var x=new ArrayBuffer(84+50*f);d+=80,(p=new DataView(x)).setUint32(d,f,o),d+=4}else s||(p="solid stlmesh\r\n");for(m=0;m<e.length;m++){var _=e[m];!r&&s&&(p+="solid "+_.name+"\r\n"),!i&&_ instanceof g.Mesh&&_.bakeCurrentTransformIntoVertices();for(var v=h(_),T=_.getIndices()||[],y=0;y<T.length;y+=3){var b=u(T,v,y);r?(d=c(p,d,b.n,o),d=c(p,d,b.v[0],o),d=c(p,d,b.v[1],o),d=c(p,d,b.v[2],o),d+=2):(p+="\tfacet normal "+b.n.x+" "+b.n.y+" "+b.n.z+"\r\n",p+="\t\touter loop\r\n",p+="\t\t\tvertex "+b.v[0].x+" "+b.v[0].y+" "+b.v[0].z+"\r\n",p+="\t\t\tvertex "+b.v[1].x+" "+b.v[1].y+" "+b.v[1].z+"\r\n",p+="\t\t\tvertex "+b.v[2].x+" "+b.v[2].y+" "+b.v[2].z+"\r\n",p+="\t\tendloop\r\n",p+="\tendfacet\r\n")}!r&&s&&(p+="endsolid "+name+"\r\n")}if(r||s||(p+="endsolid stlmesh"),t){var M=document.createElement("a"),w=new Blob([p],{type:"application/octet-stream"});M.href=window.URL.createObjectURL(w),M.download=n+".stl",M.click()}return p},e}();function Ct(e,t,n,r){void 0===n&&(n=3),void 0===r&&(r=!1);for(var o=[],i=0;i<e.length/n;i++){var a=e[i*n]*(r?-1:1),s=e[i*n+1],u=e[i*n+2];o.push("(".concat(a.toPrecision(t.precision),", ").concat(s.toPrecision(t.precision),", ").concat(u.toPrecision(t.precision),")"))}return o.join(", ")}function Et(e,t){for(var n=[],r=0;r<e.length/2;r++){var o=e[2*r],i=e[2*r+1];n.push("(".concat(o.toPrecision(t.precision),", ").concat((1-i).toPrecision(t.precision),")"))}return n.join(", ")}function It(e,t,n,r){var o=function(e,t,n,r){var o=e.getVerticesData(g.VertexBuffer.PositionKind),i=e.getVerticesData(g.VertexBuffer.NormalKind);if(o&&i)return'\n\tdef Mesh "'.concat("Geometry",'"\n\t{\n        uniform token orientation = "').concat(n,'"\n\t\tint[] faceVertexCounts = [').concat(function(e){var t,n=(null===(t=e.getIndices())||void 0===t?void 0:t.length)?e.getTotalIndices():e.getTotalVertices();return Array(n/3).fill(3).join(", ")}(e),"]\n\t\tint[] faceVertexIndices = [").concat(function(e){var t,n=e.getIndices(),r=null!==(t=null==n?void 0:n.length)&&void 0!==t?t:e.getTotalVertices(),o=[];if(null!==n)for(var i=0;i<r;i++)o.push(n[i]);else for(i=0;i<r;i++)o.push(i);return o.join(", ")}(e),"]\n\t\tnormal3f[] normals = [").concat(Ct(i,t,void 0,r),'] (\n\t\t\tinterpolation = "vertex"\n\t\t)\n\t\tpoint3f[] points = [').concat(Ct(o,t,void 0,r),"]\n        ").concat(function(e,t){for(var n="",r=0;r<4;r++){var o=r>0?r:"",i=e.getVerticesData(g.VertexBuffer.UVKind+(o?o+1:""));i&&(n+="\n\t\ttexCoord2f[] primvars:st".concat(o," = [").concat(Et(i,t),'] (\n\t\t\tinterpolation = "vertex"\n\t\t)'))}var a=e.getVerticesData(g.VertexBuffer.ColorKind);return a&&(n+="\n\tcolor3f[] primvars:displayColor = [".concat(Ct(a,t,a.length/e.getTotalVertices()),'] (\n\t\tinterpolation = "vertex"\n\t\t)')),n}(e,t),'\n\t\tuniform token subdivisionScheme = "none"\n\t}\n')}(e,t,n,r);return'\n        def "Geometry"\n        {\n        '.concat(o,"\n        }\n        ")}function St(e){var t='#usda 1.0\n    (\n        customLayerData = {\n            string creator = "Babylon.js USDZExportAsync"\n        }\n        defaultPrim = "Root"\n        metersPerUnit = 1\n        upAxis = "Y"\n    )';return t+=e,fflate.strToU8(t)}function Vt(e){var t=e.m;return"( ".concat(Ft(t,0),", ").concat(Ft(t,4),", ").concat(Ft(t,8),", ").concat(Ft(t,12)," )")}function Ft(e,t){return"(".concat(e[t+0],", ").concat(e[t+1],", ").concat(e[t+2],", ").concat(e[t+3],")")}function Bt(e,t){var n="Object_"+e.uniqueId,r=Vt(t);return'def Xform "'.concat(n,'" (\n\tprepend references = @./geometries/Geometry_').concat(e.geometry.uniqueId,'.usda@</Geometry>\n\tprepend apiSchemas = ["MaterialBindingAPI"]\n)\n{\n\tmatrix4d xformOp:transform = ').concat(r,'\n\tuniform token[] xformOpOrder = ["xformOp:transform"]\t\n\n    rel material:binding = </Root/Materials/Material_').concat(e.material.uniqueId,">\n}\n\n")}function Ot(e){switch(e){case g.Constants.TEXTURE_CLAMP_ADDRESSMODE:return"clamp";case g.Constants.TEXTURE_MIRROR_ADDRESSMODE:return"mirror";case g.Constants.TEXTURE_WRAP_ADDRESSMODE:default:return"repeat"}}function Nt(e){return"(".concat(e.x,", ").concat(e.y,")")}function Pt(e){return"(".concat(e.r,", ").concat(e.g,", ").concat(e.b,")")}function Ut(e,t,n,r,o,i){var a=e.getInternalTexture().uniqueId+"_"+e.invertY;o[a]=e;var s=e.coordinatesIndex>0?"st"+e.coordinatesIndex:"st",u=new g.Vector2(e.uScale,e.vScale),c=new g.Vector2(e.uOffset,e.vOffset),l=e.wAng,h=Math.sin(l),p=Math.cos(l);return c.y=1-c.y-u.y,c.x+=h*u.x,c.y+=(1-p)*u.y,'\n    def Shader "PrimvarReader_'.concat(n,'"\n    {\n        uniform token info:id = "UsdPrimvarReader_float2"\n        float2 inputs:fallback = (0.0, 0.0)\n        token inputs:varname = "').concat(s,'"\n        float2 outputs:result\n    }\n\n    def Shader "Transform2d_').concat(n,'"\n    {\n        uniform token info:id = "UsdTransform2d"\n        token inputs:in.connect = </Root/Materials/Material_').concat(t.uniqueId,"/PrimvarReader_").concat(n,".outputs:result>\n        float inputs:rotation = ").concat((l*(180/Math.PI)).toFixed(i.precision),"\n        float2 inputs:scale = ").concat(Nt(u),"\n        float2 inputs:translation = ").concat(Nt(c),'\n        float2 outputs:result\n    }\n\n    def Shader "Texture_').concat(e.uniqueId,"_").concat(n,'"\n    {\n        uniform token info:id = "UsdUVTexture"\n        asset inputs:file = @textures/Texture_').concat(a,".png@\n        float2 inputs:st.connect = </Root/Materials/Material_").concat(t.uniqueId,"/Transform2d_").concat(n,".outputs:result>\n        ").concat(r?"float4 inputs:scale = "+function(e){return"(".concat(e.r,", ").concat(e.g,", ").concat(e.b,", 1.0)")}(r):"",'\n        token inputs:sourceColorSpace = "').concat(e.gammaSpace?"sRGB":"raw",'"\n        token inputs:wrapS = "').concat(Ot(e.wrapU),'"\n        token inputs:wrapT = "').concat(Ot(e.wrapV),'"\n        float outputs:r\n        float outputs:g\n        float outputs:b\n        float3 outputs:rgb\n        ').concat(t.needAlphaBlending()||t.needAlphaTesting()?"float outputs:a":"","\n    }")}function kt(e,t,n){var r="\t\t\t",o=[],i=[],a=function(e){var t,n,r={diffuseMap:null,diffuse:null,alphaCutOff:0,emissiveMap:null,emissive:null,normalMap:null,roughnessMap:null,roughnessChannel:"a",roughness:0,metalnessMap:null,metalnessChannel:"r",metalness:0,aoMap:null,aoMapChannel:"rgb",aoMapIntensity:0,alphaMap:null,ior:1,clearCoatEnabled:!1,clearCoat:0,clearCoatMap:null,clearCoatRoughness:0,clearCoatRoughnessMap:null};return e instanceof g.StandardMaterial?b(b({},r),{diffuseMap:e.diffuseTexture,diffuse:e.diffuseColor,alphaCutOff:e.alphaCutOff,emissiveMap:e.emissiveTexture,emissive:e.emissiveColor,roughness:1,alphaMap:e.opacityTexture}):e instanceof g.PBRBaseMaterial?b(b({},r),{diffuseMap:e._albedoTexture,diffuse:e._albedoColor,alphaCutOff:e._alphaCutOff,emissiveMap:e._emissiveTexture,emissive:e._emissiveColor,normalMap:e._bumpTexture,roughnessMap:e._metallicTexture,roughnessChannel:e._useRoughnessFromMetallicTextureAlpha?"a":"g",roughness:null!==(t=e._roughness)&&void 0!==t?t:1,metalnessMap:e._metallicTexture,metalnessChannel:e._useMetallnessFromMetallicTextureBlue?"b":"r",metalness:null!==(n=e._metallic)&&void 0!==n?n:0,aoMap:e._ambientTexture,aoMapChannel:e._useAmbientInGrayScale?"r":"rgb",aoMapIntensity:e._ambientTextureStrength,alphaMap:e._opacityTexture,ior:e.subSurface.indexOfRefraction,clearCoatEnabled:e.clearCoat.isEnabled,clearCoat:e.clearCoat.intensity,clearCoatMap:e.clearCoat.texture,clearCoatRoughness:e.clearCoat.roughness,clearCoatRoughnessMap:e.clearCoat.useRoughnessFromMainTexture?e.clearCoat.texture:e.clearCoat.textureRoughness}):r}(e),s=a.diffuseMap,u=a.diffuse,c=a.alphaCutOff,l=a.emissiveMap,h=a.emissive,p=a.normalMap,f=a.roughnessMap,d=a.roughnessChannel,m=a.roughness,x=a.metalnessMap,_=a.metalnessChannel,v=a.metalness,T=a.aoMap,y=a.aoMapChannel,M=a.aoMapIntensity,w=a.alphaMap,A=a.ior,R=a.clearCoatEnabled,C=a.clearCoat,E=a.clearCoatMap,I=a.clearCoatRoughness,S=a.clearCoatRoughnessMap;return null!==s?(o.push("".concat(r,"color3f inputs:diffuseColor.connect = </Root/Materials/Material_").concat(e.uniqueId,"/Texture_").concat(s.uniqueId,"_diffuse.outputs:rgb>")),e.needAlphaBlending()?o.push("".concat(r,"float inputs:opacity.connect = </Root/Materials/Material_").concat(e.uniqueId,"/Texture_").concat(s.uniqueId,"_diffuse.outputs:a>")):e.needAlphaTesting()&&(o.push("".concat(r,"float inputs:opacity.connect = </Root/Materials/Material_").concat(e.uniqueId,"/Texture_").concat(s.uniqueId,"_diffuse.outputs:a>")),o.push("".concat(r,"float inputs:opacityThreshold = ").concat(c))),i.push(Ut(s,e,"diffuse",u,t,n))):o.push("".concat(r,"color3f inputs:diffuseColor = ").concat(Pt(u||g.Color3.White()))),null!==l?(o.push("".concat(r,"color3f inputs:emissiveColor.connect = </Root/Materials/Material_").concat(e.uniqueId,"/Texture_").concat(l.uniqueId,"_emissive.outputs:rgb>")),i.push(Ut(l,e,"emissive",h,t,n))):h&&h.toLuminance()>0&&o.push("".concat(r,"color3f inputs:emissiveColor = ").concat(Pt(h))),null!==p&&(o.push("".concat(r,"normal3f inputs:normal.connect = </Root/Materials/Material_").concat(e.uniqueId,"/Texture_").concat(p.uniqueId,"_normal.outputs:rgb>")),i.push(Ut(p,e,"normal",null,t,n))),null!==T&&(o.push("".concat(r,"float inputs:occlusion.connect = </Root/Materials/Material_").concat(e.uniqueId,"/Texture_").concat(T.uniqueId,"_occlusion.outputs:").concat(y,">")),i.push(Ut(T,e,"occlusion",new g.Color3(M,M,M),t,n))),null!==f?(o.push("".concat(r,"float inputs:roughness.connect = </Root/Materials/Material_").concat(e.uniqueId,"/Texture_").concat(f.uniqueId,"_roughness.outputs:").concat(d,">")),i.push(Ut(f,e,"roughness",new g.Color3(m,m,m),t,n))):o.push("".concat(r,"float inputs:roughness = ").concat(m)),null!==x?(o.push("".concat(r,"float inputs:metallic.connect = </Root/Materials/Material_").concat(e.uniqueId,"/Texture_").concat(x.uniqueId,"_metallic.outputs:").concat(_,">")),i.push(Ut(x,e,"metallic",new g.Color3(v,v,v),t,n))):o.push("".concat(r,"float inputs:metallic = ").concat(v)),null!==w?(o.push("".concat(r,"float inputs:opacity.connect = </Root/Materials/Material_").concat(e.uniqueId,"/Texture_").concat(w.uniqueId,"_opacity.outputs:r>")),o.push("".concat(r,"float inputs:opacityThreshold = 0.0001")),i.push(Ut(w,e,"opacity",null,t,n))):o.push("".concat(r,"float inputs:opacity = ").concat(e.alpha)),R&&(null!==E?(o.push("".concat(r,"float inputs:clearcoat.connect = </Root/Materials/Material_").concat(e.uniqueId,"/Texture_").concat(E.uniqueId,"_clearcoat.outputs:r>")),i.push(Ut(E,e,"clearcoat",new g.Color3(C,C,C),t,n))):o.push("".concat(r,"float inputs:clearcoat = ").concat(C)),null!==S?(o.push("".concat(r,"float inputs:clearcoatRoughness.connect = </Root/Materials/Material_").concat(e.uniqueId,"/Texture_").concat(S.uniqueId,"_clearcoatRoughness.outputs:g>")),i.push(Ut(S,e,"clearcoatRoughness",new g.Color3(I,I,I),t,n))):o.push("".concat(r,"float inputs:clearcoatRoughness = ").concat(I))),o.push("".concat(r,"float inputs:ior = ").concat(A)),'\n\tdef Material "Material_'.concat(e.uniqueId,'"\n\t{\n\t\tdef Shader "PreviewSurface"\n\t\t{\n\t\t\tuniform token info:id = "UsdPreviewSurface"\n').concat(o.join("\n"),"\n\t\t\tint inputs:useSpecularWorkflow = 0\n\t\t\ttoken outputs:surface\n\t\t}\n\n\t\ttoken outputs:surface.connect = </Root/Materials/Material_").concat(e.uniqueId,"/PreviewSurface.outputs:surface>\n\n").concat(i.join("\n"),"\n\n\t}\n")}function Dt(e){var t,n;e.computeWorldMatrix(!0);for(var r=e.getWorldMatrix().clone(),o=e.getScene().useRightHandedSystem,i=null!==(n=null===(t=e.material)||void 0===t?void 0:t._getEffectiveOrientation(e))&&void 0!==n?n:e.sideOrientation,a=!o,s=e.parent;s;){if(z(s,o)&&null===s.parent){o||(r.multiplyToRef(s.getWorldMatrix().invert(),r),i=i===g.Material.ClockWiseSideOrientation?g.Material.CounterClockWiseSideOrientation:g.Material.ClockWiseSideOrientation),a=!1;break}s=s.parent}return r.determinant()<0&&g.Tools.Warn("Mesh ".concat(e.name," has a negative scale, which may look incorrect in destinations like QuickLook.")),{matrix:r,windingOrder:i===g.Material.ClockWiseSideOrientation?"leftHanded":"rightHanded",convertToRightHanded:a}}function Lt(e,t,n){return w(this,void 0,void 0,(function(){var r,o,i,a,s,u,c,l,h,p,f,d,m,x,_,v,T,y,M,w,R,C,E,I,S,V,F,B,O,N,P,U;return A(this,(function(A){switch(A.label){case 0:return r=b({fflateUrl:"https://unpkg.com/fflate@0.8.2",includeAnchoringProperties:!0,anchoringType:"plane",planeAnchoringAlignment:"horizontal",modelFileName:"model.usda",precision:5,exportCamera:!1,cameraSensorWidth:35},t),"undefined"!=typeof fflate?[3,2]:[4,g.Tools.LoadScriptAsync(r.fflateUrl)];case 1:A.sent(),A.label=2;case 2:for((o={})[r.modelFileName]=null,i='#usda 1.0\n    (\n        customLayerData = {\n            string creator = "Babylon.js USDZExportAsync"\n        }\n        defaultPrim = "Root"\n        metersPerUnit = 1\n        upAxis = "Y"\n    )',i+=function(e){var t=!0===e.includeAnchoringProperties?'\n\t\ttoken preliminary:anchoring:type = "'.concat(e.anchoringType,'"\n\t\ttoken preliminary:planeAnchoring:alignment = "').concat(e.planeAnchoringAlignment,'"'):"";return'def Xform "Root"\n    {\n        def Scope "Scenes" (\n            kind = "sceneLibrary"\n        )\n        {\n            def Xform "Scene" (\n                customData = {\n                    bool preliminary_collidesWithEnvironment = 0\n                    string sceneName = "Scene"\n                }\n                sceneName = "Scene"\n            )\n            {'.concat(t,"\n            ")}(r),a={},s=0,u=e.meshes;s<u.length;s++)0!==(c=u[s]).getTotalVertices()&&(h=(l=c).geometry,(p=l.material)&&h&&(!n||n(l))&&(-1!==["StandardMaterial","PBRMaterial","PBRMetallicRoughnessMaterial"].indexOf(p.getClassName())?(f="geometries/Geometry_"+h.uniqueId+".usda",d=Dt(l),m=d.matrix,x=d.windingOrder,_=d.convertToRightHanded,f in o||(v=It(h,r,x,_),o[f]=St(v)),p.uniqueId in a||(a[p.uniqueId]=p),i+=Bt(l,m)):g.Tools.Warn("USDZExportAsync does not support this material type: "+p.getClassName())));for(w in e.activeCamera&&r.exportCamera&&(i+=function(e,t){var n="Camera_"+e.uniqueId,r=Vt(g.Matrix.RotationY(Math.PI).multiply(e.getWorldMatrix()));if(e.mode===g.Constants.ORTHOGRAPHIC_CAMERA)return'def Camera "'.concat(n,'"\n\t\t{\n\t\t\tmatrix4d xformOp:transform = ').concat(r,'\n\t\t\tuniform token[] xformOpOrder = ["xformOp:transform"]\n\n\t\t\tfloat2 clippingRange = (').concat(e.minZ.toPrecision(t.precision),", ").concat(e.maxZ.toPrecision(t.precision),")\n\t\t\tfloat horizontalAperture = ").concat((10*(Math.abs(e.orthoLeft||1)+Math.abs(e.orthoRight||1))).toPrecision(t.precision),"\n\t\t\tfloat verticalAperture = ").concat((10*(Math.abs(e.orthoTop||1)+Math.abs(e.orthoBottom||1))).toPrecision(t.precision),'\n\t\t\ttoken projection = "orthographic"\n\t\t}\n\t\n\t');var o=e.getEngine().getAspectRatio(e),i=t.cameraSensorWidth||35;return'def Camera "'.concat(n,'"\n\t\t{\n\t\t\tmatrix4d xformOp:transform = ').concat(r,'\n\t\t\tuniform token[] xformOpOrder = ["xformOp:transform"]\n\n\t\t\tfloat2 clippingRange = (').concat(e.minZ.toPrecision(t.precision),", ").concat(e.maxZ.toPrecision(t.precision),")\n\t\t\tfloat focalLength = ").concat((i/(2*Math.tan(.5*e.fov))).toPrecision(t.precision),'\n            token projection = "perspective"\n\t\t\tfloat horizontalAperture = ').concat((i*o).toPrecision(t.precision),"\n\t\t\tfloat verticalAperture = ").concat((i/o).toPrecision(t.precision),"            \n\t\t}\n\t\n\t")}(e.activeCamera,r)),i+="\n            }\n        }",i+=function(e,t,n){var r=[];for(var o in e){var i=e[o];r.push(kt(i,t,n))}return'\n    def "Materials"\n{\n'.concat(r.join(""),"\n}\n\n")}(a,T={},r),i+="\n    }",o[r.modelFileName]=fflate.strToU8(i),M=[],y=T)M.push(w);R=0,A.label=3;case 3:return R<M.length?(w=M[R])in y?(E=T[C=w],I=E.getSize(),[4,(0,g.GetTextureDataAsync)(E)]):[3,6]:[3,7];case 4:return S=A.sent(),[4,g.DumpTools.DumpDataAsync(I.width,I.height,S,"image/png",void 0,!1,!0)];case 5:V=A.sent(),o["textures/Texture_".concat(C,".png")]=new Uint8Array(V).slice(),A.label=6;case 6:return R++,[3,3];case 7:for(B in F=0,o)(O=o[B])&&(N=34+B.length,4!=(P=63&(F+=N))&&(U=new Uint8Array(64-P),o[B]=[O,{extra:{12345:U}}]),F=O.length);return[2,fflate.zipSync(o,{level:0})]}}))}))}var zt=function(){function e(){}return e.Export=function(e,t,n){var r;if(void 0===t&&(t=[]),!e||0===e.bones.length)throw new Error("Invalid or empty skeleton provided");var o=t;t&&0!==t.length||(o=e.animations.map((function(e){return e.name})));for(var i=null,a=0,s=o;a<s.length;a++){var u=s[a],c=e.getAnimationRange(u);c&&(i=i?new g.AnimationRange("animation-range",Math.min(i.from,c.from),Math.max(i.to,c.to)):c)}if(!i&&(e.animations.length>0&&(i=e.getAnimationRange(e.animations[0].name)),!i))throw new Error("No animation range found in skeleton");for(var l=n||1/((null===(r=e.animations[0])||void 0===r?void 0:r.framePerSecond)||30),h=this._BuildBoneHierarchy(e,o),p=0,f=0,d=h;f<d.length;f++){var m=d[f];m.positionKeys.length>0&&(p=Math.max(p,m.positionKeys.length)),m.rotationKeys.length>0&&(p=Math.max(p,m.rotationKeys.length))}0===p&&(p=Math.floor((i.to-i.from)/l)+1);var x="";return x+="HIERARCHY\n",x+=this._ExportHierarchy(h,0),x+="MOTION\n",x+="Frames: ".concat(p,"\n"),(x+="Frame Time: ".concat(l.toFixed(6),"\n"))+this._ExportMotionData(h,p,0,o)},e._BuildBoneHierarchy=function(e,t){for(var n,r,o=new Map,i=[],a=0,s=e.bones;a<s.length;a++){var u={bone:h=s[a],children:[],hasPositionChannels:!1,hasRotationChannels:!1,positionKeys:[],rotationKeys:[]};o.set(h,u)}for(var c=0,l=e.bones;c<l.length;c++){var h=l[c];if(u=o.get(h),h.animations.length>0)for(var p=0,f=h.animations;p<f.length;p++){var d=f[p];t.includes(d.name)&&("position"===d.targetProperty?(u.hasPositionChannels=!0,(n=u.positionKeys).push.apply(n,d.getKeys())):"rotationQuaternion"===d.targetProperty&&(u.hasRotationChannels=!0,(r=u.rotationKeys).push.apply(r,d.getKeys())))}if(h.getParent()){var m=o.get(h.getParent());m&&m.children.push(u)}else i.push(u)}return i},e._ExportHierarchy=function(e,t){for(var n="",r="    ".repeat(t),o=0,i=e;o<i.length;o++){var a=i[o],s=a.bone;if(this._IsEndSite(a)){n+="".concat(r,"End Site\n"),n+="".concat(r,"{\n");var u=this._GetBoneOffset(s);n+="".concat(r,"    OFFSET ").concat(u.x.toFixed(6)," ").concat(u.y.toFixed(6)," ").concat(u.z.toFixed(6),"\n"),n+="".concat(r,"}\n")}else{n+="".concat(0===t?"ROOT":"".concat(r,"JOINT")," ").concat(s.name,"\n"),n+="".concat(r,"{\n"),u=this._GetBoneOffset(s),n+="".concat(r,"    OFFSET ").concat(u.x.toFixed(6)," ").concat(u.y.toFixed(6)," ").concat(u.z.toFixed(6),"\n");var c=[];a.hasPositionChannels&&c.push("Xposition","Yposition","Zposition"),a.hasRotationChannels&&c.push("Zrotation","Xrotation","Yrotation"),c.length>0&&(n+="".concat(r,"    CHANNELS ").concat(c.length," ").concat(c.join(" "),"\n")),a.children.length>0&&(n+=this._ExportHierarchy(a.children,t+1)),n+="".concat(r,"}\n")}}return n},e._IsEndSite=function(e){return 0===e.children.length},e._GetBoneOffset=function(e){try{return e.getParent()?e.getLocalMatrix().getTranslation():e.getRestMatrix().getTranslation()}catch(e){return g.Vector3.Zero()}},e._ExportMotionData=function(e,t,n,r){for(var o="",i=0;i<t;i++){var a=[];this._CollectFrameValues(e,i+n,a,r),o+=a.map((function(e){return e.toFixed(6)})).join(" ")+"\n"}return o},e._CollectFrameValues=function(e,t,n,r){for(var o=0,i=e;o<i.length;o++){var a=i[o];if(!this._IsEndSite(a)){if(a.hasPositionChannels){var s=this._GetPositionAtFrameIndex(a.positionKeys,t);n.push(s.x,s.y,s.z)}if(a.hasRotationChannels){var u=this._GetRotationAtFrameIndex(a.rotationKeys,t),c=this._QuaternionToEuler(u);n.push(c.z,c.x,c.y)}a.children.length>0&&this._CollectFrameValues(a.children,t,n,r)}}},e._GetPositionAtFrameIndex=function(e,t){return 0===e.length?g.Vector3.Zero():e[Math.max(0,Math.min(t,e.length-1))].value.clone()},e._GetRotationAtFrameIndex=function(e,t){return 0===e.length?g.Quaternion.Identity():e[Math.max(0,Math.min(t,e.length-1))].value.clone()},e._QuaternionToEuler=function(e){var t=new g.Matrix;e.toRotationMatrix(t);var n,r,o,i=t.m,a=Math.sqrt(i[0]*i[0]+i[1]*i[1]);return a>g.Epsilon?(n=Math.atan2(i[6],i[10]),r=Math.atan2(-i[2],a),o=Math.atan2(i[1],i[0])):(n=Math.atan2(-i[9],i[5]),r=Math.atan2(-i[2],a),o=0),new g.Vector3(g.Tools.ToDegrees(n),g.Tools.ToDegrees(r),g.Tools.ToDegrees(o))},e}();function Kt(e){return"string"==typeof(null==e?void 0:e.name)}var Wt=Symbol("__xml:meta$__"),qt=Symbol("__xml:name$__");function Gt(e,t){var n,r=e.constructor;(null!==(n=r[Wt])&&void 0!==n?n:r[Wt]=[]).push(t)}function jt(e){return function(t){t[qt]=e}}function Ht(){return function(e,t){return Gt(e,{kind:"none",prop:t,ignore:!0})}}function Xt(e){return function(t,n){return Gt(t,b({kind:"attr",prop:n},e))}}function Qt(e){return function(t,n){return Gt(t,b({kind:"elem",prop:n},e))}}function Zt(e){var t,n;return null!==(n=null===(t=null==e?void 0:e.constructor)||void 0===t?void 0:t[Wt])&&void 0!==n?n:[]}function Yt(e){var t;return(null===(t=null==e?void 0:e.constructor)||void 0===t?void 0:t[qt])||void 0}function Jt(e){return/^[A-Za-z_][A-Za-z0-9._-]*$/.test(e)}function $t(e){if(Kt(e))return e;var t=(null!=e?e:"").trim();if(!t)return{name:""};var n=t.indexOf(":");if(-1===n)return{name:t};if(-1!==t.indexOf(":",n+1))return{name:t};var r=t.slice(0,n),o=t.slice(n+1);return Jt(r)&&Jt(o)?{ns:r,name:o}:{name:t}}function en(e,t){return t?"".concat(t,":").concat(e):e}var tn=Object.freeze({eps:1e-6,maxDecimalsCap:15,trimTrailingZeros:!0,allowScientific:!1,snapNearZero:!0}),nn=Object.freeze({number:tn});function rn(e){var t,n,r,o,i,a,s=null!==(t=null==e?void 0:e.eps)&&void 0!==t?t:tn.eps;return{eps:s,maxDecimalsCap:null!==(n=null==e?void 0:e.maxDecimalsCap)&&void 0!==n?n:tn.maxDecimalsCap,trimTrailingZeros:null!==(r=null==e?void 0:e.trimTrailingZeros)&&void 0!==r?r:tn.trimTrailingZeros,fixedDecimals:null==e?void 0:e.fixedDecimals,allowScientific:null!==(o=null==e?void 0:e.allowScientific)&&void 0!==o?o:tn.allowScientific,snapNearZero:null!==(i=null==e?void 0:e.snapNearZero)&&void 0!==i?i:tn.snapNearZero,zeroThreshold:null!==(a=null==e?void 0:e.zeroThreshold)&&void 0!==a?a:s,perAttributeEps:null==e?void 0:e.perAttributeEps}}function on(e){return{number:rn(null==e?void 0:e.number)}}var an=function(){function e(e){if(this.o=e,this._o=e.number,!Number.isFinite(this._o.eps)||this._o.eps<=0)throw new Error("opts.eps must be a finite, positive number")}return e.prototype.toString=function(e){var t,n,r,o;if(!Number.isFinite(e))throw new Error("Cannot format non-finite number: ".concat(e));var i,a=this._o,s=this._clampInt(null!==(t=a.maxDecimalsCap)&&void 0!==t?t:15,0,20),u=null===(n=a.trimTrailingZeros)||void 0===n||n,c=null===(r=a.snapNearZero)||void 0===r||r,l=null!==(o=a.zeroThreshold)&&void 0!==o?o:a.eps,h=1/a.eps,p=Math.round(e*h)/h;if(Object.is(p,-0)&&(p=0),c&&Math.abs(p)<=l&&(p=0),i=void 0!==a.fixedDecimals?this._clampInt(a.fixedDecimals,0,s):this._clampInt(Math.ceil(-Math.log10(a.eps)),0,s),a.allowScientific,0===i)return String(Math.trunc(p));var f=p.toFixed(i);if(u&&void 0===a.fixedDecimals&&(f=f.replace(/(\.\d*?[1-9])0+$/,"$1").replace(/\.0+$/,"").replace(/\.$/,"")),/[eE]/.test(f))throw new Error("Scientific notation not allowed in XML output: ".concat(f));return f},e.prototype._clampInt=function(e,t,n){return Number.isFinite(e)?(e=Math.trunc(e),Math.max(t,Math.min(n,e))):t},e}();function sn(e){return e instanceof Date}function un(e){return"string"==typeof e}function cn(e){return"string"==typeof e||"number"==typeof e||"boolean"==typeof e||"bigint"==typeof e||sn(e)}function ln(e){return"number"==typeof e||"boolean"==typeof e||"bigint"==typeof e||sn(e)}var hn,pn=function(){function e(e,t){this._ns=new Map,this._prefixCount=0,this._builder=e,this._format=on(t),this._nFmt=new an(this._format)}return e.prototype.withNamespace=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];for(var n=0,r=e;n<r.length;n++){var o=r[n];this._assignNamespace(o)}return this},e.prototype.serialize=function(e,t){if(!(t=null!=t?t:Yt(e)))throw new Error("can not find name for given object");var n=$t(t);n.ns&&this._assignNamespace(n.ns,"xmlns"),this._gatherNamespaces(e,new WeakSet);for(var r=this._builder.ele(null,n.name),o=0,i=Array.from(this._ns.entries());o<i.length;o++){var a=i[o],s=a[0],u=a[1];r.att("xmlns",u,s)}this._writeObjectContent(r,e,(new WeakSet).add(e)),this._builder.end()},e.prototype._writeObject=function(e,t,n){if(!n.has(t))if(n.add(t),Array.isArray(t))for(var r=0,o=t;r<o.length;r++){var i=o[r];ln(i)||(un(i)?this._builder.text(i):this._writeObject(e,i,n))}else{var a=Yt(t);if(a){var s=$t(a),u=this._getPrefix(s),c=en(s.name,u);e.ele(null,c),this._writeObjectContent(e,t,n),this._builder.end()}}},e.prototype._getPrefix=function(e){if(e.ns){var t=this._ns.get(e.ns.toLowerCase());if("xmlns"!==t)return t}},e.prototype._writeObjectContent=function(e,t,n){for(var r,o,i,a=null!==(r=Zt(t))&&void 0!==r?r:[],s=new Map,u=0,c=a;u<c.length;u++){var l=c[u],h=null!==(o=s.get(l.prop))&&void 0!==o?o:[];h.push(l),s.set(l.prop,h)}for(var p=Object.keys(t).sort((function(e,t){var n,r,o=(null!==(n=s.get(e))&&void 0!==n?n:[]).some((function(e){return"attr"===e.kind})),i=(null!==(r=s.get(t))&&void 0!==r?r:[]).some((function(e){return"attr"===e.kind}));return o===i?0:o?-1:1})),f=0,d=p;f<d.length;f++){var m=d[f],g=t[m];if(null!=g){var x=s.get(m);if(x){var _=x.some((function(e){return!0===e.ignore||"none"===e.kind}));if(_)continue;for(var v=0,T=x;v<T.length;v++){var y=null!==(i=(l=T[v]).name)&&void 0!==i?i:l.prop.toLowerCase();if(y&&"attr"===l.kind){var b=null;if("number"==typeof g&&this._nFmt&&(b=this._nFmt.toString(g)),l.formatter&&(b=new l.formatter(this._format).toString(g)),b=null!=b?b:g.toString()){var M=$t(y),w=this._getPrefix(M),A=en(M.name,w);e.att(null,A,b)}}}}else ln(g)||(un(g)?this._builder.text(g):this._writeObject(e,g,n))}}},e.prototype._gatherNamespaces=function(e,t){var n,r;if(!t.has(e))if(t.add(e),Array.isArray(e))for(var o=0,i=e;o<i.length;o++){var a=i[o];cn(a)||this._gatherNamespaces(a,t)}else{var s=Yt(e);s&&this._assignNamespace(s);for(var u=null!==(n=Zt(e))&&void 0!==n?n:[],c=new Map,l=0,h=u;l<h.length;l++){var p=h[l],f=null!==(r=c.get(p.prop))&&void 0!==r?r:[];f.push(p),c.set(p.prop,f)}for(var d=[],m=0,g=Object.keys(e);m<g.length;m++){var x=g[m],_=e[x];if(null!=_){var v=c.get(x);if(v){var T=v.some((function(e){return!0===e.ignore||"none"===e.kind}));if(T)continue;for(var y=0,b=v;y<b.length;y++)(p=b[y]).name&&this._assignNamespace(p.name)}d.push(_)}}for(var M=0,w=d;M<w.length;M++){var A=w[M];cn(A)||this._gatherNamespaces(A,t)}}},e.prototype._assignNamespace=function(e,t){var n=$t(e);if(null==n?void 0:n.ns){var r=n.ns.toLowerCase();this._ns.get(r)||this._ns.set(r,null!=t?t:this._buildNsPrefix(r))}else"xmlns"===t&&(r=n.name.toLowerCase(),this._ns.get(r)||this._ns.set(r,null!=t?t:this._buildNsPrefix(r)))},e.prototype._buildNsPrefix=function(e){var t,n=!1;do{t="ns".concat(this._prefixCount++);for(var r=0,o=Array.from(this._ns.values());r<o.length;r++)if(o[r]===t){n=!0;break}}while(n);return t},e}(),fn=function(){function e(){}return e.OpenTag="<",e.CloseTag=">",e.Slash="/",e.Question="?",e.Quote='"',e.Equal="=",e.Space=" ",e.Semicolon=":",e.Dec="<?xml",e.Xml="xml",e.Xmlns="xmlns",e.Xsi="xsi",e.VersionKeyword="version",e.EncodingKeyword="encoding",e.StandaloneKeyword="standalone",e}();!function(e){e[e.Declaration=0]="Declaration",e[e.Tag=1]="Tag",e[e.Attribute=2]="Attribute",e[e.Text=3]="Text"}(hn||(hn={}));var dn,mn,gn=function(){function e(e){this._ctxStack=[],this._d=0,this._w=e}return e.prototype.dec=function(e,t,n){return this._w.write(fn.Dec),this._writeAttStr(fn.VersionKeyword,e),t&&this._writeAttStr(fn.EncodingKeyword,t),void 0!==n&&this._writeAttStr(fn.StandaloneKeyword,n?"yes":"no"),this._w.write(fn.Question,fn.CloseTag),this},e.prototype.att=function(e,t,n){var r=this._peekContext();if(!r)throw new Error("att() without open element");if(r.closed)throw new Error("att() after start tag closed for <".concat(r.name,">"));if(this._isXmlnsDecl(e,t)){if(t===fn.Xmlns)r.defaultNs=n,this._registerNamespace(r,"",n),this._writeAttStr(fn.Xmlns,n);else if(e)this._registerNamespace(r,t,n),this._writeAttStr("".concat(e,":").concat(t),n);else{var o=t.slice(6);this._registerNamespace(r,o,n),this._writeAttStr(t,n)}return r.lastToken=hn.Attribute,this}var i=t;if(e){var a=this._ensurePrefixDeclared(r,e);i="".concat(a,":").concat(t)}return r.lastToken=hn.Attribute,this._writeAttStr(i,n),this},e.prototype.ele=function(e,t){var n,r=this._peekContext();r&&this._closeOpenTagIfNeeded(r);var o=t;if(e){var i=null!==(n=this._lookupPrefix(e))&&void 0!==n?n:e;o="".concat(i,":").concat(t)}return r=this._pushContext(o,++this._d),this._w.write(fn.OpenTag,o),this},e.prototype.text=function(e){var t=this._peekContext();if(!t)throw new Error("text() without open element");return this._closeOpenTagIfNeeded(t),t.lastToken=hn.Text,this._w.write(this._escText(e)),this},e.prototype.end=function(){var e=this._popContext();return e&&(this._d--,e.closed?this._w.write(fn.OpenTag,fn.Slash,e.name,fn.CloseTag):this._w.write(fn.Slash,fn.CloseTag)),this},e.prototype._pushContext=function(t,n){var r=new e.Context(t,n);return this._ctxStack.push(r),r},e.prototype._popContext=function(){return this._ctxStack.pop()},e.prototype._peekContext=function(){return this._ctxStack[this._ctxStack.length-1]},Object.defineProperty(e.prototype,"_contextDepth",{get:function(){return this._ctxStack.length},enumerable:!1,configurable:!0}),e.prototype._writeAttStr=function(e,t){this._w.write(fn.Space,e,fn.Equal,fn.Quote,this._escAttr(t),fn.Quote)},e.prototype._lookupPrefix=function(e){var t,n=this._ctxStack.length-1;if(n>=0)do{var r=null===(t=this._ctxStack[n--].ns2prefix)||void 0===t?void 0:t.get(e);if(r)return r}while(n>=0)},e.prototype._escText=function(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},e.prototype._escAttr=function(e){return this._escText(e).replace(/"/g,"&quot;").replace(/'/g,"&apos;")},e.prototype._isXmlnsDecl=function(e,t){if(e)return e===fn.Xmlns;var n=t.length,r=fn.Xmlns.length;return n>=r&&t.startsWith(fn.Xmlns)&&(t.length==r||t[r]==fn.Semicolon)},e.prototype._registerNamespace=function(e,t,n){if(t===fn.Xml||t===fn.Xmlns)throw new Error("reserved prefix '".concat(t,"'"));var r=e.prefix2ns.get(t);if(r&&r!==n)throw new Error("prefix '".concat(t,"' already bound to a different namespace"));e.ns2prefix.get(n)||e.ns2prefix.set(n,t),e.prefix2ns.set(t,n)},e.prototype._allocPrefix=function(e){for(var t=1;;){var n="ns".concat(t++);if(!e.prefix2ns.has(n))return n}},e.prototype._ensurePrefixDeclared=function(e,t){var n=this._lookupPrefix(t);if(n)return n;if(e.closed)throw new Error("can not declare namespace after start tag closed for <".concat(e.name,">"));var r=this._allocPrefix(e);return this._writeAttStr("".concat(fn.Xmlns,":").concat(r),t),this._registerNamespace(e,r,t),r},e.prototype._closeOpenTagIfNeeded=function(e){e.closed||(this._w.write(fn.CloseTag),e.closed=!0)},e.Context=function(e,t){this.name="",this.closed=!1,this.lastToken=null,this.ns2prefix=new Map,this.prefix2ns=new Map,this.defaultNs=null,this.name=e,this.depth=t},e}(),xn=function(){function e(){this.count=0,this._chunks=[]}return e.prototype.write=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(0===e.length)return this;var n=e.join("");return this._chunks.push(n),this.count+=n.length,this},e.prototype.toString=function(){return this._chunks.join("")},e.prototype.clear=function(){this._chunks=[],this.count=0},e}(),_n=function(){function e(e,t){void 0===t&&(t={}),this._sink=e,this._opts=t,this.count=0,this._encoder=new TextEncoder,this._pending="",this._pendingChars=0}return e.prototype.write=function(){for(var e,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];if(0===t.length)return this;var r=t.join("");if(0===r.length)return this;this._pending+=r,this._pendingChars+=r.length;var o=null!==(e=this._opts.flushChars)&&void 0!==e?e:65536;return this._pendingChars>=o&&this.flush(),this},e.prototype.flush=function(){if(0===this._pendingChars)return this;var e=this._encoder.encode(this._pending);return this._sink.push(e),this.count+=e.length,this._pending="",this._pendingChars=0,this},e.prototype.finish=function(){this.flush(),this._sink.push(new Uint8Array(0),!0)},e.prototype.clear=function(){this._pending="",this._pendingChars=0,this.count=0},e}(),vn="http://schemas.microsoft.com/3dmanufacturing/core/2015/02",Tn="http://schemas.microsoft.com/3dmanufacturing/trianglesets/2021/07";!function(e){e.micron="micron",e.millimeter="millimeter",e.centimeter="centimeter",e.inch="inch",e.foot="foot",e.meter="meter"}(dn||(dn={})),function(e){e.model="model",e.solidsupport="solidsupport",e.support="support",e.surface="surface",e.other="other"}(mn||(mn={}));var yn,bn="http://schemas.openxmlformats.org/package/2006/content-types",Mn="http://schemas.openxmlformats.org/package/2006/relationships";!function(e){e.Relationships="application/vnd.openxmlformats-package.relationships+xml",e.Model="application/vnd.ms-package.3dmanufacturing-3dmodel+xml",e.Materials="application/vnd.ms-package.3dmanufacturing-material+xml",e.Colors="application/vnd.ms-package.3dmanufacturing-colors+xml",e.Texture="application/vnd.ms-package.3dmanufacturing-texture+xml",e.Texture2D="application/vnd.ms-package.3dmanufacturing-texture2d+xml",e.Production="application/vnd.ms-package.3dmanufacturing-production+xml",e.Slice="application/vnd.ms-package.3dmanufacturing-slice+xml",e.BeamLattice="application/vnd.ms-package.3dmanufacturing-beamlattice+xml",e.SecureContent="application/vnd.ms-package.3dmanufacturing-securecontent+xml",e.Png="image/png",e.Jpeg="image/jpeg",e.Tiff="image/tiff",e.Xml="application/xml"}(yn||(yn={}));var wn="_rels/",An="3D/",Rn="3dmodel.model",Cn=".rels",En="[Content_Types].xml",In=function(){function e(){}return e.IsKnown=function(t){return e.Known.has(t)},e.IsThreeDimModel=function(t){return t===e.ThreeDimModel},e.ThreeDimModel="http://schemas.microsoft.com/3dmanufacturing/2013/01/3dmodel",e.Thumbnail="http://schemas.openxmlformats.org/package/2006/relationships/metadata/thumbnail",e.PrintTicket="http://schemas.microsoft.com/3dmanufacturing/2013/01/printticket",e.MustPreserve="http://schemas.openxmlformats.org/package/2006/relationships/mustpreserve",e.Known=new Set([e.ThreeDimModel,e.Thumbnail,e.PrintTicket,e.MustPreserve]),e}(),Sn=function(){function e(){this.items=[]}return M([jt({ns:bn,name:"Types"})],e)}(),Vn=function(){function e(e,t){this.ext=e,this.ct=t}return M([Xt({name:{ns:bn,name:"Extension"}})],e.prototype,"ext",void 0),M([Xt({name:{ns:bn,name:"ContentType"}})],e.prototype,"ct",void 0),M([jt({ns:bn,name:"Default"})],e)}(),Fn=function(){function e(){this.items=[]}return M([jt({ns:Mn,name:"Relationships"})],e)}(),Bn=function(){function e(e,t,n){this.id=e,this.type=t,this.target=n}return M([Xt({name:"Id"})],e.prototype,"id",void 0),M([Xt({name:"Type"})],e.prototype,"type",void 0),M([Xt({name:"Target"})],e.prototype,"target",void 0),M([jt({ns:Mn,name:"Relationship"})],e)}(),On=function(e,t,n){this.contentTypes=e,this.relationships=t,this.model=n},Nn=function(){function e(e){this.values=e}return e.Zero=function(){return new e([0,0,0,0,0,0,0,0,0,0,0,0])},e.prototype.toString=function(){return this.values.join(" ")},e}(),Pn=function(){function e(e){this.o=e,this._f=new an(e)}return e.prototype.toString=function(e){var t=this;return e.values.map((function(e){return t._f.toString(e)})).join(" ")},e}(),Un=function(){function e(){this.unit=dn.millimeter}return e.KnownMeta=["Title","Designer","Description","Copyright","LicenseTerms","Rating","CreationDate","ModificationDate","Application"],M([Xt({name:"unit"})],e.prototype,"unit",void 0),M([Xt({name:"requiredextensions"})],e.prototype,"requiredextensions",void 0),M([Xt({name:"recommendedextensions"})],e.prototype,"recommendedextensions",void 0),M([jt({ns:vn,name:"model"})],e)}(),kn=function(){function e(e,t,n,r){this.name=e,this.value=t,this.preserve=n,this.type=r}return M([Xt({name:"name"})],e.prototype,"name",void 0),M([Xt({name:"preserve"})],e.prototype,"preserve",void 0),M([Xt({name:"type"})],e.prototype,"type",void 0),M([jt({ns:vn,name:"meta"})],e)}(),Dn=function(){function e(){this.metadata=[]}return M([jt({ns:vn,name:"metadatagroup"})],e)}(),Ln=function(){function e(){this.object=[]}return M([jt({ns:vn,name:"resources"})],e)}(),zn=function(){function e(e,t){void 0===t&&(t=mn.model),this.id=e,this.type=t}return M([Xt({name:"id"})],e.prototype,"id",void 0),M([Xt({name:"type"})],e.prototype,"type",void 0),M([Xt({name:"thumbnail"})],e.prototype,"thumbnail",void 0),M([Xt({name:"partnumber"})],e.prototype,"partnumber",void 0),M([Xt({name:"name"})],e.prototype,"name",void 0),M([Xt({name:"pid"})],e.prototype,"pid",void 0),M([Xt({name:"pindex"})],e.prototype,"pindex",void 0),M([jt({ns:vn,name:"object"})],e)}(),Kn=function(){function e(e,t){this.vertices=null!=e?e:new Wn,this.triangles=null!=t?t:new Gn}return M([jt({ns:vn,name:"mesh"})],e)}(),Wn=function(){function e(){this.vertex=[]}return M([jt({ns:vn,name:"vertices"})],e)}(),qn=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),this.x=e,this.y=t,this.z=n}return M([Xt({name:"x"})],e.prototype,"x",void 0),M([Xt({name:"y"})],e.prototype,"y",void 0),M([Xt({name:"z"})],e.prototype,"z",void 0),M([jt({ns:vn,name:"vertex"})],e)}(),Gn=function(){function e(){this.triangle=[]}return M([jt({ns:vn,name:"triangles"})],e)}(),jn=function(){function e(e,t,n){this.v1=e,this.v2=t,this.v3=n}return M([Xt({name:"v1"})],e.prototype,"v1",void 0),M([Xt({name:"v2"})],e.prototype,"v2",void 0),M([Xt({name:"v3"})],e.prototype,"v3",void 0),M([Xt({name:"p1"})],e.prototype,"p1",void 0),M([Xt({name:"p2"})],e.prototype,"p2",void 0),M([Xt({name:"p3"})],e.prototype,"p3",void 0),M([Xt({name:"pid"})],e.prototype,"pid",void 0),M([jt({ns:vn,name:"triangle"})],e)}(),Hn=function(){function e(){this.component=[]}return M([jt({ns:vn,name:"components"})],e)}(),Xn=function(){function e(e,t){this.objectid=e,this.transform=t}return M([Xt({name:"objectid"})],e.prototype,"objectid",void 0),M([Xt({name:"transform",formatter:Pn})],e.prototype,"transform",void 0),M([jt({ns:vn,name:"component"})],e)}(),Qn=function(){function e(e){this.base=[],this.id=e}return M([Xt({name:"id"})],e.prototype,"id",void 0),M([jt({ns:vn,name:"basematerials"})],e)}(),Zn=function(){function e(e,t){this.name=e,this.displaycolor=t}return M([Xt({name:"name"})],e.prototype,"name",void 0),M([Xt({name:"displaycolor"})],e.prototype,"displaycolor",void 0),M([jt({ns:vn,name:"base"})],e)}(),Yn=function(){function e(){this.item=[]}return M([jt({ns:vn,name:"build"})],e)}(),Jn=function(){function e(e,t,n){this.objectid=e,this.transform=t,this.partnumber=n}return M([Xt({name:"objectid"})],e.prototype,"objectid",void 0),M([Xt({name:"transform",formatter:Pn})],e.prototype,"transform",void 0),M([Xt({name:"partnumber"})],e.prototype,"partnumber",void 0),M([jt({ns:vn,name:"item"})],e)}(),$n=function(){function e(e,t){this._object=new zn(e,t)}return e.prototype.withName=function(e){return this._object.name=e,this},e.prototype.withThumbnail=function(e){return this._object.thumbnail=e,this},e.prototype.withProperty=function(e,t){return void 0===t&&(t=0),this._object.pid=e,this._object.id=t,this},e.prototype.build=function(){return this._object},e.prototype.reset=function(e,t){this._object=new zn(e,t)},e}(),er=function(e){function t(t,n){void 0===n&&(n=mn.model);var r=e.call(this,t,n)||this;return r._object.content=new Hn,r}return y(t,e),t.prototype.withComponent=function(e,t){return this._object.content.component.push(new Xn(e,t)),this},t}($n),tr=function(e){function t(t){return e.call(this,t,mn.model)||this}return y(t,e),t.prototype.withPostProcessHandlers=function(e,t){return this._vh=e,this._th=t,this},t.prototype.withData=function(e){return this._object.content=this._buildMesh(e),this},t.prototype.withMaterial=function(e,t){return this._object.pid=e,this._object.pindex=t,this},t.prototype._buildMesh=function(e){var t=this._buildVertices(e.positions),n=this._buildTriangle(e.indices);return new Kn(t,n)},t.prototype._buildVertices=function(e){var t=new Wn;if(e)for(var n=0;n<e.length;){var r=e[n++],o=e[n++],i=e[n++],a=new qn(r,o,i);this._vh&&(a=this._vh(a)),t.vertex.push(a)}return t},t.prototype._buildTriangle=function(e){var t=new Gn;if(e)for(var n=0;n<e.length;){var r=e[n++],o=e[n++],i=e[n++],a=new jn(r,o,i);this._th&&(a=this._th(a)),t.triangle.push(a)}return t},t}($n),nr=function(){function e(e){this._m=new Qn(e)}return e.prototype.withColor=function(e,t){var n;this._m.base=null!==(n=this._m.base)&&void 0!==n?n:[];var r=this._m.base.find((function(t){return t.name.toLowerCase()===e.toLowerCase()}));return r?(r.displaycolor=this._rgbaToHex(t),this):(r=new Zn(e,this._rgbaToHex(t)),this._m.base.push(r),this)},e.prototype.build=function(){return this._m},e.prototype._rgbaToHex=function(e){var t=function(e){return Math.round(Math.min(255,Math.max(0,255*Math.pow(e,1/2.2))))},n=t(e.r).toString(16).padStart(2,"0").toUpperCase(),r=t(e.g).toString(16).padStart(2,"0").toUpperCase(),o=t(e.b).toString(16).padStart(2,"0").toUpperCase();if("number"==typeof e.a){var i=Math.round(Math.min(255,Math.max(0,255*e.a))).toString(16).padStart(2,"0").toUpperCase();return"#".concat(n).concat(r).concat(o).concat(i)}return"#".concat(n).concat(r).concat(o)},e}(),rr=function(){function e(){this._model=new Un,this._objects=new Map}return e.prototype.withMetaData=function(e,t,n,r){return this._model.metadata||(this._model.metadata=new Array),this._model.metadata.push(new kn(e,t,n,r)),this},e.prototype.withMaterial=function(e){var t,n;return e instanceof nr&&(e=e.build()),e&&(this._model.resources=null!==(t=this._model.resources)&&void 0!==t?t:new Ln,this._model.resources.basematerials=null!==(n=this._model.resources.basematerials)&&void 0!==n?n:[],this._model.resources.basematerials.push(e)),this},e.prototype.withMesh=function(e){var t;return e instanceof tr&&(e=e.build()),this._model.resources=null!==(t=this._model.resources)&&void 0!==t?t:new Ln,this._model.resources.object.push(e),this},e.prototype.withComponents=function(e){var t;return e instanceof er&&(e=e.build()),this._model.resources=null!==(t=this._model.resources)&&void 0!==t?t:new Ln,this._model.resources.object.push(e),this},e.prototype.withBuild=function(e,t,n){var r,o;return this._model.build=null!==(r=this._model.build)&&void 0!==r?r:new Yn,null===(o=this._model.build.item)||void 0===o||o.push(new Jn(e,t,n)),this},e.prototype.withUnit=function(e){return this._model.unit=e,this},e.prototype.reset=function(){return this._model=new Un,this._objects=new Map,this},e.prototype.build=function(){var e,t,n,r;if(!(null===(t=null===(e=this._model.resources)||void 0===e?void 0:e.object)||void 0===t?void 0:t.length))throw new Error("Invalid state: resources MUST be defined ");if(!(null===(r=null===(n=this._model.build)||void 0===n?void 0:n.item)||void 0===r?void 0:r.length))throw new Error("Invalid state: Build MUST be defined ");return this._model},e.KnownMetaSet=new Set(Un.KnownMeta.map((function(e){return e.toLowerCase()}))),e}(),or=function(){function e(){}return e.prototype.withContentType=function(e){this._cts||(this._cts=new Sn);var t=this._cts.items;return t.some((function(t){return t.ext===e.ext&&t.ct===e.ct}))||t.push(e),this},e.prototype.withRelationship=function(e){this._rs||(this._rs=new Fn);var t=this._rs.items;return t.some((function(t){return t.id===e.id}))||t.push(e),this.withContentType(new Vn("rels",yn.Relationships)),this},e.prototype.withModel=function(e){return e instanceof rr&&(e=e.build()),this._m=e,this.withContentType(new Vn("model",yn.Model)),this},e.prototype.build=function(){if(!this._m)throw new Error("Invalid state: you Must provide at least a model.");var e="".concat(An).concat(Rn);if(!this._rs){var t="/".concat(e);this.withRelationship(new Bn("rel".concat(0),In.ThreeDimModel,t))}return new On(this._cts,this._rs,this._m)},e}(),ir=function(){function e(e){this._o=e}return Object.defineProperty(e.prototype,"options",{get:function(){return this._o},enumerable:!1,configurable:!0}),e.prototype.serializeAsync=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];return w(this,void 0,void 0,(function(){var n,r,o,i,a,s,u;return A(this,(function(c){switch(c.label){case 0:return[4,this.ensureZipLibReadyAsync()];case 1:if(!(n=c.sent()))return[2];if(r=n.Zip,o=n.ZipDeflate,!r||!o)throw new Error("fflate Zip / ZipDeflate not available");return i=function(e){return{push:function(t,n){return e.push(t,n)}}},a=function(e,t,n){var r=new o(t,{level:6});e.add(r);var a=i(r),s=new _n(a),u=new gn(s).dec("1.0","UTF-8");new pn(u).serialize(n),s.finish()},(s=this.toDocument.apply(this,t))?(u=new r(e),a(u,En,s.contentTypes),a(u,"".concat(wn).concat(Cn),s.relationships),a(u,"".concat(An).concat(Rn),s.model),u.end(),[2]):[2]}}))}))},e.prototype.toDocument=function(){for(var e,t,n=[],r=0;r<arguments.length;r++)n[r]=arguments[r];var o=(new rr).withUnit(null!==(t=null===(e=this._o)||void 0===e?void 0:e.unit)&&void 0!==t?t:dn.millimeter);if(this.options.metadata)for(var i in this.options.metadata)o.withMetaData(i,this.options.metadata[i]);return(new or).withModel(this.toModel.apply(this,R([o],n,!1))).build()},e}(),ar=function(){function e(){}return e.SerializeToMemoryAsync=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];return w(this,void 0,void 0,(function(){var n,r,o,i,a,s,u,c;return A(this,(function(l){switch(l.label){case 0:return n=new Array,r=0,o=function(e,t,o){n.push(t),r+=t.length},[4,e.serializeAsync.apply(e,R([o],t,!1))];case 1:if(l.sent(),!r)return[2,void 0];for(i=new Uint8Array(r),a=0,s=0,u=n;s<u.length;s++)c=u[s],i.set(c,a),a+=c.length;return[2,i]}}))}))},e}(),sr=function(){function e(){}return e.FFLATEUrl="https://unpkg.com/fflate@0.8.2",e}(),ur=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=Number.MIN_SAFE_INTEGER),void 0===n&&(n=1),this._from=e,this._to=t,this._step=n,this._i=e}return e.prototype.next=function(){if(this._i<this._to)throw new Error("ST_ResourceID out of bound");var e=this._i;return this._i+=this._step,e},e.prototype.reset=function(){return this._i=this._from,this},e}(),cr=function(e){function t(n){return void 0===n&&(n={}),e.call(this,b(b({},t.DefaultOptions),n))||this}return y(t,e),t.prototype.toModel=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];t=t.filter((function(e){return e instanceof g.Mesh||e instanceof g.InstancedMesh}));for(var r=new ur,o=e,i=new Map,a=this.options.exportInstances?[]:null,s=0;s<t.length;s++){var u=t[s];if(u instanceof g.InstancedMesh)null==a||a.push(u);else{var c=u.name||"mesh".concat(s),l=u.getWorldMatrix(),h=this._handleBjsTo3mfMatrixTransformToRef(l,Nn.Zero());if(void 0!==(A=u.subMeshes))for(var p=1==A.length,f=0;f<A.length;f++){var d=A[f],m=this._extractSubMesh(u,d);if(m){var x=p?"".concat(c):"".concat(c,"_").concat(f),_=new tr(r.next()).withData(m).withName(x).build();o.withMesh(_),o.withBuild(_.id,h),i.set(d,_)}}}}if(a&&a.length)for(var v=this._groupBy(a,(function(e){return e.sourceMesh})),T=0,y=Array.from(v.entries());T<y.length;T++){var b=y[T],M=b[0],w=b[1];if(w&&w.length)for(s=0;s<w.length;s++){l=w[s].getWorldMatrix();var A=M.subMeshes;for(f=0;f<A.length;f++){d=A[f];var R=i.get(d);R&&o.withBuild(R.id,this._handleBjsTo3mfMatrixTransformToRef(l,Nn.Zero()))}}}return o.build()},t.prototype.ensureZipLibReadyAsync=function(){return w(this,void 0,void 0,(function(){var e=this;return A(this,(function(t){switch(t.label){case 0:return this._fflateReadyPromise?[4,this._fflateReadyPromise]:[3,2];case 1:case 3:return[2,t.sent()];case 2:return this._fflateReadyPromise=w(e,void 0,void 0,(function(){var e;return A(this,(function(t){switch(t.label){case 0:return(e=globalThis).fflate?[3,2]:[4,g.Tools.LoadScriptAsync(sr.FFLATEUrl)];case 1:t.sent(),t.label=2;case 2:return[2,e.fflate]}}))})),[4,this._fflateReadyPromise]}}))}))},t.prototype._extractSubMesh=function(e,n){var r=e.getIndices();if(r){var o=e.getVerticesData(t._PositionKind);if(o){if(0==n.indexStart&&n.indexCount==r.length)return{positions:o,indices:r};for(var i=n.indexStart,a=new Map,s=[],u=new Uint32Array(n.indexCount),c=0;c<n.indexCount;c++){var l=r[i+c],h=a.get(l);if(void 0===h){h=a.size,a.set(l,h);var p=3*l;s.push(o[p],o[p+1],o[p+2])}u[c]=h}return{positions:new Float32Array(s),indices:u}}}},t.prototype._groupBy=function(e,t){for(var n=new Map,r=0,o=e;r<o.length;r++){var i=o[r],a=t(i),s=n.get(a);s?s.push(i):n.set(a,[i])}return n},t.prototype._handleBjsTo3mfMatrixTransformToRef=function(e,n){var r=e.multiplyToRef(t._R_BJS_TO_3MF,g.Matrix.Zero()).m;return n.values=[r[0],r[1],r[2],r[4],r[5],r[6],r[8],r[9],r[10],r[12],r[13],r[14]],n},t.DefaultOptions={unit:dn.meter,exportInstances:!1},t._PositionKind="position",t._R_BJS_TO_3MF=g.Matrix.RotationX(Math.PI/2).multiply(g.Matrix.Scaling(1,-1,1)),t}(ir),lr=void 0!==r.g?r.g:"undefined"!=typeof window?window:void 0;if(void 0!==lr)for(var hr in f)lr.BABYLON[hr]=f[hr];var pr=void 0!==r.g?r.g:"undefined"!=typeof window?window:void 0;if(void 0!==pr){pr.BABYLON=pr.BABYLON||{};var fr=pr.BABYLON;fr.GLTF2=fr.GLTF2||{},fr.GLTF2.Exporter=fr.GLTF2.Exporter||{},fr.GLTF2.Exporter.Extensions=fr.GLTF2.Exporter.Extensions||{};var dr=[];for(var mr in a)fr[mr]=a[mr],dr.push(mr);for(var mr in s)fr[mr]=s[mr],dr.push(mr);for(var mr in u)fr[mr]=u[mr],dr.push(mr);for(var mr in c)fr.GLTF2.Exporter.Extensions[mr]=c[mr],dr.push(mr);for(var mr in l)dr.indexOf(mr)>-1||(fr.GLTF2.Exporter[mr]=l[mr])}var gr=void 0!==r.g?r.g:"undefined"!=typeof window?window:void 0;if(void 0!==gr)for(var xr in i)gr.BABYLON[xr]=i[xr];var _r=void 0!==r.g?r.g:"undefined"!=typeof window?window:void 0;if(void 0!==_r)for(var vr in h)_r.BABYLON[vr]=h[vr];var Tr=void 0!==r.g?r.g:"undefined"!=typeof window?window:void 0;if(void 0!==Tr)for(var yr in p)Tr.BABYLON[yr]=p[yr];var br=void 0!==r.g?r.g:"undefined"!=typeof window?window:void 0;if(void 0!==br){var Mr=[];for(var wr in d)Mr.indexOf(wr)>-1||(br.BABYLON[wr]=d[wr],Mr.push(wr))}const Ar=m;return o.default})()));
//# sourceMappingURL=babylonjs.serializers.min.js.map